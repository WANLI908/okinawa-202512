<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2025 æ²–ç¹© ğŸŒº</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        body { font-family: 'M PLUS Rounded 1c', sans-serif; background-color: #FFF8E1; -webkit-tap-highlight-color: transparent; }
        
        /* UI Components */
        .shisa-header { background: linear-gradient(135deg, #FFAB91 0%, #FFCC80 100%); border-radius: 0 0 30px 30px; box-shadow: 0 4px 15px rgba(255, 167, 38, 0.3); }
        .card { background: white; border-radius: 20px; border: 2px solid #FFE0B2; transition: all 0.3s; overflow: hidden; position: relative; z-index: 10; }
        .card:active { transform: scale(0.98); }
        .card-active { border-color: #FF7043; box-shadow: 0 8px 20px rgba(255, 112, 67, 0.2); transform: scale(1.01); }
        
        /* Tags */
        .tag-eat { background: #FFECB3; color: #E65100; } .tag-spot { background: #B2EBF2; color: #006064; } .tag-trans { background: #E1BEE7; color: #4A148C; } .tag-hotel { background: #DCEDC8; color: #33691E; } .tag-prep { background: #F3E5F5; color: #7B1FA2; }
        
        /* Navigation & FAB */
        .bottom-nav { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-top: 1px solid #FFE0B2; }
        .nav-item.active { color: #FF7043; transform: translateY(-2px); }
        .nav-item { color: #90A4AE; transition: all 0.2s; }
        .fab-btn { position: fixed; bottom: 100px; right: 20px; width: 56px; height: 56px; background-color: #4CAF50; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 40; transition: transform 0.2s; }
        .fab-btn:active { transform: scale(0.9); }

        /* Scroll & Animation */
        .date-scroll, .weather-scroll { overflow-x: auto; white-space: nowrap; -ms-overflow-style: none; scrollbar-width: none; }
        .date-scroll::-webkit-scrollbar, .weather-scroll::-webkit-scrollbar { display: none; }
        .date-tab.active { background: #FF7043; color: white; border-color: #FF7043; }
        .snap-x-mandatory { scroll-snap-type: x mandatory; }
        .snap-center { scroll-snap-align: center; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .details-content { display: none; animation: slideDown 0.3s ease-out; }
        .details-content.show { display: block; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Modals */
        .modal-overlay, .detail-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 100; display: none; align-items: flex-end; justify-content: center; }
        .detail-modal-overlay { z-index: 200; background: rgba(0,0,0,0.7); backdrop-filter: blur(3px); }
        .modal-overlay.open, .detail-modal-overlay.open { display: flex; }
        .modal-sheet { background: white; width: 100%; border-radius: 20px 20px 0 0; padding: 20px; animation: slideUp 0.3s ease-out; max-height: 90vh; overflow-y: auto; padding-bottom: 40px; }
        .detail-sheet { background: #fff; width: 100%; height: 85vh; border-radius: 24px 24px 0 0; padding: 0; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); overflow: hidden; }
        .detail-modal-overlay.open .detail-sheet { transform: translateY(0); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        /* Elements */
        .detail-header-img { width: 100%; height: 250px; object-fit: cover; }
        .detail-body { padding: 24px; overflow-y: auto; flex: 1; /* è‡ªå‹•å¡«æ»¿å‰©é¤˜é«˜åº¦ *//* ç§»é™¤åŸæœ¬çš„ padding-bottom: 100px */ }
        .detail-handle { width: 40px; height: 5px; background: rgba(255,255,255,0.5); border-radius: 100px; position: absolute; top: 12px; left: 50%; transform: translateX(-50%); z-index: 10; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        .detail-close-btn { position: absolute; top: 16px; right: 16px; width: 32px; height: 32px; background: rgba(0,0,0,0.5); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 50; }
        .ticket-box { background-image: radial-gradient(circle at 0 50%, transparent 10px, #FFF5F5 11px), radial-gradient(circle at 100% 50%, transparent 10px, #FFF5F5 11px); border: 2px dashed #FFCDD2; color: #C62828; padding: 15px 25px; border-radius: 8px; position: relative; }
        .pdf-sheet { 
    /* ...åŸæœ‰æ¨£å¼... */
    padding: 0; /* å»ºè­°æ­¸é›¶ï¼Œç”±å…§éƒ¨å…ƒç´ æ§åˆ¶é–“è· */
    /* ... */
}
/* --- ä¿®æ”¹ï¼šè®“é è¦½è¦–çª—è®Šå¤§ --- */
.pdf-sheet { 
    background: #fff; 
    width: 100%;        /* å¯¬åº¦æ”¹ç‚º 100% */
    height: 92vh;       /* é«˜åº¦æ”¹ç‚º 92% (ç•™ä¸€é»é»åº•çµ¦æ‰‹æŒ‡æ“ä½œ) */
    border-radius: 16px 16px 0 0; 
    padding: 0;         /* â˜… é—œéµï¼šç§»é™¤å…§è·ï¼Œè®“å…§å®¹æ»¿ç‰ˆ */
    box-shadow: 0 -4px 20px rgba(0,0,0,0.2); 
    position: absolute; 
    bottom: 0;          /* å›ºå®šåœ¨åº•éƒ¨ */
    overflow: hidden;   /* é˜²æ­¢åœ“è§’è¢«å…§å®¹è“‹ä½ */
    display: flex;
    flex-direction: column;
}


.pdf-close-btn:active {
    transform: scale(0.9);
    background: rgba(0, 0, 0, 0.8);
}
        .pdf-label { font-size: 10px; color: #666; text-transform: uppercase; margin-bottom: 2px; }
        .voucher-card { border-left: 4px solid #FF7043; }
        .sync-status { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .sync-online { background-color: #4CAF50; box-shadow: 0 0 5px #4CAF50; }
        .sync-offline { background-color: #ccc; }
        .qty-btn { width: 40px; height: 40px; background: #f3f4f6; border-radius: 8px; font-weight: bold; color: #4b5563; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .qty-btn:active { background: #e5e7eb; }
        .shop-img-box { width: 90px; height: 90px; border-radius: 4px; overflow: hidden; background: #6b7280; /* æ·±ç°è‰²é è¨­èƒŒæ™¯ */display: flex; align-items: center; justify-content: center; flex-shrink: 0; border: 1px solid #e5e7eb; position: relative;/* æ–°å¢ï¼šæ»‘é¼ ç§»ä¸Šå»è®Šæˆæ”¾å¤§é¡ */cursor: zoom-in; transition: transform 0.1s; }
        /* é»æ“Šæ™‚çš„å°å‹•ç•« */
        .shop-img-box:active { transform: scale(0.95); }
        /* å¦‚æœæ²’æœ‰åœ–ç‰‡ (åªæœ‰ç°è‰²èƒŒæ™¯)ï¼ŒæŠŠæ»‘é¼ è®Šå›é è¨­ï¼Œé¿å…èª¤æœƒ */
        .shop-img-box.no-image { cursor: default;background: #6b7280; }
        .shop-img-box.no-image:active { transform: none; }
        .shop-img-box img { width: 100%; height: 100%; object-fit: cover; }
        /* ä¿æŒä¸Šæ¬¡è¨­å®šçš„è¼¸å…¥æ¡†å¯¬åº¦ */
        .jp-price-input-clean { border: 1px solid #d1d5db; border-radius: 6px; padding: 2px 4px; width: 70px; font-size: 15px; text-align: center; color: #374151; background: white; outline: none; transition: all 0.2s; }
        .jp-price-input-clean:focus { border-color: #f97316; box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.1); }
        .highlight-time { font-family: 'Courier New', monospace; font-weight: bold; color: #d97706; background: #fef3c7; padding: 2px 6px; border-radius: 4px; }
        .jp-price-input { width: 80px; padding: 4px; border: 1px solid #e5e7eb; border-radius: 4px; font-weight: bold; color: #ea580c; text-align: right; background: white; }
        /* æ–°å¢ï¼šç½®é ‚å®¹å™¨æ¨£å¼ */
.sticky-filters {
    position: sticky;
    top: 72px; /* é…åˆ Header é«˜åº¦ (ç´„ 70~80px)ï¼Œå›ºå®šåœ¨å®ƒä¸‹æ–¹ */
    z-index: 40;
    
    /* èƒŒæ™¯è‰²èˆ‡ body ä¸€è‡´ï¼ŒåŠ ä¸€é»é€æ˜åº¦èˆ‡æ¨¡ç³Š */
    background-color: rgba(255, 248, 225, 0.95); 
    backdrop-filter: blur(5px);
    
    /* ä¸Šä¸‹å„ç•™ 20pxï¼Œå·¦å³è£œå›å…§è· */
    padding: 20px 16px; 
    
    /* é—œéµï¼šä½¿ç”¨è² é‚Šç•ŒæŠµæ¶ˆåŸæœ¬ #app çš„ paddingï¼Œè®“èƒŒæ™¯æ»¿ç‰ˆ */
    margin-left: -16px; 
    margin-right: -16px;
    
    /* è¼•å¾®é™°å½±è®“å±¤æ¬¡åˆ†æ˜ */
    box-shadow: 0 4px 6px -4px rgba(0, 0, 0, 0.05);
}

/* ä¿®æ”¹ï¼šç§»é™¤åŸæœ¬çš„ marginï¼Œçµ±ä¸€ç”±å¤–å±¤ sticky-filters æ§åˆ¶é–“è· */
.filter-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0; /* æ”¹ç‚º 0 */
    gap: 8px;
}

/* ä¿æŒä¹‹å‰çš„æ¨£å¼ */
.filter-select {
    background: white;
    border: 1px solid #fed7aa;
    color: #4b5563;
    padding: 6px 10px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: bold;
    outline: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23f97316' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 8px center;
    background-size: 14px;
    padding-right: 28px;
    appearance: none;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

.rate-badge {
    font-size: 12px;
    color: #ea580c;
    background: #fff7ed;
    padding: 4px 8px;
    border-radius: 6px;
    border: 1px dashed #fdba74;
    font-weight: bold;
    white-space: nowrap;
}
/* --- è¨˜å¸³åŠŸèƒ½æ–°å¢æ¨£å¼ START --- */
.split-box {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 12px;
    margin-top: 8px;
}
.member-check {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 13px;
    background: white;
    padding: 6px 10px;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
    cursor: pointer;
}
.member-check.active {
    background: #eff6ff;
    border-color: #3b82f6;
    color: #1d4ed8;
    font-weight: bold;
}
.chart-container {
    position: relative; 
    height: 250px; 
    width: 100%;
    margin-bottom: 20px;
}
.person-card {
    background: white;
    border: 1px solid #fed7aa;
    border-radius: 12px;
    padding: 10px;
    text-align: center;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}
/* --- è¨˜å¸³åˆ†é æ¨£å¼ START --- */
.budget-tab-container {
    background: #e2e8f0;
    padding: 4px;
    border-radius: 12px;
    display: flex;
    margin-bottom: 16px;
}
.budget-tab-btn {
    flex: 1;
    text-align: center;
    padding: 8px;
    border-radius: 10px;
    font-size: 14px;
    font-weight: bold;
    color: #64748b;
    transition: all 0.2s;
}
.budget-tab-btn.active {
    background: white;
    color: #f97316; /* æ©˜è‰² */
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
/* --- è¨˜å¸³åˆ†é æ¨£å¼ END --- */
/* --- æ–°å¢ï¼šåº•éƒ¨å®‰å…¨å€åŸŸ (é¿é–‹ iPhone æ©«æ¢) --- */
.safe-area-bottom {
    padding-bottom: calc(12px + env(safe-area-inset-bottom));
}

/* è«‹ç¢ºä¿ .pdf-sheet æ˜¯é€™æ¨£è¨­å®šçš„ */
.pdf-sheet { 
    background: #fff; 
    width: 100%;
    height: 95vh; /* æ‹‰é«˜ä¸€é»ï¼Œä½”æ“šæ›´å¤šè¢å¹• */
    border-radius: 16px 16px 0 0; 
    padding: 0;
    position: absolute; 
    bottom: 0;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    /* ç¢ºä¿æ²’æœ‰å…¶ä»– padding å¹²æ“¾ */
}

/* åº•éƒ¨å®‰å…¨å€ (å¦‚æœä¹‹å‰æ²’åŠ ï¼Œè«‹åŠ ä¸Š) */
.safe-area-bottom {
    padding-bottom: calc(12px + env(safe-area-inset-bottom));
}
/* --- æ–°å¢ï¼šæ—¥æœŸé¸å–®ç½®é ‚æ¨£å¼ --- */
.sticky-date-bar {
    position: sticky;
    top: 72px; /* å›ºå®šåœ¨ Header (ç´„72px) ä¸‹æ–¹ */
    z-index: 40;
    
    /* èƒŒæ™¯è‰²èˆ‡ body ä¸€è‡´ï¼ŒåŠ ä¸€é»é€æ˜åº¦ */
    background-color: rgba(255, 248, 225, 0.95); 
    backdrop-filter: blur(5px);
    
    /* ä¸Šä¸‹èª¿æ•´ */
    padding-top: 10px;
    padding-bottom: 10px;
    margin-bottom: 16px;
    
    /* é—œéµï¼šä½¿ç”¨è² é‚Šç•ŒæŠµæ¶ˆ #app çš„ paddingï¼Œè®“æ²å‹•æ¢æ»¿ç‰ˆ */
    margin-left: -16px; 
    margin-right: -16px;
    
    /* è£œå›å…§è·ï¼Œè®“å…§å®¹ä¸æœƒè²¼é‚Š */
    padding-left: 16px;
    padding-right: 16px;
    
    /* åŠ ä¸€é»é™°å½±è®“å±¤æ¬¡åˆ†æ˜ */
    box-shadow: 0 4px 6px -4px rgba(0, 0, 0, 0.05);
}
    </style>
</head>
<body class="pb-28">

    <!-- Header -->
    <div class="shisa-header sticky top-0 z-50 p-4 flex justify-between items-center text-white">
        <div>
            <h1 class="text-xl font-bold flex items-center gap-2">
                2025æ²–ç¹© <span id="sync-indicator" class="sync-status sync-offline" title="é€£ç·šç‹€æ…‹"></span>
                <span id="current-role-badge" onclick="clearRole()" class="text-xs bg-white/20 px-2 py-1 rounded cursor-pointer hover:bg-white/40">åˆ‡æ›</span>
            </h1>
            <p id="header-desc" class="text-xs opacity-90 mt-1">12/25 - 12/29</p>
        </div>
        <div class="bg-white/20 backdrop-blur-sm rounded-full w-10 h-10 flex items-center justify-center text-2xl cursor-pointer shadow-sm border border-white/30" onclick="toggleDevMode()" id="header-icon">ğŸ¦</div>
    </div>

    <!-- Role Selector -->
    <div id="role-selector" class="fixed inset-0 bg-[#FFF8E1] z-[60] flex flex-col items-center justify-center p-6 space-y-8 hidden">
        <div class="text-center"><h2 class="text-3xl font-bold text-orange-600 mb-2">ä½ æ˜¯èª°ï¼Ÿ</h2><p class="text-gray-500">é¸æ“‡èº«ä»½ä»¥æä¾›æœ€é©åˆä½ çš„è³‡è¨Š</p></div>
        <div class="grid grid-cols-2 gap-4 w-full max-w-sm">
            <button onclick="selectRole('driver')" class="bg-white p-4 rounded-2xl shadow-lg border-2 border-orange-100 flex flex-col items-center gap-2 hover:bg-orange-50"><div class="text-4xl">ğŸš—</div><div class="font-bold text-gray-700">å¦¹å¦¹ </div></button>
            <button onclick="selectRole('copilot')" class="bg-white p-4 rounded-2xl shadow-lg border-2 border-orange-100 flex flex-col items-center gap-2 hover:bg-orange-50"><div class="text-4xl">ğŸ—ºï¸</div><div class="font-bold text-gray-700">çˆ¸çˆ¸ </div></button>
            <button onclick="selectRole('tourist')" class="bg-white p-4 rounded-2xl shadow-lg border-2 border-orange-100 flex flex-col items-center gap-2 hover:bg-orange-50"><div class="text-4xl">ğŸ“¸</div><div class="font-bold text-gray-700">åª½åª½ </div></button>
            <button onclick="selectRole('admin')" class="bg-white p-4 rounded-2xl shadow-lg border-2 border-orange-100 flex flex-col items-center gap-2 hover:bg-orange-50"><div class="text-4xl">ğŸ“</div><div class="font-bold text-gray-700">å§Šå§Š </div></button>
        </div>
    </div>

    <!-- Main Content -->
    <div id="app" class="p-4 space-y-6"></div>

    <!-- Modals -->
    <div id="modal-detail" class="detail-modal-overlay" onclick="closeDetailModal()"><div id="modal-detail-content" class="detail-sheet" onclick="event.stopPropagation()"></div></div>
    <div id="modal-pdf" class="modal-overlay" style="z-index: 1000;" onclick="closePdfModal()"><div class="pdf-sheet" onclick="event.stopPropagation()"><button onclick="closePdfModal()" class="absolute top-4 right-4 text-2xl text-gray-400 hover:text-black"><i class="fa-solid fa-xmark"></i></button><div id="pdf-content"></div></div></div>

    <!-- Shopping Modal -->
    <div id="modal-shopping" class="modal-overlay" onclick="closeModal('modal-shopping')">
        <div class="modal-sheet space-y-4" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-700" id="shop-modal-title">æ–°å¢å¿…è²· & æ¯”åƒ¹</h3>
                <button onclick="closeModal('modal-shopping')" class="text-gray-400"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <input type="hidden" id="in-shop-key">
            <input id="in-shop-img" placeholder="åœ–ç‰‡é€£çµ URL æˆ– æª”å (é¸å¡«)" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 text-sm">
            <div class="grid grid-cols-3 gap-2">
                <select id="in-shop-cat" class="p-3 bg-white rounded-xl border border-orange-200 font-bold text-gray-700"><option value="è—¥å¦">ğŸ’Š è—¥å¦</option><option value="é›¶é£Ÿ">ğŸª é›¶é£Ÿ</option><option value="é›»å™¨">ğŸ”Œ é›»å™¨</option><option value="è¡£ç‰©">ğŸ‘• è¡£ç‰©</option><option value="é›œè²¨">ğŸ é›œè²¨</option></select>
                <input id="in-shop-store" placeholder="å•†åº— (å¦‚: å¤§åœ‹)" class="col-span-2 p-3 bg-gray-50 rounded-xl border border-gray-200">
            </div>
            <input id="in-shop-item" placeholder="å“å (å¦‚: åˆåˆ©ä»–å‘½)" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
            <div class="grid grid-cols-2 gap-3 bg-blue-50 p-3 rounded-xl border border-blue-100">
                <div><label class="text-xs text-gray-500 font-bold">ğŸ‡¹ğŸ‡¼ å°ç£å”®åƒ¹</label><input id="in-shop-tw" type="number" placeholder="NT$" class="w-full p-2 bg-white rounded border border-blue-200 mt-1"></div>
                <div><label class="text-xs text-gray-500 font-bold">ğŸ‡¯ğŸ‡µ æ—¥æœ¬å”®åƒ¹</label><input id="in-shop-jp" type="number" placeholder="Â¥" class="w-full p-2 bg-white rounded border border-blue-200 mt-1"></div>
                <div class="col-span-2 text-center text-xs text-blue-500 pt-1">è¼¸å…¥æ—¥æœ¬åƒ¹æ ¼è‡ªå‹•è¨ˆç®—åŒ¯ç‡ (0.2025)</div>
            </div>
            <button onclick="saveShopItem()" class="w-full bg-pink-500 text-white font-bold py-3 rounded-xl shadow-lg mt-2">å„²å­˜</button>
        </div>
    </div>
    
    <!-- Budget Modal -->
    <div id="modal-budget" class="modal-overlay" onclick="closeModal('modal-budget')">
        <div class="modal-sheet space-y-4" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center"><h3 class="text-xl font-bold text-gray-700">è¨˜ä¸€ç­†æ”¯å‡º</h3><button onclick="closeModal('modal-budget')" class="text-gray-400"><i class="fa-solid fa-xmark text-xl"></i></button></div>
            <div class="bg-gray-50 p-2 rounded-xl border border-gray-200"><label class="text-xs text-gray-500 font-bold ml-1">æ—¥æœŸèˆ‡æ™‚é–“</label><input id="in-ex-time" type="datetime-local" class="w-full bg-transparent font-bold text-gray-700 outline-none mt-1"></div>
            <select id="in-ex-category" class="w-full p-3 bg-white rounded-xl border border-orange-200 text-gray-700 font-bold"><option value="é£Ÿç‰©">ğŸ” é£Ÿç‰©</option><option value="è³¼ç‰©">ğŸ›ï¸ è³¼ç‰©</option><option value="äº¤é€š">ğŸš— äº¤é€š</option><option value="é–€ç¥¨">ğŸ« é–€ç¥¨</option><option value="å…¶ä»–">ğŸ’¸ å…¶ä»–</option></select>
            <input id="in-ex-store" placeholder="å•†åº—/é¤å»³ (é¸å¡«)" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
            <input id="in-ex-item" placeholder="å“å/å…§å®¹" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
            <div class="grid grid-cols-2 gap-3"><input id="in-ex-price" type="number" placeholder="æ—¥å¹£å–®åƒ¹" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200"><div class="flex items-center gap-2"><button class="qty-btn" onclick="adjustQty(-1)">-</button><input id="in-ex-qty" type="number" value="1" class="w-full p-3 text-center bg-gray-50 rounded-xl border border-gray-200" readonly><button class="qty-btn" onclick="adjustQty(1)">+</button></div></div>
            <select id="in-ex-pay" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 text-gray-700"><option value="ç¾é‡‘">ğŸ’µ ç¾é‡‘</option><option value="ä¿¡ç”¨å¡">ğŸ’³ ä¿¡ç”¨å¡</option><option value="Suica/ICå¡">ğŸ§ Suica / ICå¡</option></select>
            <div class="bg-orange-50 p-4 rounded-xl text-center border border-orange-100"><div class="text-sm text-gray-500 mb-1">ç¸½é‡‘é¡ (å–®åƒ¹ x æ•¸é‡)</div><div class="text-2xl font-bold text-orange-600">Â¥<span id="calc-total">0</span></div><div class="text-sm font-bold text-blue-500 mt-1">â‰ˆ NT$<span id="calc-twd">0</span></div></div>
            <button onclick="addExpense()" class="w-full bg-orange-500 text-white font-bold py-3 rounded-xl shadow-lg mt-2">å„²å­˜ç´€éŒ„</button>
        </div>
    </div>

    <!-- Translation Modal -->
    <div id="trans-modal" class="fixed inset-0 bg-black/80 z-[110] hidden flex-col items-center justify-center p-6" onclick="closeTranslation()"><div class="bg-white rounded-2xl p-6 w-full max-w-sm text-center space-y-4" onclick="event.stopPropagation()"><h3 class="font-bold text-xl text-orange-600 border-b pb-2">ğŸ‡¯ğŸ‡µ å¹«æˆ‘èªªæ—¥æ–‡</h3><div class="grid grid-cols-2 gap-3"><div class="bg-gray-50 p-3 rounded-lg border text-left"><div class="text-xs text-gray-400">çµå¸³</div><div class="font-bold text-lg">ãŠä¼šè¨ˆ (Okai-kei)</div></div><div class="bg-gray-50 p-3 rounded-lg border text-left"><div class="text-xs text-gray-400">è¬è¬</div><div class="font-bold text-lg">ã‚ã‚ŠãŒã¨ã† (Arigatou)</div></div><div class="bg-gray-50 p-3 rounded-lg border text-left"><div class="text-xs text-gray-400">å»æ‰€</div><div class="font-bold text-lg">ãƒˆã‚¤ãƒ¬ (Toire)</div></div><div class="bg-gray-50 p-3 rounded-lg border text-left"><div class="text-xs text-gray-400">æ°´</div><div class="font-bold text-lg">ãŠæ°´ (Omizu)</div></div><div class="bg-gray-50 p-3 rounded-lg border text-left col-span-2"><div class="text-xs text-gray-400">ä¸å¥½æ„æ€ / è«‹å•</div><div class="font-bold text-lg">ã™ã¿ã¾ã›ã‚“ (Sumimasen)</div></div></div><button onclick="closeTranslation()" class="bg-gray-200 text-gray-700 px-8 py-3 rounded-full font-bold w-full mt-2">é—œé–‰</button></div></div>

    <!-- Navigation -->
    <div class="bottom-nav fixed bottom-0 w-full h-[80px] bg-white/95 backdrop-blur-md border-t border-orange-100 flex justify-between items-center px-4 pb-2 z-50">
        <div class="flex-1 flex justify-around items-end">
            <button onclick="switchTab('schedule')" id="btn-schedule" class="nav-item flex flex-col items-center p-2 w-14 transition active:scale-95"><i class="fa-regular fa-calendar-days text-xl mb-1"></i><span class="text-[10px] font-bold">è¡Œç¨‹</span></button>
            <button onclick="switchTab('vouchers')" id="btn-vouchers" class="nav-item flex flex-col items-center p-2 w-14 transition active:scale-95"><i class="fa-solid fa-ticket text-xl mb-1"></i><span class="text-[10px] font-bold">æ†‘è­‰</span></button>
        </div>
        <div class="relative w-20 flex justify-center z-10">
            <button onclick="switchTab('home')" id="btn-home" class="absolute -top-10 w-16 h-16 bg-gradient-to-br from-orange-400 to-orange-600 rounded-full shadow-lg shadow-orange-200 border-4 border-[#FFF8E1] text-white flex items-center justify-center transform transition hover:scale-105 active:scale-95"><i class="fa-solid fa-house text-2xl"></i></button>
            <span class="absolute top-8 text-[10px] font-bold text-orange-500">é¦–é </span>
        </div>
        <div class="flex-1 flex justify-around items-end">
            <button onclick="switchTab('shopping')" id="btn-shopping" class="nav-item flex flex-col items-center p-2 w-14 transition active:scale-95"><i class="fa-solid fa-bag-shopping text-xl mb-1"></i><span class="text-[10px] font-bold">å¿…è²·</span></button>
            <button onclick="switchTab('budget')" id="btn-budget" class="nav-item flex flex-col items-center p-2 w-14 transition active:scale-95"><i class="fa-solid fa-wallet text-xl mb-1"></i><span class="text-[10px] font-bold">è¨˜å¸³</span></button>
        </div>
    </div>

    <script>
        // --- 1. å·¥å…·å‡½å¼ ---
        function getDirectImageUrl(url) {
            if (!url) return '';
            if (url.includes('drive.google.com') && url.includes('/file/d/')) {
                try {
                    const id = url.split('/file/d/')[1].split('/')[0].split('?')[0];
                    return `https://lh3.googleusercontent.com/d/${id}`;
                } catch (e) { return url; }
            }
            return url;
        }

        function getDrivePreviewUrl(url) {
            if (!url) return '';
            if (url.includes('drive.google.com') && url.includes('/file/d/')) {
                try {
                    const id = url.split('/file/d/')[1].split('/')[0].split('?')[0];
                    return `https://drive.google.com/file/d/${id}/preview`;
                } catch (e) { return url; }
            }
            return url;
        }

        // --- 2. å…¨åŸŸè®Šæ•¸èˆ‡è¨­å®š ---
        let currentRole = localStorage.getItem('user_role');
        let currentSimulatedDate = null;
        let selectedDateIndex = 0;
        let currentTab = 'home';
        const JPY_RATE = 0.2025;
        
        // è¨˜å¸³ç›¸é—œ
        let currentBudgetTab = 'details';
        let budgetChart = null;
        const FAMILY_MEMBERS = [
            { id: 'driver', name: 'å¦¹å¦¹' },
            { id: 'copilot', name: 'çˆ¸çˆ¸' },
            { id: 'tourist', name: 'åª½åª½' },
            { id: 'admin', name: 'å§Šå§Š' }
        ];

        // è³¼ç‰©ç¯©é¸ç›¸é—œ
        let currentCategoryFilter = 'all';
        let currentStoreFilter = 'all';

        // Keys
        const PACKING_KEY = 'okinawa_packing_v3'; 
        const SHOPPING_KEY = 'okinawa_shop_local_v6'; 
        const EXPENSE_KEY = 'okinawa_expenses_local_v2';

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDLahJlYtLuCYrZBgiSYl7FqfOICJkJBd0",
            authDomain: "okinawa-202512.firebaseapp.com",
            databaseURL: "https://okinawa-202512-default-rtdb.firebaseio.com",
            projectId: "okinawa-202512",
            storageBucket: "okinawa-202512.firebasestorage.app",
            messagingSenderId: "932908173572",
            appId: "1:932908173572:web:bad7f92fd5e8e57948e851",
            measurementId: "G-HE116G25W0"
        };

        let db = null;
        try {
            if(firebaseConfig.apiKey) {
                firebase.initializeApp(firebaseConfig);
                db = firebase.database();
                document.getElementById('sync-indicator').classList.remove('sync-offline');
                document.getElementById('sync-indicator').classList.add('sync-online');
            }
        } catch (e) { console.error("Firebase Init Error", e); }

        // --- 3. è³‡æ–™å®šç¾© ---
        const defaultPackingList = [
            { id: 'imp1', text: "è­·ç…§ (æ•ˆæœŸ6å€‹æœˆä»¥ä¸Š)", category: "é‡è¦", done: false }, { id: 'imp2', text: "é§•ç…§ + ä¸­æ–‡è­¯æœ¬", category: "é‡è¦", done: false }, { id: 'imp3', text: "ç™»æ©Ÿè­‰ (é›»å­/ç´™æœ¬)", category: "é‡è¦", done: false }, { id: 'imp4', text: "éŒ¢åŒ… (å¡/æ—¥å¹£/å°å¹£)", category: "é‡è¦", done: false }, { id: 'imp5', text: "SIM å¡ (4å¼µ)", category: "é‡è¦", done: false }, { id: 'imp6', text: "é‘°åŒ™", category: "é‡è¦", done: false },
            { id: 't1', text: "ç‰™åˆ·ã€ç‰™è†ã€ç‰™ç·š", category: "ç›¥æ´—", done: false }, { id: 't2', text: "æ´—æ²è­·é«®ã€æ´—é¢ä¹³", category: "ç›¥æ´—", done: false }, { id: 't3', text: "é«®æ²¹ã€æ¢³å­ã€é¯Šé­šå¤¾", category: "ç›¥æ´—", done: false }, { id: 't4', text: "æ¯›å·¾ã€æµ´å·¾", category: "ç›¥æ´—", done: false }, { id: 't5', text: "åŒ–å¦å“ã€ä¿é¤Šå“", category: "ç›¥æ´—", done: false }, { id: 't6', text: "éš±å½¢çœ¼é¡ã€æ°´ç›’", category: "ç›¥æ´—", done: false },
            { id: 'c1', text: "å¤–å‡ºè¡£æœ (5å¤©)", category: "è¡£ç‰©", done: false }, { id: 'c2', text: "å…§è¡£è¤²ã€è¥ªå­", category: "è¡£ç‰©", done: false }, { id: 'c3', text: "ç¡è¡£ã€æ‹–é‹", category: "è¡£ç‰©", done: false }, { id: 'c4', text: "å¤–å¥—ã€å¸½å­ã€å¢¨é¡", category: "è¡£ç‰©", done: false }, { id: 'e1', text: "å……é›»å™¨ã€ç·šã€è¡Œå……", category: "é›»å­", done: false }, { id: 'e2', text: "å°èˆªæ‰‹æ©Ÿæ¶", category: "é›»å­", done: false }, { id: 'o1', text: "éš¨èº«åŒ…ã€ç’°ä¿è¢‹", category: "é›œé …", done: false }, { id: 'o2', text: "é›¨å‚˜ã€æ°´å£º", category: "é›œé …", done: false }, { id: 'o3', text: "é˜²èšŠæ¶²ã€é˜²æ›¬", category: "é›œé …", done: false }, { id: 'o4', text: "å€‹äººè—¥å“", category: "é›œé …", done: false }, { id: 'o5', text: "è²“æ¢", category: "é›œé …", done: false }
        ];
        
        // --- äº‹å‰æº–å‚™æ¸…å–®è³‡æ–™ ---
const PREP_KEY = 'okinawa_prep_list_v1';
const defaultPrepList = [
    { id: 'p1', text: "ç™»è¨˜ Visit Japan Web", link: "https://www.vjw.digital.go.jp/main/#/vjwplo001", done: false },
    { id: 'p2', text: "æŸ¥çœ‹è­·ç…§æ˜¯å¦éæœŸ", done: false },
    { id: 'p3', text: "æ›æ—¥å¹£ (ç´„ Â¥100,000 ç¾é‡‘ + åˆ·å¡é‡‘)", done: false },
    { id: 'p4', text: "ç¢ºèªä¿¡ç”¨å¡é¸æ“‡åŠé¡åº¦", done: false },
    { id: 'p5', text: "è¡Œæç®±åˆ†é…", done: false }
];

// --- å–å¾—/å„²å­˜ äº‹å‰æº–å‚™æ¸…å–® ---
function getPrepList() {
    const stored = localStorage.getItem(PREP_KEY);
    if (!stored) {
        localStorage.setItem(PREP_KEY, JSON.stringify(defaultPrepList));
        return defaultPrepList;
    }
    return JSON.parse(stored);
}

// --- åˆ‡æ›å‹¾é¸ç‹€æ…‹ ---
function togglePrep(id) {
    const list = getPrepList();
    const item = list.find(i => i.id === id);
    if (item) {
        item.done = !item.done;
        localStorage.setItem(PREP_KEY, JSON.stringify(list));
        // åˆ·æ–°ç•¶å‰é é¢
        if (currentTab === 'home') renderHome();
        if (currentTab === 'vouchers') renderVouchers();
    }
}

// --- ç”Ÿæˆ HTML å…ƒä»¶ ---
function getPrepListHTML() {
    const list = getPrepList();
    const doneCount = list.filter(i => i.done).length;
    const totalCount = list.length;
    const progress = Math.round((doneCount / totalCount) * 100);

    const itemsHtml = list.map(item => {
        // å¦‚æœæœ‰é€£çµï¼Œé¡¯ç¤ºé€£çµæŒ‰éˆ•
        const linkHtml = item.link 
            ? `<a href="${item.link}" target="_blank" class="ml-2 text-xs bg-purple-100 text-purple-600 px-2 py-0.5 rounded border border-purple-200 hover:bg-purple-200 transition inline-block" onclick="event.stopPropagation()"><i class="fa-solid fa-arrow-up-right-from-square"></i> é€£çµ</a>` 
            : '';

        return `
            <div class="flex items-center gap-3 p-2 rounded hover:bg-purple-50 transition cursor-pointer border-b border-gray-50 last:border-0" onclick="togglePrep('${item.id}')">
                <div class="w-5 h-5 flex-shrink-0 rounded border-2 border-purple-400 flex items-center justify-center ${item.done ? 'bg-purple-400' : 'bg-white'}">
                    ${item.done ? '<i class="fa-solid fa-check text-white text-xs"></i>' : ''}
                </div>
                <div class="flex-1 leading-tight">
                    <span class="text-sm ${item.done ? 'text-gray-400 line-through' : 'text-gray-700 font-medium'}">${item.text}</span>
                    ${linkHtml}
                </div>
            </div>`;
    }).join('');

    return `
        <div class="card p-5 mb-4 border-l-4 border-purple-500 shadow-lg bg-white">
            <div class="flex justify-between items-end mb-2">
                <h3 class="font-bold text-purple-700"><i class="fa-solid fa-clipboard-check mr-2"></i>äº‹å‰æº–å‚™</h3>
                <span class="text-xs font-bold text-purple-600">${doneCount}/${totalCount} (${progress}%)</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2 mb-3">
                <div class="bg-purple-500 h-2 rounded-full transition-all duration-500" style="width: ${progress}%"></div>
            </div>
            <div class="grid grid-cols-1 gap-1">
                ${itemsHtml}
            </div>
        </div>`;
}

        const defaultShoppingList = [
            { id: 's1', category: 'é›œè²¨', store: 'é‚£éœ¸æ©Ÿå ´/å–®è»Œ', item: 'OKIKA äº¤é€šå¡', priceJp: 2000, priceTw: 440, done: false },
            { id: 's2', category: 'é›»å™¨', store: 'ä¾¿åˆ©å•†åº—/è¶…å¸‚', item: 'æ‹ç«‹å¾— (Instant Camera)', priceJp: 15000, priceTw: 3300, done: false },
            { id: 's3', category: 'è¡£ç‰©', store: 'ç¾åœ‹æ‘ American Depot', item: 'å¤è‘— (Vintage)', priceJp: 3500, priceTw: 770, done: false }
        ];

        const okinawaEvents = [
            { title: "æ±å—æ¤ç‰©æ¨‚åœ’ ç‡ˆå…‰ç§€", date: "10/25 - 5/25", loc: "æ²–ç¹©å¸‚", img: "https://www.okinawastory.jp/feature/illumination/images/spot01_img01.jpg", link: "https://www.google.com/maps/search/Southeast+Botanical+Gardens" },
            { title: "ç³¸æ»¿å’Œå¹³ç‡ˆé£¾", date: "12/13 - 1/03", loc: "ç³¸æ»¿å¸‚", img: "https://www.okinawastory.jp/feature/illumination/images/spot04_img01.jpg", link: "https://www.google.com/maps/search/Itoman+Peaceful+Illumination" },
            { title: "ç‰çƒç‡ˆæœƒ (èª­è°·)", date: "12/01 - 3/31", loc: "è®€è°·æ‘", img: "https://lantan.ryukyu/wp-content/uploads/2023/10/img_main_sp.jpg", link: "https://www.google.com/maps/search/Murasaki+Mura+Ryukyu+Kingdom+Theme+Park" },
            { title: "å…’ç«¥ç‹åœ‹ è–èª•å¤¢å¹»", date: "12/20 - 1/05", loc: "æ²–ç¹©å¸‚", img: "https://www.xmas-fantasy.com/images/main_sp.jpg", link: "https://www.google.com/maps/search/Okinawa+Zoo+Museum" },
            { title: "ç¾åœ‹æ‘ è–èª•ç‡ˆé£¾", date: "11/15 - 3/14", loc: "åŒ—è°·ç”º", img: "https://www.okinawastory.jp/feature/illumination/images/spot02_img01.jpg", link: "https://www.google.com/maps/search/American+Village+Okinawa" }
        ];

        const tripData = [
    {
        date: "12/25", fullDate: "2025/12/25", day: "é€±å››", weather: "â˜ï¸ 20Â°C",
        events: [
            { time: "14:50", title: "Uber å‡ºç™¼åŒ—è»Š", type: "trans", guide: "è­·ç…§ã€æ‰‹æ©Ÿã€éŒ¢åŒ…å¸¶äº†å—ï¼Ÿ", appLink: { url: "https://m.uber.com/ul", text: "é–‹å•Ÿ Uber", icon: "fa-brands fa-uber" }, travel: { mode: 'train', time: '40åˆ†' } },
            { 
                time: "15:20", title: "æ©Ÿæ·å¾€æ©Ÿå ´ (ç›´é”è»Š)", type: "trans", guide: "A1 å°åŒ—è»Šç«™ -> A13 ç¬¬ä¸€èˆªå»ˆ", frequency: "ç´„ 15 åˆ†é˜ä¸€ç­", 
                timetableUrl: "https://drive.google.com/file/d/16MInONdMqG5ZsAsTRm5-S3Tymmrf2EOb/view?usp=drive_link" 
            },
            { 
                time: "16:30", title: "æ©Ÿå ´ Check-in", type: "trans", title_detail: "æ¨‚æ¡ƒ MM930", 
                bookingInfo: { 
                    code: "1616324336315022", 
                    note: "Trip.com è¨‚å–®", 
                    extra: "æ¡ƒåœ’åœ‹éš›æ©Ÿå ´ T1 | 20kg è¨—é‹ / 7kg æ‰‹æ", 
                    driveLink: "https://drive.google.com/file/d/1iScNq9RHqi_l-JYoXhKnhk8Btu-4gTaG/view?usp=drive_link"
                }, 
                guide: "18:20 èµ·é£› -> 20:50 æŠµé” (D)ã€‚",
            },
            { 
                time: "18:20", title: "æ¨‚æ¡ƒ MM930 èµ·é£›", type: "trans",
                guide: "18:20 èµ·é£› -> 20:50 æŠµé” (D)ã€‚",
                travel: { mode: 'plane', time: '1h 30m' }
            },
             { 
                time: "20:50", title: "æŠµé” é‚£éœ¸æ©Ÿå ´ D", type: "trans",
                guide: "18:20 èµ·é£› -> 20:50 æŠµé” (D)ã€‚",
            },
            { 
                time: "21:30", title: "å–®è»Œåˆ—è»Šå¾€å¸‚å€", type: "trans", guide: "é‚£éœ¸æ©Ÿå ´ç«™ -(7ç«™ç´„14åˆ†)> ç¾æ¦®æ©‹ç«™ 1è™Ÿå‡ºå£ã€‚", frequency: "ç´„ 10-12 åˆ†é˜ä¸€ç­", 
                timetableUrl: "https://drive.google.com/file/d/1brg7uYoSb6vgqMZXRK4oGMJARYow6M79/view?usp=drive_link", 
                travel: { mode: 'walk', time: '5åˆ†' } 
            },
            { 
                time: "22:00",leaveTime: "22:20",  title: "æ±æ©«INN ç¾æ¦®æ©‹", type: "hotel", mapCode: "33 157 154*55", 
                bookingInfo: { 
                    code: "5892799 / 5892800", 
                    note: "æœƒå“¡å¡ Check-in (ç¾å ´ä»˜)",
                    driveLink: "https://drive.google.com/file/d/1LxppScaTh2hwfZVWykidQtgDm9UagXeQ/view?usp=drive_link"
                } 
            },
            { 
                time: "22:30", title: "æ™šé¤äºŒé¸ä¸€", type: "choice", 
                choices: [ 
                    { 
                        title: "è¦æ¹¯æ‹‰éºµ Chanya", 
                        type: "eat", 
                        imgUrl: "https://tblg.k-img.com/restaurant/images/Rvw/306129/640x640_rect_1c59d40469eed39e39ca6f832061d5dd.jpg",
                        guide: "éš±è—å··å¼„çš„æ¿ƒéƒè¦æ¹¯ï¼Œæ·±å¤œé£Ÿå ‚æ°›åœã€‚", 
                        // â˜… äº¤é€šæ™‚é–“
                        travelTime: "æ­¥è¡Œ 10åˆ†",
                        navLink: "https://maps.app.goo.gl/4C2URtcJCK8evziz8",
                        // â˜… Google è©•è«–ç”¨é€£çµ
                        reviewLink: "https://maps.app.goo.gl/HEYTrTrB5RyKFYBx5",
                        link: "https://tabelog.com/tw/okinawa/A4701/A470101/47002685/",
                        detailInfo: { 
                            desc: `é€™å®¶åº—ä¸åœ¨åœ‹éš›é€šå¤§è¡—ä¸Šï¼Œè€Œæ˜¯éš±è—åœ¨æ¾å±±å··å¼„è£¡ï¼Œæ˜¯ç•¶åœ°äººä¸‹ç­å–é…’å¾Œçš„ã€Œæ”¶å°¾æ‹‰éºµã€ã€‚<br><br><b>ğŸ¦ éˆé­‚æ¹¯é ­ï¼š</b><br>è¦å‘³çš„æš´åŠ›ç¾å­¸ï¼ä½¿ç”¨å¤§é‡ç”œè¦ã€è»Šæµ·è€ç†¬ç…®ï¼Œä¸æ˜¯æ·¡æ·¡æ¸…é¦™ï¼Œè€Œæ˜¯<b>ã€Œæ¿ƒç¸®çš„è¡æ“Šã€</b>ï¼å…¥å£é®®ç”œç›´è¡é¼»è…”ã€‚<br><br><b>âš ï¸ é‡è¦æé†’ï¼šåº—å…§å…¨é¢ä¸ç¦è¸</b>ï¼Œä»‹æ„è¸å‘³è€…è«‹æ–Ÿé…Œã€‚`, 
                            tags: ["æ‹‰éºµ", "å®µå¤œ", "é‡å£å‘³", "å¸è¸å¯"], 
                            highlights: [
                                "ğŸ‘‘ é¦–é¸ï¼šæµ·è€å‘³å™Œæ‹‰éºµ (æ¿ƒéƒçˆ½åº¦)",
                                "ğŸ¥ˆ æ¸…çˆ½æ´¾ï¼šæµ·è€é¹½å‘³æ‹‰éºµ (é®®ç”œ)",
                                "ğŸ¥Ÿ é…è§’ï¼šä¸€å£é¤ƒå­ (çš®è–„é¤¡å¤š)",
                                "æ°›åœï¼šè¥¿è£å¤§å”çš„æ·±å¤œé£Ÿå ‚"
                            ],
                            menu:[
                                {n:"æµ·è€å‘³å™Œæ‹‰éºµ", p:"Â¥980"},
                                {n:"æµ·è€é¹½å‘³æ‹‰éºµ", p:"Â¥980"},
                                {n:"ä¸€å£é¤ƒå­", p:"Â¥400"}
                            ] 
                        } 
                    }, 
                    { 
                        title: "ç‰çƒä¸­è¯ è›™å½", 
                        type: "eat", 
                        // â˜… å°é¢ç…§ç‰‡
                        imgUrl: "https://tblg.k-img.com/resize/660x370c/restaurant/images/Rvw/198123/29193b52eb9c59bf138115b14443726a.jpg?token=df157a4&api=v2",
                        // â˜… ç°¡çŸ­èªªæ˜
                        guide: "éœ“è™¹æ¸¯é¢¨ x æ²–ç¹©è€å®…ï¼Œåœ¨åœ°å¹´è¼•äººèšé›†çš„æ½®åº—ã€‚", 
                        // â˜… äº¤é€šæ™‚é–“
                        travelTime: "æ­¥è¡Œ 12åˆ†",
                        // â˜… å°èˆª
                        navLink: "https://maps.app.goo.gl/uxpRiSDsBC5r8D78A",
                        // â˜… Google è©•è«–é€£çµ
                        reviewLink: "https://maps.app.goo.gl/GogoMVRZ79Bem3N97", 
                        // â˜…Tabelogã€å®˜ç¶²ã€IG
                        link: "https://tabelog.com/tw/okinawa/A4701/A470101/47029564/", 
                        detailInfo: { 
                            // â˜… è©³ç´°ä»‹ç´¹
                            desc: `é€™å®¶åº—èµ°çš„æ˜¯<b>ã€Œéœ“è™¹æ¸¯é¢¨ x æ²–ç¹©è€å®…ã€</b>è·¯ç·šï¼Œè¢«ç¨±ç‚ºã€Œæ–°æ´¾ä¸­è¯ (Neo Chinese)ã€ã€‚<br><br><b>ğŸ® æ°›åœï¼šç‹å®¶è¡›é›»å½±æ„Ÿ</b><br>åº—å…§å……æ»¿ç´…è‰²èˆ‡ç¶ è‰²éœ“è™¹ç‡ˆï¼Œå¾ˆæœ‰ Cyberpunk (è³½åšé¾å…‹) æ„Ÿï¼Œåƒé›»å½±ã€Šå¢®è½å¤©ä½¿ã€‹çš„å ´æ™¯ï¼Œéš¨ä¾¿æ‹éƒ½åƒç¶²ç¾ç…§ã€‚<br><br><b>âš ï¸ æ²–ç¹©è¶…äººæé†’ï¼š</b><br>1. <b>è¸å‘³è­¦å ±</b>ï¼š23:00 å¾Œé€šå¸¸å…¨é¢é–‹æ”¾å¸è¸ã€‚<br>2. <b>è²»ç”¨ç´°ç¯€</b>ï¼šæœ‰åº§å¸­è²» (Otoshi) ç´„ Â¥330/äººï¼Œä¸”æ¯äººä½æ¶ˆä¸€æ¯é£²æ–™ã€‚`, 
                            tags: ["æ–°ä¸­è¯","éœ“è™¹æ¸¯é¢¨","æ·±å¤œç‡Ÿæ¥­","ç¶²ç¾"], 
                            highlights: [
                                "ğŸ“¸ è¦–è¦ºï¼šç‹å®¶è¡›é›»å½±é¢¨æ ¼ (è¶…å¥½æ‹)",
                                "ğŸ”¥ å¿…é»ï¼šå››å·è—¥è†³éº»å©†è±†è… (èŠ±æ¤’éº»)",
                                "ğŸ¹ æ‰“å¡ï¼šå‡æª¸å¡” (æ•´é¡†æª¸æª¬å †é«˜é«˜)",
                                "ğŸ¥Ÿ é»å¿ƒï¼šæº¢æ±å°ç± åŒ… / ç‡’è³£"
                            ],
                            menu:[
                                {n:"è—¥è†³éº»å©†è±†è…", p:"Â¥960"},
                                {n:"è›™å½é»‘ç‚’é£¯", p:"Â¥930"},
                                {n:"å‡æª¸å¡”æ²™ç“¦", p:"Â¥630"},
                                {n:"åº§å¸­è²»(Otoshi)", p:"Â¥330"}
                            ] 
                        } 
                    }  
                ] 
            }
        ]
    },
    {
        date: "12/26", fullDate: "2025/12/26", day: "é€±äº”", weather: "â˜€ï¸ 21Â°C",
        events: [
            { time: "06:00", title: "èµ·åºŠ & æ—©é¤(6:30 - 9:00)", type: "prep", guide: "é£¯åº—æ—©é¤ã€‚è«‹æº–æ™‚æ•´ç†è¡Œæã€‚", departureTime: "08:00 æº–æ™‚å‡ºç™¼", travel: { mode: 'trans', time: '30åˆ†' } },
            { 
                time: "08:30", title: "OTS ç§Ÿè»Š (è‡¨ç©ºè±å´)", type: "trans", 
                bookingInfo: { 
                    code: "OTS1365405", 
                    note: "é ç´„åï¼šChen Ru Xuan",
                    driveLink: "https://drive.google.com/file/d/1tmm03HWp8HNxlyd9rlX4RjYBaGOsh-OJ/view?usp=drive_link"
                }, 
                guide: "å³é§•å£è¨£ï¼šé å·¦é–‹ï¼Œé›¨åˆ·åœ¨å·¦ï¼Œæ–¹å‘ç‡ˆåœ¨å³ã€‚", travel: { mode: 'drive', time: '30åˆ†' } 
            },
            { 
                time: "10:30",
                leaveTime: "10:40", 
                title: "Once a Week è‚‰æ¡‚æ²", 
                type: "eat", 
                imgUrl: "https://tblg.k-img.com/restaurant/images/Rvw/262352/640x640_rect_b36a9b4580015fb4deb55dafe1237997.jpg", // ç¤ºæ„åœ–
                guide: "å‚³èªªä¸­çš„è‚‰æ¡‚æ²ååº—ï¼Œå»ºè­°è²·äº†è»Šä¸Šåƒã€‚", 
                
                // 1. å¡ç‰‡å³ä¸Šè§’å°åœ“éˆ• (å°èˆªç”¨)
                navLink: "https://maps.app.goo.gl/JRaZSCn2YMe5Grri7", 
                
                // 2. è©³ç´°è¦–çª—å³é‚Šè—è‰²æŒ‰éˆ• (çœ‹è©•è«–ç”¨)
                reviewLink: "https://maps.app.goo.gl/GFrbHtViTLTuy7BG7",
                
                // 3. è©³ç´°è¦–çª—å·¦é‚ŠæŒ‰éˆ• (å®˜æ–¹ IG)
                link: "https://www.instagram.com/onceaweekcoffee.naha/", 
                
                detailInfo: { 
                    desc: "é€™æ˜¯ä¸€é–“éå¸¸ä½èª¿ä½†äººæ°£è¶…é«˜çš„è‚‰æ¡‚æ²å°ˆè³£åº—ã€‚å¤–çš®é…¥è„†ã€å…§å±¤æ¿•æ½¤ï¼Œè‚‰æ¡‚é¦™æ°£æ¿ƒéƒä½†ä¸åˆºé¼»ï¼Œæ˜¯å¾ˆå¤šæ²–ç¹©é€šå¿ƒä¸­çš„ No.1ã€‚",
                    tags: ["è‚‰æ¡‚æ²", "å¤–å¸¶ç¾é£Ÿ", "ç”œé»"], 
                    highlights: [
                        "æ¯æ—¥é™é‡ï¼Œæ™šä¾†è²·ä¸åˆ°",
                        "å¤šç¨®å£å‘³ï¼šåŸå‘³ã€é»‘ç³–ã€å¥¶æ²¹ä¹³é…ª",
                        "é©åˆç•¶ä½œé–‹è»Šé€”ä¸­çš„é»å¿ƒ"
                    ],
                    menu: [
                        {n: "ç¶“å…¸è‚‰æ¡‚æ²", p: "Â¥450"},
                        {n: "é»‘ç³–æ ¸æ¡ƒè‚‰æ¡‚æ²", p: "Â¥480"},
                        {n: "å†°æ‹¿éµ", p: "Â¥550"}
                    ]
                },
                
                travel: { mode: 'drive', time: '15åˆ†' } 
            },
            { 
                time: "11:00",
                leaveTime: "12:00", 
                title: "æ¸¯å·å¤–äººä½å®…è¡—", 
                type: "spot", 
                // å°é¢åœ–ï¼šé¸ç”¨æœ€å…·ä»£è¡¨æ€§çš„ oHacorte å°æœ¨å±‹èˆ‡ç²‰è—è‰²å»ºç¯‰
                imgUrl: "https://b-cat.tw/wp-content/uploads/2019/06/47991552012_1537f2e673_o-1024x682.jpg",
                
                guide: "é¦¬å¡é¾è‰²ç³»çš„ç¾è»å®¿èˆç¾¤ï¼Œç”œé»æˆ°å€ (oHacorte / ã»ã†ãæ˜Ÿ)ã€‚", 
                
                // 1. å°èˆªï¼šè¨­å®šåˆ°å¤–äººä½å®…å€å…¥å£
                navLink: "https://maps.app.goo.gl/xckj2nsiLzFXARiK7", 
                
                // 2. è©•è«–ï¼šé€™è£¡è¨­å®šç‚º Google Maps çš„è©•è«–é é¢
                reviewLink: "https://maps.app.goo.gl/dzMhn2MomSrYvRkh8",
                
                // 3. å®˜ç¶²ï¼šæ¸¯å·å¤–äººä½å®…å®˜æ–¹ç¶²ç«™
                link: "http://minatogawa-shop.r-cms.jp/", 
                
                detailInfo: { 
                    desc: `é€™è£¡ä»¥å‰æ˜¯ç¾è»çœ·å±¬å®¿èˆï¼Œç¾åœ¨æ˜¯è¶…å¥½æ‹çš„æ–‡é’èšè½ã€‚æ¯æ£Ÿå¹³æˆ¿éƒ½æ¼†æˆå¯æ„›çš„é¦¬å¡é¾è‰²ï¼Œè·¯åä¹Ÿæ˜¯ç”¨ç¾åœ‹å·åå‘½åï¼ˆå¦‚ Nevada St.ï¼‰ï¼Œå……æ»¿ç•°åœ‹é¢¨æƒ…ã€‚<br><br><b>ğŸš— åœè»Šæ”»ç•¥ (é‡è¦ï¼)ï¼š</b><br>é€™è£¡æ˜¯ã€Œè‡ªé§•å°é­”ç‹é—œå¡ã€ï¼Œ<b>è·¯éå¸¸çª„ï¼Œæœƒè»Šå›°é›£ï¼</b>ä¸”åº—å®¶å°ˆå±¬è»Šä½æ¥µå°‘ã€‚<br>ğŸ’¡ <b>å¼·çƒˆå»ºè­°ï¼š</b>ç›´æ¥åœåœ¨å…¥å£è™•æˆ–ä¸­é–“çš„<b>ã€ŒæŠ•å¹£å¼åœè»Šå ´ (Coin Parking)ã€</b>å†èµ°é€²å»é€›ï¼Œæœ€è¼•é¬†çœäº‹ã€‚`, 
                    
                    tags: ["æ–‡é’", "ç”œé»", "æ‹ç…§è–åœ°", "é¦¬å¡é¾è‰²"], 
                    
                    highlights: [
                        "âš¡ï¸ 1å°æ™‚å¿«é–ƒï¼š11:00 æ‹ç…§ -> 11:30 è²·ç”œé» -> 12:00 é›¢é–‹",
                        "ğŸ›ï¸ å¿…è²·ï¼šã»ã†ãæ˜Ÿ (é»‘ç³–å¯éº—éœ²) - 25è™Ÿ",
                        "ğŸ° å¿…åƒï¼šoHacorte (æ°´æœå¡”) - 18è™Ÿ (é–€å£å¿…æ‹!)",
                        "âš ï¸ æ³¨æ„ï¼šippe coppe éºµåŒ…åº— 12:30 æ‰é–‹ï¼Œå¯èƒ½æœƒä¾†ä¸åŠ"
                    ],
                    
                    // æŠŠåº—å®¶ç•¶ä½œ Menu é¡¯ç¤ºï¼Œæ–¹ä¾¿æŸ¥çœ‹
                    menu: [
                        {n: "[25è™Ÿ] ã»ã†ãæ˜Ÿ", p: "é»‘ç³–å¯éº—éœ²"},
                        {n: "[18è™Ÿ] oHacorte", p: "ç å¯¶ç›’æ°´æœå¡”"},
                        {n: "[26è™Ÿ] ippe coppe", p: "å¤©ç„¶é…µæ¯éºµåŒ…"}
                    ]
                }, 
                
                travel: { mode: 'drive', time: '30åˆ†' } 
            },
            { 
                time: "12:30", 
                leaveTime: "13:30",
                title: "æ™®å¤©æ»¿å®®", 
                type: "spot", 
                imgUrl: "https://cdn.zekkei-japan.jp/datas/images/2024/04/30/c03f51ed4ebc5e578df0cbe7501f1a9ee742df4e.jpg",
                guide: "å®œé‡ç£æœ€å¼·èƒ½é‡æ™¯é»ï¼Œæœ¬æ®¿å¾Œæ–¹è—è‘—ç¥ç§˜é˜ä¹³çŸ³æ´ (âš ï¸éœ€ç™»è¨˜/ç¦æ‹ç…§)ã€‚", 
                mapCode: "33 438 616*33", 
                // â˜… å°èˆªé€£çµ (å¡ç‰‡å³ä¸Šè§’)
                navLink: "https://maps.app.goo.gl/S4KiRAgGtwoxpJ9dA", 
                // â˜… è©•è«–é€£çµ (è©³ç´°è¦–çª—å³ä¸‹è§’)
                reviewLink: "https://maps.app.goo.gl/7QfHwUZj3ymJeTFm8",
                // â˜… tabelogã€IGã€å®˜ç¶²ã€ä»‹ç´¹
                link: "http://futenmagu.or.jp/", 
                
                detailInfo: { 
                    desc: `<b>â›©ï¸ å…©å¤§çœ‹é»ï¼š</b><br>1. <b>åœ°åº•ç¥ç§˜ä¸–ç•Œ</b>ï¼šæœ¬æ®¿å¾Œæ–¹è—è‘—å…¨é•· 280å…¬å°ºçš„é˜ä¹³çŸ³æ´ï¼Œæ°£æ°›èŠåš´è‚…ç©†ï¼Œä¾›å¥‰è‘—ã€Œæ™®å¤©æ»¿å¥³ç¥ã€ã€‚<br>2. <b>çµç·£èˆ‡æ±‚å­</b>ï¼šåœ¨åœ°äººå¿ƒä¸­æ±‚ã€Œè‰¯ç·£ (En-musubi)ã€å’Œã€Œå®‰ç”¢ã€éå¸¸éˆé©—ã€‚<br><br><b>âš ï¸ é€²æ´ç©´æ”»ç•¥ (å¿…çœ‹ï¼)ï¼š</b><br>æ´ç©´<b>ä¸æ˜¯è‡ªç”±é€²å‡º</b>çš„ï¼æŠµé”å¾Œè«‹å…ˆå»<b>ã€Œæˆäºˆæ‰€ (è³£å¾¡å®ˆæ«ƒå°)ã€</b>å¡«å¯«ç”³è«‹å–®ç™»è¨˜ã€‚å·«å¥³æœƒå®‰æ’æ¢¯æ¬¡ï¼ˆç´„20-30åˆ†ä¸€æ¢¯ï¼‰ï¼Œåœ¨æ—é‚Šä¼‘æ¯å®¤ç­‰å¾…å¼•å°ã€‚<br><br><b>ğŸš« åš´ç¦æ‹ç…§ï¼š</b>æ´ç©´å…§ç¾åœ¨<b>ã€Œå…¨é¢ç¦æ­¢æ”å½±ã€</b>ï¼Œè«‹å‹™å¿…éµå®ˆè¦å®šï¼Œç”¨å¿ƒæ„Ÿå—å³å¯ã€‚<br><br><b>ğŸš— åœè»Šï¼š</b>æœ‰å…è²»åœè»Šå ´ï¼Œå°±åœ¨é³¥å±…æ—ã€‚`, 
                    tags: ["é˜ä¹³çŸ³æ´", "çµç·£", "èƒ½é‡æ™¯é»", "å…è²»åƒè§€"], 
                    highlights: [
                        "âœ¨ å¿…çœ‹ï¼šæœ¬æ®¿å¾Œæ–¹çš„ç¥ç§˜åœ°åº•æ´ç©´",
                        "ğŸ“ æµç¨‹ï¼šå…ˆå»æ«ƒå°ç™»è¨˜ -> ç­‰å¾…å«è™Ÿ",
                        "ğŸš« è­¦å‘Šï¼šæ´ç©´å…§çµ•å°ç¦æ­¢æ‹ç…§ (No Photos)",
                        "ğŸ™ ç¥ˆç¦ï¼šæ±‚è‰¯ç·£ã€å®‰ç”¢ç‰¹åˆ¥éˆé©—"
                    ]
                }, 
                
                travel: { mode: 'drive', time: '20åˆ†' } 
            },
            { 
                time: "14:30", 
                leaveTime: "15:30",
                title: "åˆé¤ï¼šå£½å¸å¸‚å ´ æ³¡ç€¨åº—", 
                type: "eat", 
                
                // â˜… å°é¢ç…§ç‰‡
                imgUrl: "https://www.garnish.tv/page/pimg/thumbnail/20160605073523.jpg",
                
                guide: "åœ¨åœ°äººæ°£è¿´è½‰å£½å¸ï¼Œå¿…åƒè—è‰²é­š(ä¼Šæ‹‰å¸ƒæŸ¥)èˆ‡ç‚¸é­šå¤©å©¦ç¾…ã€‚", 
                
                // â˜… å°èˆªèˆ‡è©•è«–
                mapCode: "33 531 366*44", 
                navLink: "https://maps.app.goo.gl/RV1UCj2pNZPbucAx6",
                reviewLink: "https://maps.app.goo.gl/mhKCecLYWQ96HRCk8",
                link: "https://tabelog.com/tw/okinawa/A4703/A470301/47005461/",
                
                detailInfo: { 
                    desc: `
                        <b>ğŸ£ æ²–ç¹©é™å®šå¿…é»ï¼š</b><br>
                        1. <b>ä¼Šæ‹‰å¸ƒæŸ¥ (é’è¡£é­š)</b>ï¼šè—è‰²çš„çš®åƒå¤–æ˜Ÿç”Ÿç‰©ï¼Œä½†è‚‰è³ªQå½ˆæ¸…çˆ½ï¼<br>
                        2. <b>æ²–ç¹©ç¸£ç”¢é®ªé­š</b>ï¼šç”Ÿé®®ç›´é€ç„¡å†·å‡ï¼Œè»Ÿå«©é®®ç”œã€‚<br>
                        3. <b>æµ·è‘¡è„è»è‰¦</b>ï¼šå•µå•µå•µå£æ„Ÿé…é†‹é£¯è¶…é–‹èƒƒã€‚<br>
                        4. <b>ç‚¸é­šå¤©å©¦ç¾…</b>ï¼šåšéºµè¡£åƒé›¶é£Ÿï¼Œæ²¾é¹½å·´åƒè¶…è®šã€‚<br><br>
                        
                        <b>ğŸš— åœè»Šèˆ‡é»é¤ï¼š</b><br>
                        åœè»Šå ´å¤§ä½†è»Šæµå¿«ã€‚é€²åº—è«‹å…ˆæŠ½è™Ÿç¢¼ç‰Œ (Ticket)ã€‚<br>
                        é»é¤ä½¿ç”¨ <b>å¹³æ¿ (Tablet)</b>ï¼Œæœ‰ä¸­æ–‡/è‹±æ–‡ä»‹é¢ï¼Œå…æ“”å¿ƒï¼<br><br>
                        
                        <b>ğŸ å„ªæƒ åˆ¸ (Coupon)ï¼š</b><br>
                        <a href="http://gurumekaiten.com/coupon.pdf" target="_blank" class="inline-block bg-red-50 text-red-600 border border-red-200 px-3 py-2 rounded-lg text-sm font-bold hover:bg-red-100 transition"><i class="fa-solid fa-ticket mr-1"></i> é»æ­¤é–‹å•Ÿ PDF å„ªæƒ åˆ¸</a><br><br>

                        <b>ğŸ“œ å®Œæ•´èœå–® (é»æ“ŠæŸ¥çœ‹)ï¼š</b><br>
                        <div class="flex flex-wrap gap-2 mt-1">
                            <a href="http://gurumekaiten.com/images/menu/2025/big_menu2025.png" target="_blank" class="text-blue-600 underline text-xs">ä¸»èœå–®</a>
                            <a href="http://gurumekaiten.com/images/menu/2025/big_side_menu2025_1.png" target="_blank" class="text-blue-600 underline text-xs">å‰¯é¤1</a>
                            <a href="http://gurumekaiten.com/images/menu/2025/big_side_menu2025_2.png" target="_blank" class="text-blue-600 underline text-xs">å‰¯é¤2</a>
                            <a href="http://gurumekaiten.com/images/menu/2025/big_side_menu2025_3.png" target="_blank" class="text-blue-600 underline text-xs">å‰¯é¤3</a>
                        </div>
                    `, 
                    
                    tags: ["è¿´è½‰å£½å¸", "åœ¨åœ°äººæ°£", "å¹³åƒ¹", "ä¸­æ–‡å¹³æ¿"], 
                    
                    highlights: [
                        "ğŸŸ å¿…åƒï¼šè—è‰²é¸šå“¥é­š (ä¼Šæ‹‰å¸ƒæŸ¥)",
                        "ğŸ£ æ¨è–¦ï¼šæ²–ç¹©ç¸£ç”¢é®ªé­š (æœªå†·å‡)",
                        "ğŸ¤ ç‰¹è‰²ï¼šç‚¸é­šå¤©å©¦ç¾… (åšéºµè¡£)",
                        "ğŸ’¡ æé†’ï¼šé€²åº—å…ˆæŠ½è™Ÿç¢¼ç‰Œ"
                    ],
                    
                    menu: [
                        {n: "ä¼Šæ‹‰å¸ƒæŸ¥(é’è¡£é­š)", p: "æ™‚åƒ¹"},
                        {n: "æ²–ç¹©ç¸£ç”¢é®ªé­š", p: "Â¥280~"},
                        {n: "ç‚¸é­šå¤©å©¦ç¾…", p: "Â¥190"}
                    ] 
                }, 
                
                travel: { mode: 'drive', time: '10åˆ†' } 
            },
            { 
                // â˜… åˆå¾Œè¡Œç¨‹äºŒé¸ä¸€ (æ³¡ç€¨æ¼æ¸¯ vs AEON Mall)
                time: "15:50",
                leaveTime: "17:45", 
                title: "è¡Œç¨‹äºŒé¸ä¸€", 
                type: "choice", 
                choices: [
                    {
                        title: "æ³¡ç€¨æ¼æ¸¯",
                        type: "eat",
                        // å°é¢åœ–ï¼šæµ·è†½ç„—çƒ¤é¾è¦
                        imgUrl: "https://tc.tabirai.net/sightseeing/article/img/0001484/kiji1Img.jpg", 
                        
                        guide: "åœ¨åœ°æœ€å¼·ã€Œæµ·è†½ç„—çƒ¤é¾è¦ã€ï¼ŒCPå€¼é«˜ã€‚",
                        travelTime: "é–‹è»Š 5åˆ†",
                        
                        navLink: "https://maps.app.goo.gl/ECF35foo4PgHGe1p8", 
                        reviewLink: "https://maps.app.goo.gl/whLeWZmtP8V5eXga7", 
                        link: "https://tabelog.com/okinawa/A4703/A470301/47001361/", 
                        
                        detailInfo: {
                            desc: `<b>ğŸ¦ åœ¨åœ°å…¨åï¼šæ³¡ç€¨å¸•äºæ­ç›´å£²åº—</b><br>é€™æ˜¯ä¸€å€‹å……æ»¿åœ¨åœ°æ´»åŠ›çš„æµ·é®®é£Ÿå ‚ï¼ä¸æ˜¯åƒæ°£æ°›çš„ï¼Œæ˜¯åƒ <b>CP å€¼å’Œæ–°é®®åº¦</b>çš„ã€‚å¤§å®¶ååœ¨åŠæˆ¶å¤–ä½å­å¤§å£åƒæµ·é®®ï¼Œéå¸¸æœ‰å°ç£ç†±ç‚’åº—çš„è¦ªåˆ‡æ„Ÿã€‚<br><br><b>ğŸ”¥ å¿…åƒé‡é»ï¼š</b><br>1. <b>æµ·è†½é†¬çƒ¤é¾è¦ (å¿…é»)</b>ï¼šåŠéš»æˆ–æ•´éš»é¾è¦é‹ªæ»¿ç‰¹è£½ã€Œæµ·è†½ç¾ä¹ƒæ»‹é†¬ã€çƒ¤åˆ°é‡‘é»ƒï¼Œå¥¶é¦™çˆ†ç‚¸ï¼Œè¶…ç´šç½ªæƒ¡ï¼<br>2. <b>ç‚¸å¤©å©¦ç¾…</b>ï¼šæ²–ç¹©å¼åšéºµè¡£ï¼Œè»ŸQå£æ„Ÿï¼Œé©åˆç•¶é»å¿ƒã€‚<br><br><b>âš ï¸ é‡è¦æé†’ï¼š</b>é£Ÿå ‚é€šå¸¸ <b>17:30 æœ€å¾Œé»é¤</b>ï¼Œæ™‚é–“å‰›å¥½å£“ç·šï¼Œè«‹å‹™å¿…æ³¨æ„ï¼`,
                            
                            tags: ["æµ·è†½é¾è¦", "åœ¨åœ°é£Ÿå ‚", "é«˜CPå€¼", "åŠæˆ¶å¤–"],
                            
                            highlights: [
                                "ğŸ‘‘ é®åº—ä¹‹å¯¶ï¼šæµ·è†½é†¬çƒ¤é¾è¦ (Uni Sauce Lobster)",
                                "ğŸ¤ é»å¿ƒï¼šæ²–ç¹©å¤©å©¦ç¾… (ç‚¸é­š/èŠ±æ)",
                                "ğŸ’° åƒ¹æ ¼ï¼šå®šé£Ÿç´„ Â¥3,000~Â¥5,000 (æ¯”é¤å»³ä¾¿å®œä¸€åŠ)",
                                "â° è­¦å‘Šï¼š17:30 æœ€å¾Œé»é¤ (Last Order)"
                            ],
                            
                            menu: [
                                {n: "æµ·è†½ç„—çƒ¤é¾è¦(åŠéš»)", p: "Â¥2,800~"}, 
                                {n: "æµ·è†½ç„—çƒ¤é¾è¦(æ•´éš»)", p: "Â¥5,000~"},
                                {n: "ç‚¸é­š/èŠ±æå¤©å©¦ç¾…", p: "Â¥100~"}
                            ]
                        }
                    },
                    {
                        title: "AEON Mall æ°¸æ—ºå¤¢æ¨‚åŸ",
                        type: "spot",
                        // å°é¢åœ–ï¼šAEON Rycom æ°´æ—ç®±
                        imgUrl: "https://www.welcome-aeon.com/tw/uploads/2018/09/rycom_main.jpg", 
                        
                        guide: "æ²–ç¹©æœ€å¤§è³¼ç‰©ä¸­å¿ƒï¼Œæœ‰å·¨å¤§æ°´æ—ç®±èˆ‡å¯¶å¯å¤¢ä¸­å¿ƒã€‚",
                        travelTime: "é–‹è»Š 10åˆ†",
                        
                        navLink: "https://maps.app.goo.gl/j6Z9P5yQx2x2x2x2", 
                        reviewLink: "https://maps.app.goo.gl/j6Z9P5yQx2x2x2x2", 
                        link: "https://okinawarycom-aeonmall.com/", 
                        
                        detailInfo: {
                            desc: `<b>ğŸ¢ æ²–ç¹©æœ€å¤§ï¼š</b>å¥½å¹¾æ£Ÿé€£åœ¨ä¸€èµ·ï¼Œä¸å…ˆåšåŠŸèª²æœƒè¿·è·¯ï¼é©åˆåƒå¤ªé£½ä¾†é€™è£¡ç´”èµ°è·¯é€›è¡—å¹å†·æ°£ã€‚<br><br><b>âœ¨ å¿…é€›é‡é» (æ¨“å±¤æ”»ç•¥)ï¼š</b><br>1. <b>å¯¶å¯å¤¢ä¸­å¿ƒ (1F)</b>ï¼šé–€å£æœ‰å·¨å¤§çš„ã€Œé¢¨é€Ÿç‹—ã€é›•åƒï¼Œå¾ˆå¤šç©¿èŠ±è¥¯è¡«çš„æ²–ç¹©é™å®šçš®å¡ä¸˜ã€‚<br>2. <b>å·¨å¤§æ°´æ—ç®± (1Få¤§å»³)</b>ï¼šè²«ç©¿æ¨“å±¤ï¼Œæœ‰é¯Šé­šå’Œé­Ÿé­šï¼Œå…é–€ç¥¨ï¼<br>3. <b>æ©¡å­å…±å’Œåœ‹ (4F)</b>ï¼šå‰åœåŠ›å°ˆè³£åº—ï¼Œé–€å£æœ‰å¤§é¾è²“ã€‚<br>4. <b>æƒè²¨å€</b>ï¼šBic Camera(é›»å™¨)ã€Uniqlo/GUã€AEON Style è¶…å¸‚(2F è²·æ°´æœé›¶é£Ÿ)ã€‚<br><br><b>ğŸ“ æ²–ç¹©è¶…äººæˆ°ç•¥ï¼š</b><br><b>ğŸš— åœè»Š</b>ï¼šå…è²»ï¼å»ºè­°åœåœ¨<b>ã€Œ1F é è¿‘æ°´æ—ç®±å…¥å£ã€</b>ï¼Œæ¬è²¨æœ€æ–¹ä¾¿ã€‚<br><b>ğŸ’° é€€ç¨…</b>ï¼šè¨˜å¾—å¸¶è­·ç…§ï¼æœ‰äº›åº—å…§é€€ï¼Œæœ‰äº›è¦å» 1F å…ç¨…æ«ƒå°çµ±é€€ã€‚`,
                            
                            tags: ["å¯¶å¯å¤¢ä¸­å¿ƒ", "æ°´æ—ç®±", "é›¨å¤©å‚™æ¡ˆ", "å…è²»åœè»Š"],
                            
                            highlights: [
                                "âš¡ï¸ 1Fï¼šå¯¶å¯å¤¢ä¸­å¿ƒ (Pokemon Center)",
                                "ğŸ  1Fï¼šRycom Aquarium (å·¨å¤§æ°´æ—ç®±)",
                                "ğŸ¬ 4Fï¼šæ©¡å­å…±å’Œåœ‹ (å‰åœåŠ›)",
                                "ğŸ¥© ç¾é£Ÿï¼šIKINARI ç«‹é£Ÿç‰›æ’ / è è˜¿éºµåŒ…"
                            ],
                            
                            menu: [
                                {n: "IKINARI STEAK", p: "ç§¤é‡è¨ˆåƒ¹"},
                                {n: "ç¾çƒ¤å†°æ·‡æ·‹è è˜¿éºµåŒ…", p: "Â¥450"},
                                {n: "Blue Seal å†°æ·‡æ·‹", p: "Â¥350"}
                            ]
                        }
                    }
                ],
                // â˜… ä¿®æ”¹è™•ï¼šäº¤é€šæ™‚é–“æ”¹ç‚º 10åˆ†
                travel: { mode: 'drive', time: '10åˆ†' } 
            },
            { 
                time: "18:00", 
                leaveTime:"19:30",
                title: "æ™šé¤ï¼šé˜¿å¤è±¬é‹", 
                type: "eat", 
                title_detail: "Chatan Dining Chaabu", 
                
                imgUrl: "https://image.kkday.com/v2/image/get/s1.kkday.com/product_213611/20240924093422_j80Uu/png",
                
                guide: "åœ¨åœ°äººç§æˆ¿ååº—ï¼Œå¿…åƒé˜¿å¤è±¬æ¶®æ¶®é‹æ²¾é¦™æª¸é†‹é†¬ã€‚", 
                
                navLink: "https://maps.app.goo.gl/YtcRzAkFkNEH64Un8",
                reviewLink: "https://maps.app.goo.gl/nfRWvwG4nLVuNUhC6",
                link: "https://tabelog.com/okinawa/A4703/A470304/47002631/",
                
                mapCode: "33 526 212*25", 
                
                bookingInfo: { 
                    code: "3JYNWGHFKM", 
                    note: "Tabelog é ç´„", 
                    // â˜… é—œéµï¼šé€™å€‹ driveLink å¿…é ˆå­˜åœ¨ï¼ŒæŒ‰éˆ•æ‰æœƒé¡¯ç¤º
                    driveLink: "https://drive.google.com/file/d/1aC-aVfvv4iy578apmaEv9HksOD-rzjOt/view?usp=drive_link"
                }, 
                
                detailInfo: { 
                    desc: `<b>ğŸ· åœ¨åœ°ç§æˆ¿åå–®ï¼š</b><br>æ¯”èµ·è§€å…‰æ’éšŠååº—ï¼Œé€™å®¶æ›´æº«é¦¨ï¼ä¸»æ‰“é˜¿å¤è±¬çš„æ¥µè‡´äº«å—ï¼Œè„‚è‚ªçœ‹èµ·ä¾†è‚¥ä½†åƒèµ·ä¾†æ˜¯<b>è„†å£ä¸”å¸¶æœ‰æ¿ƒæ¿ƒç”œå‘³</b>ï¼Œå®Œå…¨ä¸è†©ã€‚<br><br><b>ğŸ² å¿…é»æ‹›ç‰Œï¼šé˜¿å¤è±¬æ¶®æ¶®é‹</b><br>æ¹¯é ­æ˜¯ç°¡å–®çš„æ˜†å¸ƒ/é°¹é­šæ¸…æ¹¯ï¼Œå› ç‚ºè‚‰è³ªå¤ å¥½ï¼<br><b>ğŸ’¡ å…§è¡Œåƒæ³•ï¼š</b>è‚‰ç‰‡ç²‰ç´…è‰²æ™‚ä¸‹é‹ï¼Œ<b>æ¶® 3-5 ç§’</b>è®Šç™½å°±å¥½ï¼Œæ²¾ç‰¹è£½çš„<b>ã€ŒShikuwasa (æ²–ç¹©é¦™æª¸) é†‹é†¬ã€</b>ï¼Œé…¸ç”œæœé¦™é…ä¸Šæ²¹è„‚ç”œå‘³ï¼Œè¶…ç´šæ­ï¼<br><br><b>â™¨ï¸ æ¸…çˆ½é¸æ“‡ï¼šè’¸ç± é˜¿å¤è±¬</b><br>æ€•ç†±å¯ä»¥é»é€™å€‹ï¼è‚‰é‹ªåœ¨è”¬èœä¸Šè’¸ï¼Œæ²¹è„‚æ»´å…¥è”¬èœï¼Œæ¸…çˆ½å¥åº·ã€‚<br><br><b>ğŸ  æ°›åœï¼š</b>æº«é¦¨æ—¥å¼å®¶åº­é¢¨ï¼Œæœ‰<b>ã€Œå €å¼æš–æ¡Œã€</b>(è…³å¯ä»¥ä¼¸ç›´çš„æ¦»æ¦»ç±³)ï¼Œå¾ˆæ”¾é¬†ã€‚`, 
                    tags: ["é˜¿å¤è±¬", "æ¶®æ¶®é‹", "åœ¨åœ°ç§æˆ¿", "å €å¼æš–æ¡Œ"], 
                    highlights: [
                        "ğŸ‘‘ å¿…åƒï¼šé˜¿å¤è±¬æ¶®æ¶®é‹ (æ¶®3-5ç§’!)",
                        "ğŸ‹ éˆé­‚ï¼šç‰¹è£½é¦™æª¸é†‹é†¬ (è§£è†©ç¥å™¨)",
                        "â™¨ï¸ æ¨è–¦ï¼šè’¸ç± é˜¿å¤è±¬ (Seiro-mushi)",
                        "ğŸ¥¢ åŠ é»ï¼šæµ·è‘¡è„ã€ç‚¸ç´…èŠ‹å¤©å©¦ç¾…"
                    ],
                    menu: [
                        {n: "é˜¿å¤è±¬æ¶®æ¶®é‹", p: "Â¥3,500~"}, 
                        {n: "é˜¿å¤è±¬è’¸ç± æ–™ç†", p: "Â¥3,500~"},
                        {n: "æµ·è‘¡è„", p: "Â¥600"}
                    ] 
                }, 
                
                travel: { mode: 'drive', time: '10åˆ†' } 
            },
            { 
                time: "19:40", title: "ç¾æ¿±æ—¥è½åº¦å‡é£¯åº—", type: "hotel", title_detail: "Sunset Resort Mihama", mapCode: "33 525 205*74", 
                bookingInfo: { 
                    code: "1616323760441360", 
                    note: "PIN: 1047", 
                    extra: "å·²ä»˜ Â¥9,424", 
                    driveLink: "https://drive.google.com/file/d/16zfKPiZBPPBFJyARHDH503a85w6vEmJi/view?usp=drive_link"
                } 
            },
            { time: "20:10", title: "ç¾åœ‹æ‘é€›é€›", type: "spot", mapCode: "33 526 450*63", guide: "å¯ä»¥å»å¤§åœ‹è—¥å¦è£œè²¨ï¼Œæ‘©å¤©è¼ªæ‹ç…§ã€‚" }
        ]
    },
    {
        date: "12/27ğŸ†", fullDate: "2025/12/27", day: "é€±å…­", weather: "â›… 22Â°C",
        events: [
            { time: "06:00", title: "èµ·åºŠ", type: "prep", guide: "æ—©é¤å¤–é¢è²·ï¼Œè»Šä¸Šåƒã€‚", departureTime: "07:30 å‡ºç™¼å¾€åŒ—éƒ¨", travel: { mode: 'drive', time: '45åˆ†' } },
            { time: "08:30", title: "è¨±ç”°ä¼‘æ¯ç«™", type: "spot", mapCode: "206 476 706*66", guide: "å¿…åƒï¼šç‚¸å¤©å©¦ç¾…ã€é»‘ç³–çƒã€‚", travel: { mode: 'drive', time: '30åˆ†' } },
            { time: "09:45", title: "Panchori-na éºµåŒ…åº—", type: "eat", guide: "å¯æ„›éºµåŒ…åº—ï¼Œåœç•™ 30 åˆ†é˜ã€‚", travel: { mode: 'drive', time: '30åˆ†' } },
            { time: "11:00", title: "åˆé¤ï¼šè¦è¦é£¯", type: "eat", mapCode: "485 692 167*55", detailInfo: { desc: "å¤å®‡åˆ©å³¶å¿…åƒï¼å»ºè­°å…ˆæ‰¾åº§ä½ã€‚", tags: ["æµ·æ™¯", "è¦é£¯"], menu: [{n:"åŸå‘³å¤§è’œè¦é£¯", p:"Â¥1,400"}] }, travel: { mode: 'drive', time: '40åˆ†' } },
            { time: "13:20", title: "ç¾éº—æµ·æ°´æ—é¤¨", type: "spot", mapCode: "553 075 797*77", detailInfo: { desc: "äºæ´²æœ€å¤§æ°´æ—é¤¨ä¹‹ä¸€ï¼Œé»‘æ½®ä¹‹æµ·å¿…çœ‹ã€‚", tags: ["é¯¨é¯Š", "æµ·è±šç§€"], highlights: ["é»‘æ½®ä¹‹æµ·", "æˆ¶å¤–æµ·è±šåŠ‡å ´"] }, travel: { mode: 'drive', time: '50åˆ†' } },
            { 
                time: "17:00", title: "æ™šé¤ï¼šObaa no Ya ç‡’è‚‰", type: "eat", title_detail: "Obaa no Ya (åè­·ç‡’è‚‰)", mapCode: "206 598 371*14", 
                bookingInfo: { 
                    code: "2QZLY2AV4K", 
                    note: "Tabelog é ç´„", 
                    driveLink: "https://drive.google.com/file/d/18WY990jEKlkvz1VmGCljkT07xTVBNPle/view?usp=drive_link"
                }, 
                detailInfo: { desc: "åè­·äººæ°£ç‡’è‚‰ï¼Œç‚­ç«ç‡’çƒ¤é¢¨å‘³çµ•ä½³ã€‚", tags: ["ç‡’è‚‰", "å’Œç‰›"], menu: [{n:"ç‰¹ä¸Šç‰›äº”èŠ±", p:"Â¥1,800"}] }, travel: { mode: 'drive', time: '40åˆ†' } 
            },
            { time: "20:00", title: "ç¾åœ‹æ‘ç…™ç«", type: "spot", guide: "é€±å…­é™å®šï¼è§€è³é»ï¼šåŒ—è°·æ—¥è½æ­¥é“ã€‚" }
        ]
    },
    {
        date: "12/28", fullDate: "2025/12/28", day: "é€±æ—¥", weather: "ğŸŒ§ï¸ 20Â°C",
        events: [
            { time: "06:00", title: "èµ·åºŠ & é€€æˆ¿", type: "prep", guide: "11:00 å‰é€€æˆ¿ã€‚", departureTime: "07:30 å‡ºç™¼", travel: { mode: 'drive', time: '30åˆ†' } },
            { time: "08:00", title: "æ—©é¤ï¼šA&W æ¼¢å ¡", type: "eat", mapCode: "33 341 602*66", guide: "å¿…é» Root Beer (æ²™å£«)ã€‚", travel: { mode: 'drive', time: '30åˆ†' } },
            { time: "09:30", title: "ç€¨é•·å³¶ Umikaji", type: "spot", mapCode: "33 002 605*15", guide: "å¸Œè‡˜é¢¨æƒ…ç™½è‰²å»ºç¯‰ï¼Œçœ‹é£›æ©Ÿèµ·é™ã€‚", travel: { mode: 'drive', time: '30åˆ†' } },
            { time: "11:30", title: "åˆé¤ï¼šæ²–ç¹©éºµ / ç¾©å¤§åˆ©éºµ", type: "eat", guide: "Yagiya (æ²–ç¹©éºµ) æˆ– The Slow (ç¾©å¤§åˆ©éºµ)ã€‚", travel: { mode: 'drive', time: '20åˆ†' } },
            { time: "12:30", title: "Shinmei Coffee", type: "eat", guide: "å¤æ°‘å®¶å’–å•¡ï¼Œæ¨è–¦é»‘ç³–æ‹¿éµã€‚", travel: { mode: 'drive', time: '20åˆ†' } },
            { time: "14:00", title: "ç‰æ³‰æ´ (ç‹åœ‹æ‘)", type: "spot", mapCode: "232 495 330*28", guide: "é˜ä¹³çŸ³æ´ï¼Œå‡ºä¾†çœ‹å¤ªé¼“è¡¨æ¼”ã€‚", travel: { mode: 'drive', time: '20åˆ†' } },
            { time: "17:00", title: "å¥§æ­¦å³¶ (è²“å³¶)", type: "spot", mapCode: "232 468 336*41", guide: "å¿…è²·ï¼šä¸­æœ¬é®®é­šåº—å¤©å©¦ç¾…ã€‚", travel: { mode: 'drive', time: '15åˆ†' } },
            { 
                time: "17:30", title: "Gangalaä¹‹è°· å°è¦½", type: "spot", mapCode: "232 495 330*28", 
                bookingInfo: { 
                    code: "0Y0BGC4I", 
                    note: "Nutmeg é ç´„", 
                    driveLink: "https://drive.google.com/file/d/1INEKGZkeFmle8EsCNkY7BCETvtdZUgpt/view?usp=drive_link"
                }, 
                detailInfo: { desc: "å¤ªå¤æ£®æ—å°è¦½ï¼Œé›†åˆæ™‚é–“ 17:30ã€‚", tags: ["è‡ªç„¶", "å°è¦½"], highlights: ["å·¨å¤§æ¦•æ¨¹", "CAVE CAFE"] }, travel: { mode: 'drive', time: '40åˆ†' } 
            },
            { 
                time: "20:00", title: "æ±æ©«INN é‚£éœ¸æ—­æ©‹", type: "hotel", mapCode: "33 126 733*12",
                bookingInfo: { 
                    code: "5892799 / 5892800", 
                    note: "æœƒå“¡å¡ (ç¾å ´ä»˜)" 
                } 
            },
            { time: "21:00", title: "AEON è¶…å¸‚ / åœ‹éš›é€š", type: "spot", guide: "è²·åŠåƒ¹å“ã€é›¶é£Ÿä¼´æ‰‹ç¦®ã€‚" }
        ]
    },
    {
        date: "12/29", fullDate: "2025/12/29", day: "é€±ä¸€", weather: "â˜€ï¸ 23Â°C",
        events: [
            { time: "07:00", title: "èµ·åºŠ & æ—©é¤", type: "prep", guide: "é£¯åº—æ—©é¤ã€‚10:00 å‰é€€æˆ¿ã€‚", departureTime: "10:30 å‡ºç™¼", travel: { mode: 'drive', time: '20åˆ†' } },
            { time: "10:30", title: "Ashibinaa Outlet", type: "spot", mapCode: "232 544 452*22", guide: "é‹å‹•å“ç‰Œã€GAP éƒ½å¾ˆä¾¿å®œã€‚", travel: { mode: 'drive', time: '15åˆ†' } },
            { time: "13:30", title: "OTS é‚„è»Š", type: "trans", guide: "åŠ æ»¿æ²¹å†é‚„è»Šï¼æ­æ¥é§è»Šå»æ©Ÿå ´ã€‚", travel: { mode: 'trans', time: '20åˆ†' } },
            { time: "14:30", title: "æ©Ÿå ´åˆé¤", type: "eat", guide: "è±¬è‚‰è›‹é£¯ç³°ã€‚" },
            { 
                time: "16:55", title: "å›ç¨‹é£›æ©Ÿ (FD231)", type: "trans", title_detail: "æ³°åœ‹äºèˆª FD231", 
                bookingInfo: { 
                    code: "1616324336315022", 
                    note: "Trip.com", 
                    extra: "é‚£éœ¸æ©Ÿå ´ I | 20kg è¨—é‹ / 7kg æ‰‹æ",
                    driveLink: "https://drive.google.com/file/d/1iScNq9RHqi_l-JYoXhKnhk8Btu-4gTaG/view?usp=drive_link" 
                }, 
                guide: "é‚£éœ¸ I -> æ¡ƒæ©Ÿ T1ã€‚ææ—© 2.5 å°æ™‚åˆ°ã€‚" 
            }
        ]
    }
];

        // --- 4. æ ¸å¿ƒé‚è¼¯ ---
       function init() {
    if (!currentRole) {
        document.getElementById('role-selector').classList.remove('hidden');
        document.getElementById('role-selector').classList.add('flex');
    } else {
        // --- 1. æ¢å¾©ä¸Šæ¬¡ç€è¦½ç‹€æ…‹ ---
        const lastTab = sessionStorage.getItem('lastTab');
        const lastDateIdx = sessionStorage.getItem('lastDateIdx');
        const lastScrollY = sessionStorage.getItem('lastScrollY');

        // æ¢å¾©æ—¥æœŸé¸æ“‡
        if (lastDateIdx !== null) selectedDateIndex = parseInt(lastDateIdx);
        
        // æ¢å¾©åˆ†é  (å¦‚æœæ²’æœ‰ç´€éŒ„ï¼Œé è¨­ç‚º home)
        if (lastTab) {
            currentTab = lastTab;
            // æ›´æ–°åº•éƒ¨å°èˆªæŒ‰éˆ•æ¨£å¼
            document.querySelectorAll('.nav-item').forEach(btn => { 
                btn.classList.remove('active', 'text-orange-500'); 
                btn.classList.add('text-gray-400'); 
            }); 
            if (currentTab !== 'home') {
                const btn = document.getElementById(`btn-${currentTab}`);
                if(btn) btn.classList.replace('text-gray-400', 'text-orange-500');
            }
        }

        // æ ¹æ“šåˆ†é æ¸²æŸ“å…§å®¹
        if (currentTab === 'schedule') renderSchedule();
        else if (currentTab === 'shopping') renderShopping();
        else if (currentTab === 'budget') renderBudget();
        else if (currentTab === 'vouchers') renderVouchers();
        else renderHome();

        setupRealtimeListeners();

        // --- 2. æ¢å¾©æ²å‹•ä½ç½® (å»¶é²åŸ·è¡Œï¼Œç­‰å¾…ç•«é¢æ¸²æŸ“å®Œç•¢) ---
        if (lastScrollY) {
            setTimeout(() => {
                window.scrollTo(0, parseInt(lastScrollY));
            }, 100); // 100æ¯«ç§’å¾Œæ²å‹•ï¼Œç¢ºä¿å…§å®¹å·²é•·å‡ºä¾†
        }
    }

    // Auto Calc for Budget (ä¿æŒåŸæœ‰é‚è¼¯)
    const exPrice = document.getElementById('in-ex-price');
    const exQty = document.getElementById('in-ex-qty');
    if (exPrice && exQty) {
        function updateExTotal() {
            const p = parseInt(exPrice.value) || 0;
            const q = parseInt(exQty.value) || 1;
            const total = p * q;
            document.getElementById('calc-total').innerText = total.toLocaleString();
            document.getElementById('calc-twd').innerText = Math.round(total * JPY_RATE).toLocaleString();
        }
        exPrice.addEventListener('input', updateExTotal);
        exQty.addEventListener('input', updateExTotal);
    }
}

        function selectRole(role) {
            currentRole = role; localStorage.setItem('user_role', role);
            document.getElementById('role-selector').classList.add('hidden');
            document.getElementById('role-selector').classList.remove('flex');
            renderHome();
            const roleIcons = { driver: 'ğŸš—', copilot: 'ğŸ—ºï¸', tourist: 'ğŸ“¸', admin: 'ğŸ“' };
            document.getElementById('header-icon').innerText = roleIcons[role] || 'ğŸ¦';
        }
        function clearRole() { localStorage.removeItem('user_role'); location.reload(); }
        function setupRealtimeListeners() { if(db) { db.ref('shoppingList').on('value', () => { if(currentTab === 'shopping') renderShopping(); }); db.ref('expenses').on('value', () => { if(currentTab === 'budget') renderBudget(); }); } }

       // --- Render: Home ---
function renderHome() {
    const container = document.getElementById('app');
    const now = currentSimulatedDate ? new Date(currentSimulatedDate) : new Date();
    const todayStr = `${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()}`;
    const tripIndex = tripData.findIndex(d => d.fullDate === todayStr);
    const displayData = tripIndex !== -1 ? tripData[tripIndex] : tripData[0];
    const displayIndex = tripIndex !== -1 ? tripIndex : 0;
    const nextEvent = displayData.events[0];
    const roleIcons = { driver: 'ğŸš—', copilot: 'ğŸ—ºï¸', tourist: 'ğŸ“¸', admin: 'ğŸ“' };
    document.getElementById('header-icon').innerText = roleIcons[currentRole] || 'ğŸ¦';

    // åˆ¤æ–·æ˜¯å¦ç‚ºå‡ºç™¼å‰
    const isBeforeTrip = now < new Date("2025-12-25T00:00:00");
    
    let packingHtml = '';
    let prepHtml = ''; // â˜… æ–°å¢è®Šæ•¸

    if (isBeforeTrip) { 
        prepHtml = getPrepListHTML();     // â˜… ç”Ÿæˆäº‹å‰æº–å‚™ HTML
        packingHtml = getPackingListHTML(); 
    }

    const nextEventHtml = createEventCard(nextEvent, displayIndex, 0);

    container.innerHTML = `
        <div class="card p-4 mb-4 bg-gradient-to-r from-blue-50 to-white"><div class="flex justify-between items-center mb-3"><h3 class="font-bold text-gray-700">â˜€ï¸ ä»Šæ—¥å¤©æ°£ (é‚£éœ¸)</h3><span id="sunset-time" class="text-xs text-orange-600 font-bold"></span></div><div id="weather-scroll" class="weather-scroll flex gap-4"><div class="flex items-center gap-2 text-gray-400 text-sm"><i class="fa-solid fa-spinner fa-spin"></i> è¼‰å…¥ä¸­...</div></div></div>
        
        ${prepHtml}   <!-- â˜… æ’å…¥äº‹å‰æº–å‚™æ¸…å–® -->
        ${packingHtml}
        
        <div class="mb-4 flex justify-between items-center"><h3 class="font-bold text-gray-700">ğŸ“… ä»Šæ—¥æ¦‚è¦½ (${displayData.date})</h3></div>
        ${nextEventHtml}
        <div class="mt-6"><h3 class="font-bold text-gray-700 mb-3">ğŸ†˜ æ±‚ç”Ÿå·¥å…·ç®±</h3><div class="grid grid-cols-4 gap-2 text-center"><a href="https://www.google.com/maps/search/nearby+convenience+store" target="_blank" class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 active:scale-95 transition"><div class="text-2xl mb-1">ğŸª</div><div class="text-[10px] text-gray-600 font-bold">æ‰¾è¶…å•†</div></a><a href="https://www.google.com/maps/search/nearby+toilet" target="_blank" class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 active:scale-95 transition"><div class="text-2xl mb-1">ğŸš½</div><div class="text-[10px] text-gray-600 font-bold">æ‰¾å»æ‰€</div></a><a href="https://www.google.com/maps/search/nearby+gas+station" target="_blank" class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 active:scale-95 transition"><div class="text-2xl mb-1">â›½</div><div class="text-[10px] text-gray-600 font-bold">æ‰¾åŠ æ²¹</div></a><button onclick="openTranslation()" class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 active:scale-95 transition"><div class="text-2xl mb-1">ğŸ—£ï¸</div><div class="text-[10px] text-gray-600 font-bold">æ—¥èªå¡</div></button></div></div>
        <div class="mt-6 mb-20"><h3 class="font-bold text-gray-700 mb-3">ğŸ® 12æœˆé™å®šæ´»å‹•</h3><div class="flex gap-4 overflow-x-auto snap-x-mandatory hide-scrollbar pb-4 px-1">${okinawaEvents.map(ev => `<a href="${ev.link}" target="_blank" class="block min-w-[200px] bg-white rounded-xl border border-orange-100 shadow-sm snap-center active:scale-95 transition overflow-hidden"><div class="h-24 bg-gray-200 bg-cover bg-center" style="background-image: url('${ev.img}')"></div><div class="p-3"><div class="text-xs text-orange-500 font-bold mb-1">${ev.date}</div><div class="font-bold text-gray-800 text-sm truncate">${ev.title}</div><div class="text-xs text-gray-400 mt-1"><i class="fa-solid fa-location-dot"></i> ${ev.loc}</div></div></a>`).join('')}</div></div>
    `;
    document.getElementById('header-desc').innerText = "é¦–é æ¦‚è¦½";
    updateWeatherUI();
}

       // --- Render: Schedule (ä¿®æ­£äº¤é€šæ™‚é–“é¡¯ç¤ºå•é¡Œ) ---
function renderSchedule() {
    const container = document.getElementById('app');
    document.getElementById('header-desc').innerText = "è¡Œç¨‹ç¸½è¦½";
    
    // 1. æ—¥æœŸé¸å–®
    let tabsHtml = `<div class="date-scroll flex gap-2 sticky-date-bar">`;
    
    tripData.forEach((d, idx) => { 
        const active = idx === selectedDateIndex ? 'active' : 'bg-white text-gray-500 border border-gray-200'; 
        tabsHtml += `
            <button onclick="changeDate(${idx})" class="date-tab ${active} px-4 py-2 rounded-full min-w-[90px] text-center transition shadow-sm flex-shrink-0">
                <div class="text-xs opacity-80">${d.day}</div>
                <div class="font-bold text-lg leading-tight">${d.date}</div>
            </button>`; 
    });
    tabsHtml += `</div>`;
    
    const dayData = tripData[selectedDateIndex];
    let eventsHtml = `<div class="space-y-4 animation-fade pb-12">`;
    
    dayData.events.forEach((event, eIdx) => {
        // æ’å…¥å¡ç‰‡ HTML
        eventsHtml += createEventCard(event, selectedDateIndex, eIdx);
        
        // 2. äº¤é€šé€£æ¥ç·š
        // â˜… ä¿®æ”¹ï¼šç§»é™¤äº† event.type !== 'choice' çš„é™åˆ¶
        // åªè¦æœ‰ travel è³‡æ–™ï¼Œä¸”ä¸æ˜¯æœ€å¾Œä¸€å€‹è¡Œç¨‹ï¼Œå°±é¡¯ç¤ºé€£æ¥ç·š
        if (event.travel && eIdx < dayData.events.length - 1) {
            let icon = 'fa-car'; 
            if(event.travel.mode === 'walk') icon = 'fa-person-walking'; 
            if(event.travel.mode === 'train') icon = 'fa-train-subway'; 
            if(event.travel.mode === 'plane') icon = 'fa-plane';
            
            eventsHtml += `
            <div class="flex flex-col items-center -my-3 z-0 relative">
                <div class="h-3 w-0.5 bg-gray-300 border-l border-dashed border-gray-400"></div>
                <div class="bg-white text-gray-500 text-[10px] font-bold px-2 py-0.5 rounded-full border border-gray-200 shadow-sm flex items-center gap-1 z-10">
                    <i class="fa-solid ${icon}"></i> ${event.travel.time}
                </div>
                <div class="h-3 w-0.5 bg-gray-300 border-l border-dashed border-gray-400"></div>
            </div>`;
        }
    });
    eventsHtml += `</div>`;
    
    container.innerHTML = tabsHtml + eventsHtml;
}

        // --- Render: Vouchers ---
function renderVouchers() {
    document.getElementById('header-desc').innerText = "é ç´„æ†‘è­‰å¤¾";
    const container = document.getElementById('app');
    let infoHtml = `<div class="card p-5 mb-4 border-l-4 border-red-500 bg-red-50"><h3 class="font-bold text-red-700 mb-3"><i class="fa-solid fa-triangle-exclamation"></i> ç·Šæ€¥è¯çµ¡</h3><div class="grid grid-cols-2 gap-3 text-sm"><a href="tel:110" class="bg-white p-2 rounded text-center shadow text-gray-700 font-bold"><i class="fa-solid fa-phone mr-1"></i> å ±è­¦ 110</a><a href="tel:119" class="bg-white p-2 rounded text-center shadow text-gray-700 font-bold"><i class="fa-solid fa-truck-medical mr-1"></i> æ•‘è­· 119</a><div class="col-span-2 bg-white p-2 rounded shadow text-gray-700 text-xs"><div>å¤–äº¤éƒ¨æ—…å¤–æ•‘åŠ©ï¼š+81-80-1009-7179</div></div></div></div>`;
    let vouchersHtml = `<div class="space-y-4">`;
    tripData.forEach(day => {
        day.events.forEach(event => {
            if (event.bookingInfo) {
                let linkBtn = '';
                const fullText = (event.bookingInfo.note + (event.bookingInfo.extra || '')).toLowerCase();
                if (fullText.includes('trip.com')) linkBtn = `<a href="https://trip.com" target="_blank" class="mt-3 block w-full text-center bg-blue-50 text-blue-600 py-2 rounded-lg font-bold text-sm hover:bg-blue-100 transition border border-blue-100"><i class="fa-solid fa-arrow-up-right-from-square mr-1"></i> é–‹å•Ÿ Trip.com </a>`;
                else if (fullText.includes('nutmeg')) linkBtn = `<a href="https://ntmg.jp/" target="_blank" class="mt-3 block w-full text-center bg-green-50 text-green-600 py-2 rounded-lg font-bold text-sm hover:bg-green-100 transition border border-green-100"><i class="fa-solid fa-arrow-up-right-from-square mr-1"></i> é–‹å•Ÿ Nutmeg è¨‚å–®</a>`;
                else if (fullText.includes('tabelog')) linkBtn = `<a href="https://tabelog.com/" target="_blank" class="mt-3 block w-full text-center bg-yellow-50 text-yellow-600 py-2 rounded-lg font-bold text-sm hover:bg-yellow-100 transition border border-yellow-100"><i class="fa-solid fa-arrow-up-right-from-square mr-1"></i> é–‹å•Ÿ Tabelog</a>`;
                
                let voucherBtn = '';
                if (event.bookingInfo.driveLink) {
                    voucherBtn = `<button onclick="openVoucherImage('${event.bookingInfo.driveLink}')" class="mt-2 w-full bg-red-50 text-red-600 py-2 rounded text-xs font-bold border border-red-100 hover:bg-red-100 transition"><i class="fa-solid fa-file-pdf mr-1"></i> æŸ¥çœ‹æ†‘è­‰ (PDF)</button>`;
                } else if (event.bookingInfo.pdfContent) {
                    voucherBtn = `<button onclick="openPdfModal('${encodeURIComponent(event.bookingInfo.pdfContent)}')" class="mt-2 w-full bg-red-50 text-red-600 py-2 rounded text-xs font-bold border border-red-100 hover:bg-red-100 transition"><i class="fa-solid fa-file-lines mr-1"></i> é è¦½æ†‘è­‰å…§å®¹</button>`;
                }

                vouchersHtml += `
                    <div class="card p-5 border-l-4 border-orange-500 shadow-sm bg-white">
                        <div class="flex justify-between items-start mb-2"><h3 class="font-bold text-lg text-gray-800">${event.title}</h3><span class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-500">${day.date}</span></div>
                        <div class="text-sm text-gray-600 mb-3">${event.bookingInfo.note}</div>
                        <div class="bg-gray-50 p-3 rounded border border-gray-200 dashed mb-3 relative group active:bg-orange-50 transition"><div class="text-xs text-gray-400 mb-1">è¨‚å–®ç·¨è™Ÿ / PIN</div><div class="text-xl font-mono font-bold text-gray-800 select-all break-all">${event.bookingInfo.code}</div><div class="absolute right-2 top-2 text-gray-300"><i class="fa-regular fa-copy"></i></div></div>
                        ${event.bookingInfo.extra ? `<div class="text-xs text-orange-600 font-bold text-right mb-3">${event.bookingInfo.extra}</div>` : ''}
                        ${voucherBtn}
                        ${linkBtn}
                    </div>`;
            }
        });
    });
    
    const prepHtml = getPrepListHTML();     // â˜… ç”Ÿæˆäº‹å‰æº–å‚™ HTML
    const packingHtml = getPackingListHTML();
    
    container.innerHTML = infoHtml + 
        `<div class="text-gray-500 text-sm mb-2 px-2">é ç´„æ†‘è­‰</div>` + vouchersHtml + 
        `<div class="mt-8 text-gray-500 text-sm mb-2 px-2">è¡Œå‰æº–å‚™</div>` + prepHtml + 
        `<div class="mt-4 text-gray-500 text-sm mb-2 px-2">éš¨æ™‚æª¢æŸ¥</div>` + packingHtml + 
        `</div>`;
}

        // --- Render: Shopping ---
        function renderShopping() {
            document.getElementById('header-desc').innerText = "è³¼ç‰©æ¸…å–®";
            const container = document.getElementById('app');
            
            let html = `
                <button onclick="openEditShopModal()" class="fab-btn"><i class="fa-solid fa-plus"></i></button>
                <div id="shopping-controls" class="sticky-filters"></div>
                <div id="shopping-list-container" class="space-y-4 pb-24">
                    <div class="text-center text-gray-400 py-4"><i class="fa-solid fa-spinner fa-spin"></i> è¼‰å…¥ä¸­...</div>
                </div>`;
            container.innerHTML = html;

            const loadData = (data) => {
                const listContainer = document.getElementById('shopping-list-container');
                const controlsContainer = document.getElementById('shopping-controls');

                if(!data) { 
                    controlsContainer.style.display = 'none';
                    listContainer.innerHTML = '<div class="text-center text-gray-400 mt-10">æ¸…å–®æ˜¯ç©ºçš„ï¼Œé»æ“Š + æ–°å¢</div>'; 
                    return; 
                }

                const allEntries = Array.isArray(data) ? data.map((item, i) => [`local_${i}`, item]) : Object.entries(data);
                
                const categories = new Set();
                const stores = new Set();
                allEntries.forEach(([_, item]) => {
                    if(item.category) categories.add(item.category);
                    if(item.store) stores.add(item.store);
                });

                const catOptions = Array.from(categories).map(c => `<option value="${c}" ${currentCategoryFilter===c?'selected':''}>${c}</option>`).join('');
                const storeOptions = Array.from(stores).map(s => `<option value="${s}" ${currentStoreFilter===s?'selected':''}>${s}</option>`).join('');

                controlsContainer.style.display = 'block';
                controlsContainer.innerHTML = `
                    <div class="filter-row">
                        <div class="flex gap-2 overflow-x-auto pb-1 hide-scrollbar">
                            <select class="filter-select" onchange="updateFilter('category', this.value)">
                                <option value="all">å…¨éƒ¨ç¨®é¡</option>
                                ${catOptions}
                            </select>
                            <select class="filter-select" onchange="updateFilter('store', this.value)">
                                <option value="all">å…¨éƒ¨åº—èˆ–</option>
                                ${storeOptions}
                            </select>
                        </div>
                        <div class="rate-badge"><i class="fa-solid fa-calculator mr-1"></i>åŒ¯ç‡ ${JPY_RATE}</div>
                    </div>`;

                const filteredEntries = allEntries.filter(([_, item]) => {
                    const catMatch = currentCategoryFilter === 'all' || item.category === currentCategoryFilter;
                    const storeMatch = currentStoreFilter === 'all' || item.store === currentStoreFilter;
                    return catMatch && storeMatch;
                });

                if (filteredEntries.length === 0) {
                    listContainer.innerHTML = '<div class="text-center text-gray-400 py-8">æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„å•†å“</div>';
                    return;
                }
                
                let itemsHtml = '';
                filteredEntries.reverse().forEach(([key, item]) => {
                    let savingsInfo = '';
                    let twdEstimate = 0;
                    if (item.priceJp) { 
                        twdEstimate = Math.round(parseInt(item.priceJp) * JPY_RATE); 
                        if (item.priceTw) { 
                            const priceTw = parseInt(item.priceTw); 
                            const diff = priceTw - twdEstimate;
                            if (diff > 0) savingsInfo = `<span class="ml-2 text-xs bg-red-100 text-red-600 px-1.5 py-0.5 rounded font-bold">çœ $${diff}</span>`; 
                            else if (diff < 0) savingsInfo = `<span class="ml-2 text-xs bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded">è²´ $${Math.abs(diff)}</span>`;
                        } 
                    } 

                    let imgSource = '';
                    if (item.imgUrl) { 
                        let rawUrl = item.imgUrl.startsWith('http') ? item.imgUrl : `./${item.imgUrl}`;
                        imgSource = getDirectImageUrl(rawUrl); 
                    }
                    
                    let imgBoxContent = '';
                    let clickAction = '';
                    let boxClass = 'shop-img-box';

                    if (imgSource) {
                        imgBoxContent = `<img src="${imgSource}" onerror="this.style.display='none'">`;
                        clickAction = `onclick="openVoucherImage('${imgSource}')"`;
                    } else {
                        boxClass += ' no-image';
                    }

                    itemsHtml += `
                        <div class="card p-4 flex gap-4 bg-white items-center ${item.done ? 'opacity-60' : ''}">
                            <div>
                                <input type="checkbox" onchange="toggleShopItem('${key}')" class="w-6 h-6 accent-blue-600 border-2 border-blue-600 rounded cursor-pointer" ${item.done ? 'checked' : ''}>
                            </div>
                            <div class="${boxClass}" ${clickAction}>${imgBoxContent}</div>
                            <div class="flex-1 flex flex-col justify-between min-w-0 self-stretch">
                                <div class="flex justify-between items-start mb-1">
                                    <span class="text-xs text-blue-600 border border-blue-200 bg-blue-50 px-2 py-0.5 rounded">${item.category || 'æœªåˆ†é¡'}</span>
                                    <button onclick="deleteShopItem('${key}')" class="text-gray-800 hover:text-red-500 transition"><i class="fa-solid fa-trash-can"></i></button>
                                </div>
                                <div class="mb-3">
                                    <h3 class="font-bold text-gray-800 text-lg leading-snug break-words line-clamp-2">${item.item}</h3>
                                    <div class="text-sm text-gray-500 mt-0.5">${item.store || ''}</div>
                                </div>
                                <div class="mt-auto">
                                    <div class="text-gray-800 font-bold mb-2 flex items-center">å°å¹£ : $ ${item.priceTw || '-'} ${savingsInfo}</div>
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-2">
                                            <span class="text-gray-600 font-bold">æ—¥å¹£</span>
                                            <input type="number" placeholder="0" value="${item.priceJp || ''}" class="jp-price-input-clean" onchange="updateShopPrice('${key}', this.value)" onclick="event.stopPropagation()">
                                            ${twdEstimate > 0 ? `<span class="text-xs text-gray-400">(â‰ˆ$${twdEstimate})</span>` : ''}
                                        </div>
                                        <button onclick="openEditShopModal('${key}')" class="text-blue-600 text-lg hover:scale-110 transition px-2"><i class="fa-solid fa-pen"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                });
                
                listContainer.innerHTML = itemsHtml;
            };

            if(db) { 
                db.ref('shoppingList').once('value').then(snapshot => loadData(snapshot.val())); 
            } else { 
                const localData = JSON.parse(localStorage.getItem(SHOPPING_KEY)) || defaultShoppingList; 
                loadData(localData); 
            }
        }

        // 2. åˆ‡æ›åˆ†é å‡½å¼ (é€™å°±æ˜¯æŒ‰éˆ•é»æ“Šå¾Œè¦åŸ·è¡Œçš„åŠŸèƒ½)
function switchBudgetTab(tab) {
    currentBudgetTab = tab;
    renderBudget(); // åˆ‡æ›å¾Œé‡æ–°æ¸²æŸ“ç•«é¢
}


// 3. è¨˜å¸³ä¸»æ¸²æŸ“å‡½å¼
function renderBudget() {
    document.getElementById('header-desc').innerText = "è¨˜å¸³æœ¬ & åˆ†å¸³";
    const container = document.getElementById('app');

    // å»ºç«‹åˆ†é æŒ‰éˆ•èˆ‡å…§å®¹å®¹å™¨
    const tabsHtml = `
        <div class="budget-tab-container">
            <button onclick="switchBudgetTab('details')" class="budget-tab-btn ${currentBudgetTab === 'details' ? 'active' : ''}">
                <i class="fa-solid fa-list-ul mr-1"></i> æ˜ç´°
            </button>
            <button onclick="switchBudgetTab('overview')" class="budget-tab-btn ${currentBudgetTab === 'overview' ? 'active' : ''}">
                <i class="fa-solid fa-chart-pie mr-1"></i> ç¸½è¦½
            </button>
        </div>
        <div id="budget-content-area">
            <div class="text-center text-gray-400 py-4"><i class="fa-solid fa-spinner fa-spin"></i> è¼‰å…¥ä¸­...</div>
        </div>
    `;
    container.innerHTML = tabsHtml;

    const loadData = (data) => {
        const contentArea = document.getElementById('budget-content-area');
        
        // åˆå§‹åŒ–çµ±è¨ˆè®Šæ•¸
        let totalByCat = {};
        let personalTotal = { 'å¦¹å¦¹': 0, 'çˆ¸çˆ¸': 0, 'åª½åª½': 0, 'å§Šå§Š': 0 };
        let expenseListHtml = '';
        const hasData = !!data;
        
        if (hasData) {
            const entries = Array.isArray(data) ? data.map((item, i) => [`local_${i}`, item]) : Object.entries(data);
            
            // éæ­·è³‡æ–™é€²è¡Œè¨ˆç®—
            entries.reverse().forEach(([key, ex]) => {
                const amount = parseInt(ex.amount);
                const amountTwd = ex.currency === 'TWD' ? amount : Math.round(amount * JPY_RATE);
                
                // 1. ç´¯åŠ åˆ†é¡çµ±è¨ˆ
                totalByCat[ex.category] = (totalByCat[ex.category] || 0) + amountTwd;

                // 2. ç´¯åŠ åˆ†å¸³çµ±è¨ˆ
                if (ex.splitDetails) {
                    ex.splitDetails.forEach(detail => {
                        if(personalTotal[detail.name] !== undefined) {
                            const splitAmountTwd = ex.currency === 'TWD' ? detail.amount : Math.round(detail.amount * JPY_RATE);
                            personalTotal[detail.name] += splitAmountTwd;
                        }
                    });
                } else {
                    const payer = ex.payer || 'å§Šå§Š'; 
                    if(personalTotal[payer] !== undefined) personalTotal[payer] += amountTwd;
                }

                // 3. æº–å‚™æ˜ç´°åˆ—è¡¨ (åƒ…ç•¶åœ¨æ˜ç´°é æ™‚éœ€è¦)
                if (currentBudgetTab === 'details') {
                    let icon = 'ğŸ’¸'; 
                    if(ex.category === 'é£Ÿç‰©') icon = 'ğŸ”'; if(ex.category === 'è³¼ç‰©') icon = 'ğŸ›ï¸'; 
                    if(ex.category === 'äº¤é€š') icon = 'ğŸš—'; if(ex.category === 'é–€ç¥¨') icon = 'ğŸ«';
                    
                    const priceDisplay = ex.currency === 'TWD' ? `NT$${amount.toLocaleString()}` : `Â¥${amount.toLocaleString()}`;
                    const subDisplay = ex.currency === 'TWD' ? '' : `<div class="text-[10px] text-gray-400">â‰ˆ NT$${amountTwd.toLocaleString()}</div>`;
                    
                    const isDrive = ex.receiptUrl && ex.receiptUrl.includes('drive.google.com');
                    const iconClass = isDrive ? 'fa-file-contract' : 'fa-receipt';
                    const receiptIcon = ex.receiptUrl 
                        ? `<button onclick="openVoucherImage('${ex.receiptUrl}')" class="text-blue-500 hover:bg-blue-50 p-1 rounded"><i class="fa-solid ${iconClass}"></i></button>` 
                        : '';

                    expenseListHtml += `
                        <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center relative overflow-hidden">
                            <div class="w-1 bg-orange-400 absolute left-0 top-0 bottom-0"></div>
                            <div class="flex-1 ml-2">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-lg">${icon}</span>
                                    <span class="font-bold text-gray-700 text-sm line-clamp-1">${ex.item}</span>
                                    <span class="text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded border border-gray-200">${ex.payer || 'æœªçŸ¥'}</span>
                                </div>
                                <div class="text-xs text-gray-400 flex items-center gap-2">
                                    <span>${ex.fullTime ? ex.fullTime.slice(5, 16).replace('T', ' ') : ex.date}</span>
                                    <span>â€¢ ${ex.payment || 'ç¾é‡‘'}</span>
                                </div>
                            </div>
                            <div class="text-right flex flex-col items-end mr-3 min-w-[70px]">
                                <div class="font-bold text-orange-600">${priceDisplay}</div>
                                ${subDisplay}
                            </div>
                            <div class="flex gap-2 pl-2 border-l border-gray-100">
                                ${receiptIcon}
                                <button onclick="openBudgetModal('${key}')" class="text-gray-400 hover:text-blue-500 p-1"><i class="fa-solid fa-pen"></i></button>
                                <button onclick="deleteExpense('${key}')" class="text-gray-400 hover:text-red-400 p-1"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>`;
                }
            });
        }

        // --- æ ¹æ“šç›®å‰åˆ†é æ¸²æŸ“å…§å®¹ ---
        if (currentBudgetTab === 'details') {
            // [æ˜ç´°é ]
            if (!hasData) {
                contentArea.innerHTML = `
                    <button onclick="openBudgetModal()" class="fab-btn"><i class="fa-solid fa-plus"></i></button>
                    <div class="text-center text-gray-400 py-10">ç›®å‰æ²’æœ‰æ”¯å‡ºï¼Œé»æ“Š + è¨˜å¸³</div>
                `;
            } else {
                contentArea.innerHTML = `
                    <button onclick="openBudgetModal()" class="fab-btn"><i class="fa-solid fa-plus"></i></button>
                    <div class="space-y-3 pb-24 animation-fade">
                        ${expenseListHtml}
                    </div>
                `;
            }
        } else {
            // [ç¸½è¦½é ]
            if (!hasData) {
                contentArea.innerHTML = '<div class="text-center text-gray-400 py-10">å°šç„¡è³‡æ–™å¯åˆ†æ</div>';
            } else {
                let personalHtml = '';
                Object.keys(personalTotal).forEach(name => {
                    personalHtml += `
                        <div class="person-card">
                            <div class="text-xs text-gray-500 font-bold mb-1">${name}</div>
                            <div class="text-xl font-bold text-gray-800">
                                <span class="text-xs mr-0.5">$</span>${personalTotal[name].toLocaleString()}
                            </div>
                        </div>`;
                });

                contentArea.innerHTML = `
                    <div class="space-y-4 pb-24 animation-fade">
                        <div class="card p-4 bg-white">
                            <h3 class="font-bold text-gray-700 mb-2 text-center text-sm">ğŸ“Š æ¶ˆè²»åˆ†é¡çµ±è¨ˆ (NT$)</h3>
                            <div class="chart-container">
                                <canvas id="expenseChart"></canvas>
                            </div>
                        </div>
                        <div class="card p-4 bg-orange-50 border-orange-200">
                            <h3 class="font-bold text-gray-700 mb-3 text-sm"><i class="fa-solid fa-users-viewfinder mr-2"></i>æ¯äººæ‡‰ä»˜ç¸½é¡ (NT$)</h3>
                            <div class="grid grid-cols-2 gap-3">
                                ${personalHtml}
                            </div>
                        </div>
                    </div>
                `;
                
                // åŠ ä¸Šå»¶é²ç¢ºä¿ Canvas å·²å­˜åœ¨
                setTimeout(() => {
                    renderChart(totalByCat);
                }, 50);
            }
        }
    };

    if(db) { 
        db.ref('expenses').once('value').then(snapshot => loadData(snapshot.val())); 
    } else { 
        const localData = JSON.parse(localStorage.getItem(EXPENSE_KEY)) || []; 
        loadData(localData); 
    }
}

// 4. åœ–è¡¨ç¹ªè£½å‡½å¼
function renderChart(dataObj) {
    const ctx = document.getElementById('expenseChart');
    if (!ctx) return;
    
    if (budgetChart) { 
        try { budgetChart.destroy(); } catch(e) { console.log(e); }
    }

    const labels = Object.keys(dataObj);
    const data = Object.values(dataObj);
    const colors = ['#FFAB91', '#FFCC80', '#B2EBF2', '#E1BEE7', '#DCEDC8', '#F8BBD0', '#90CAF9'];

    try {
        budgetChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: colors,
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { font: { family: "'M PLUS Rounded 1c'" }, boxWidth: 12 } }
                }
            }
        });
    } catch (e) {
        console.error("åœ–è¡¨ç¹ªè£½å¤±æ•—:", e);
        ctx.parentNode.innerHTML = '<div class="text-red-400 text-xs text-center py-4">åœ–è¡¨è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†</div>';
    }
}

// --- åœ–è¡¨ç¹ªè£½å‡½å¼ ---
function renderChart(dataObj) {
    const ctx = document.getElementById('expenseChart');
    if (!ctx) {
        console.warn("ç­‰å¾…åœ–è¡¨è¼‰å…¥..."); 
        return;
    }
    
    // éŠ·æ¯€èˆŠåœ–è¡¨ä»¥é˜²é‡ç–Š
    if (budgetChart) { 
        try {
            budgetChart.destroy();
        } catch(e) { console.log(e); }
    }

    const labels = Object.keys(dataObj);
    const data = Object.values(dataObj);
    const colors = ['#FFAB91', '#FFCC80', '#B2EBF2', '#E1BEE7', '#DCEDC8', '#F8BBD0', '#90CAF9'];

    try {
        budgetChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: colors,
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { font: { family: "'M PLUS Rounded 1c'" }, boxWidth: 12 } }
                }
            }
        });
    } catch (e) {
        console.error("åœ–è¡¨ç¹ªè£½å¤±æ•—:", e);
        ctx.parentNode.innerHTML = '<div class="text-red-400 text-xs text-center py-4">åœ–è¡¨è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†</div>';
    }
}

       // --- å»ºç«‹è¡Œç¨‹å¡ç‰‡ HTML (æœªå±•é–‹å³å¯é è¦½æ†‘è­‰ç‰ˆ) ---
function createEventCard(event, dayIdx, evtIdx) {
    
    // æ™‚é–“èˆ‡é›¢é–‹æ™‚é–“
    let timeHtml = `<div class="font-bold text-xl text-gray-700 leading-none">${event.time}</div>`;
    if (event.leaveTime) {
        timeHtml += `<div class="text-[10px] text-red-500 font-bold mt-1 border border-red-200 px-1 rounded bg-red-50 whitespace-nowrap">~${event.leaveTime}</div>`;
    }

    // â˜… æ–°å¢ï¼šå¿«é€Ÿæ†‘è­‰æŒ‰éˆ• (é¡¯ç¤ºåœ¨æœªå±•é–‹å¡ç‰‡ä¸Š)
    let quickVoucherBtn = '';
    if (event.bookingInfo) {
        const btnClass = "mt-2 w-full text-center bg-red-50 text-red-600 py-1.5 rounded-lg text-xs font-bold border border-red-100 hover:bg-red-100 transition pointer-events-auto flex items-center justify-center gap-1 shadow-sm";
        
        if (event.bookingInfo.driveLink) {
            quickVoucherBtn = `<button onclick="openVoucherImage('${event.bookingInfo.driveLink}'); event.stopPropagation();" class="${btnClass}"><i class="fa-solid fa-file-pdf"></i> é è¦½æ†‘è­‰ (PDF)</button>`;
        } else if (event.bookingInfo.voucherImg) {
            quickVoucherBtn = `<button onclick="openVoucherImage('${event.bookingInfo.voucherImg}'); event.stopPropagation();" class="${btnClass}"><i class="fa-solid fa-image"></i> æŸ¥çœ‹æ†‘è­‰åœ–ç‰‡</button>`;
        } else if (event.bookingInfo.pdfContent) {
            quickVoucherBtn = `<button onclick="openPdfModal('${encodeURIComponent(event.bookingInfo.pdfContent)}'); event.stopPropagation();" class="${btnClass}"><i class="fa-solid fa-file-lines"></i> é è¦½æ†‘è­‰å…§å®¹</button>`;
        }
    }

    // 1. å·¦å³æ»‘å‹•é¸æ“‡ (äºŒé¸ä¸€)
    if (event.type === 'choice') {
        const choicesHtml = event.choices.map((c, cIdx) => {
            const targetUrl = c.navLink || c.link || `https://www.google.com/maps/search/?api=1&query=${c.title}+æ²–ç¹©`;
            let travelTimeHtml = '';
            if (c.travelTime) {
                const icon = (c.travelTime.includes('æ­¥') || c.travelTime.includes('èµ°')) ? 'fa-person-walking' : 'fa-car';
                travelTimeHtml = `<span class="text-[10px] bg-gray-100 text-gray-500 px-2 py-1 rounded-full border border-gray-200 shrink-0 flex items-center gap-1"><i class="fa-solid ${icon}"></i> ${c.travelTime}</span>`;
            }
            return `
            <div class="bg-white border-2 border-orange-100 rounded-xl p-4 min-w-[85%] snap-center shadow-sm relative flex flex-col" 
                 onclick="openDetailModal(${dayIdx}, ${evtIdx}, ${cIdx})">
                <div class="flex justify-between items-start mb-2 gap-2">
                    <h4 class="font-bold text-lg text-gray-800 line-clamp-1">${c.title}</h4>
                    <div class="flex gap-1 shrink-0">
                        ${travelTimeHtml}
                        <span class="text-xs px-2 py-1 rounded-full tag-eat flex items-center">ç¾é£Ÿ</span>
                    </div>
                </div>
                <p class="text-sm text-gray-600 mb-8 line-clamp-2">${c.guide}</p>
                <div class="mt-auto flex justify-between items-center">
                    <button class="text-blue-600 text-sm font-bold bg-blue-50 px-3 py-1.5 rounded-lg w-full text-left">æŸ¥çœ‹è©³æƒ…</button>
                    <a href="${targetUrl}" target="_blank" class="absolute bottom-3 right-3 w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center shadow-md active:scale-95 transition" onclick="event.stopPropagation()"><i class="fa-solid fa-location-arrow text-sm"></i></a>
                </div>
            </div>`;
        }).join('');

        return `
            <div class="overflow-hidden">
                <div class="flex items-start gap-3 mb-2 px-1">
                    <div class="min-w-[55px] flex flex-col items-center pt-1">${timeHtml}</div>
                    <h3 class="font-bold text-lg text-gray-800 pt-0.5">${event.title}</h3>
                </div>
                <div class="flex gap-4 overflow-x-auto snap-x-mandatory hide-scrollbar pb-4 px-1">
                    ${choicesHtml}
                </div>
            </div>`;
    }

    // 2. æº–å‚™äº‹é …
    if (event.type === 'prep') {
        return `<div class="card p-4 border-l-4 border-purple-400 bg-purple-50 flex justify-between items-center"><div><div class="font-bold text-xl text-purple-800">${event.time}</div><div class="text-sm text-purple-600 font-bold">${event.title}</div><div class="text-xs text-purple-500 mt-1">${event.guide}</div></div><div class="text-right"><div class="text-xs text-gray-500">é è¨ˆå‡ºç™¼</div><div class="text-2xl font-bold text-purple-900">${event.departureTime.split(' ')[0]}</div><div class="text-xs text-purple-700">æº–æ™‚å‡ºç™¼ ğŸš—</div></div></div>`;
    }

    // 3. ä¸€èˆ¬è¡Œç¨‹
    let previewContent = '';
    if (currentRole === 'driver' && event.mapCode) previewContent = `<div class="mt-2 text-sm font-mono bg-gray-100 p-1 px-2 rounded inline-block"><i class="fa-solid fa-map-location-dot mr-1"></i> ${event.mapCode}</div>`;
    if (currentRole === 'admin' && event.bookingInfo) previewContent = `<div class="mt-2 text-xs text-red-500 font-bold"><i class="fa-solid fa-ticket mr-1"></i> ${event.bookingInfo.note}</div>`;
    
    if (event.frequency) {
        let timeLinkHtml = '';
        if (event.timetableUrl) {
            if (event.timetableUrl.includes('drive.google.com')) {
                timeLinkHtml = `<button onclick="openVoucherImage('${event.timetableUrl}'); event.stopPropagation();" class="ml-1 underline hover:text-blue-800 cursor-pointer pointer-events-auto text-blue-600">æ™‚åˆ»è¡¨</button>`;
            } else {
                timeLinkHtml = `<a href="${event.timetableUrl}" target="_blank" class="ml-1 underline pointer-events-auto" onclick="event.stopPropagation()">æ™‚åˆ»è¡¨</a>`;
            }
        }
        previewContent += `<div class="mt-2 text-xs text-blue-600 font-bold"><i class="fa-solid fa-clock"></i> ${event.frequency} ${timeLinkHtml}</div>`;
    }
    
    let clickAction = (event.type === 'eat' || event.type === 'spot') ? `onclick="openDetailModal(${dayIdx}, ${evtIdx})"` : `onclick="toggleCard(this)"`;
    
    // å°èˆªæŒ‰éˆ•
    let navIconBtn = '';
    if (['spot', 'hotel', 'eat'].includes(event.type)) {
        const targetUrl = event.navLink ? event.navLink : `https://www.google.com/maps/search/?api=1&query=${event.title}+æ²–ç¹©`;
        navIconBtn = `<a href="${targetUrl}" target="_blank" class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center shadow-sm active:scale-95 transition pointer-events-auto shrink-0 ml-2" onclick="event.stopPropagation()"><i class="fa-solid fa-location-arrow text-sm"></i></a>`;
    }

    const tagClass = event.type === 'eat' ? 'tag-eat' : event.type === 'spot' ? 'tag-spot' : event.type === 'hotel' ? 'tag-hotel' : 'tag-trans';
    const tagName = event.type === 'eat' ? 'ç¾é£Ÿ' : event.type === 'spot' ? 'æ™¯é»' : event.type === 'hotel' ? 'ä½å®¿' : 'äº¤é€š';

    return `
        <div class="card p-5" ${clickAction}>
            <div class="flex items-start gap-3 pointer-events-none">
                <div class="min-w-[55px] flex flex-col items-center pt-1">
                    ${timeHtml}
                </div>
                <div class="flex-1 min-w-0">
                    <h3 class="font-bold text-lg text-gray-800 leading-tight">${event.title}</h3>
                    ${event.appLink ? `<a href="${event.appLink.url}" class="mt-2 inline-block bg-black text-white px-3 py-1.5 rounded-lg text-sm font-bold shadow active:scale-95 transition pointer-events-auto" onclick="event.stopPropagation()"><i class="${event.appLink.icon} mr-1"></i> ${event.appLink.text}</a>` : ''}
                    <span class="text-xs px-2 py-1 rounded-full ${tagClass} block w-fit mt-1">${tagName}</span>
                    ${previewContent}
                    
                    <!-- â˜… æŒ‰éˆ•é¡¯ç¤ºåœ¨é€™è£¡ (æœªå±•é–‹å€åŸŸ) -->
                    ${quickVoucherBtn}
                </div>
                ${navIconBtn}
            </div>

            <!-- å±•é–‹å¾Œçš„è©³ç´°å…§å®¹ -->
            <div class="details-content mt-4 pt-4 border-t border-gray-100 space-y-4">
                ${event.title_detail ? `<h4 class="font-bold text-gray-800 text-lg">${event.title_detail}</h4>` : ''}
                ${event.bookingInfo ? `<div class="ticket-box"><div class="text-sm opacity-70">é ç´„æ†‘è­‰ / è¨‚å–®è™Ÿ</div><div class="text-2xl font-bold font-mono my-1 select-all">${event.bookingInfo.code}</div><div class="text-sm flex justify-between"><span>${event.bookingInfo.note}</span><span>${event.bookingInfo.extra || ''}</span></div></div>` : ''}
                ${event.multiMaps ? `<div class="grid grid-cols-2 gap-3">${event.multiMaps.map(m => `<a href="https://www.google.com/maps/search/?api=1&query=${m.query}" target="_blank" class="bg-blue-50 text-blue-600 py-3 rounded-xl text-center font-bold shadow-sm border border-blue-100 active:scale-95 transition"><i class="fa-solid fa-location-arrow mr-1"></i> ${m.name}</a>`).join('')}</div>` : ''}
                ${event.mapCode ? `<div class="bg-gray-50 p-3 rounded-lg"><div class="flex justify-between items-center"><span class="text-sm font-bold text-gray-600">MapCode</span><div class="flex items-center gap-2"><span class="font-mono text-xl font-bold">${event.mapCode}</span><button onclick="copyText('${event.mapCode}', event)" class="text-orange-500"><i class="fa-regular fa-copy"></i></button></div></div>${event.parking ? `<div class="mt-2 text-xs text-gray-500"><i class="fa-solid fa-square-parking"></i> ${event.parking.info}</div>` : ''}</div>` : ''}
                ${event.guide ? `<div class="text-sm text-gray-700 leading-relaxed"><i class="fa-solid fa-circle-info text-orange-400 mr-1"></i> ${event.guide}</div>` : ''}
                ${event.adminNote ? `<div class="text-sm text-gray-600 bg-yellow-50 p-2 rounded border border-yellow-100"><i class="fa-solid fa-pen mr-1"></i> ç­†è¨˜: ${event.adminNote}</div>` : ''}
            </div>
        </div>`;
}

        function getPackingListHTML() {
            const packingList = getPackingList();
            const doneCount = packingList.filter(i => i.done).length;
            const totalCount = packingList.length;
            const progressPercent = Math.round((doneCount / totalCount) * 100);
            const itemsHtml = packingList.map(item => {
                let badgeColor = "bg-gray-100 text-gray-500"; if(item.category === 'é‡è¦') badgeColor = "bg-red-100 text-red-600 font-bold";
                return `<div class="flex items-center gap-3 p-2 rounded hover:bg-teal-50 transition cursor-pointer border-b border-gray-50 last:border-0" onclick="togglePacking('${item.id}')"><div class="w-5 h-5 flex-shrink-0 rounded border-2 border-teal-400 flex items-center justify-center ${item.done ? 'bg-teal-400' : 'bg-white'}">${item.done ? '<i class="fa-solid fa-check text-white text-xs"></i>' : ''}</div><div class="flex-1"><span class="text-[10px] px-1.5 py-0.5 rounded ${badgeColor} mr-1">${item.category}</span><span class="text-sm ${item.done ? 'text-gray-400 line-through' : 'text-gray-700 font-medium'}">${item.text}</span></div></div>`;
            }).join('');
            return `<div class="card p-5 mb-6 border-l-4 border-teal-500 shadow-lg bg-white"><div class="flex justify-between items-end mb-2"><h3 class="font-bold text-teal-700"><i class="fa-solid fa-list-check mr-2"></i>è¡Œææ¸…å–®</h3><span class="text-xs font-bold text-teal-600">${doneCount}/${totalCount} (${progressPercent}%)</span></div><div class="w-full bg-gray-200 rounded-full h-2 mb-3"><div class="bg-teal-500 h-2 rounded-full transition-all duration-500" style="width: ${progressPercent}%"></div></div><div class="grid grid-cols-1 gap-2 max-h-[240px] overflow-y-auto pr-1">${itemsHtml}</div></div>`;
        }

        // --- Modals & Actions ---
        function openEditShopModal(key = null) {
            const isEdit = !!key;
            let item = {};
            if (isEdit) {
                if(db) {
                    db.ref('shoppingList/' + key).once('value').then(snapshot => { renderShopModalHTML(key, snapshot.val()); openModal('modal-shopping'); });
                    return;
                } else {
                    const index = parseInt(key.split('_')[1]);
                    const localData = JSON.parse(localStorage.getItem(SHOPPING_KEY));
                    item = localData[index];
                }
            }
            renderShopModalHTML(key, item);
            openModal('modal-shopping');
        }

        function renderShopModalHTML(key, item = {}) {
            const modalSheet = document.querySelector('#modal-shopping .modal-sheet');
            modalSheet.innerHTML = `<div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-gray-700" id="shop-modal-title">${key ? 'ç·¨è¼¯å•†å“' : 'æ–°å¢å¿…è²· & æ¯”åƒ¹'}</h3><button onclick="closeModal('modal-shopping')" class="text-gray-400"><i class="fa-solid fa-xmark text-xl"></i></button></div><input type="hidden" id="in-shop-key" value="${key || ''}"><input id="in-shop-img" placeholder="åœ–ç‰‡é€£çµ URL æˆ– æª”å (é¸å¡«)" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 text-sm mb-2" value="${item.imgUrl || ''}"><div class="grid grid-cols-3 gap-2 mb-2"><select id="in-shop-cat" class="p-3 bg-white rounded-xl border border-orange-200 font-bold text-gray-700">${['è—¥å¦','é›¶é£Ÿ','é–€ç¥¨','é›»å™¨','è¡£ç‰©','é›œè²¨'].map(c => `<option value="${c}" ${item.category===c?'selected':''}>${c}</option>`).join('')}</select><input id="in-shop-store" placeholder="å•†åº— (å¦‚: å¤§åœ‹)" class="col-span-2 p-3 bg-gray-50 rounded-xl border border-gray-200" value="${item.store || ''}"></div><input id="in-shop-item" placeholder="å“å (å¦‚: åˆåˆ©ä»–å‘½)" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 mb-2" value="${item.item || ''}"><div class="grid grid-cols-2 gap-3 bg-blue-50 p-3 rounded-xl border border-blue-100 mb-2"><div><label class="text-xs text-gray-500 font-bold">ğŸ‡¹ğŸ‡¼ å°ç£å”®åƒ¹</label><input id="in-shop-tw" type="number" placeholder="NT$" class="w-full p-2 bg-white rounded border border-blue-200 mt-1" value="${item.priceTw || ''}"></div><div><label class="text-xs text-gray-500 font-bold">ğŸ‡¯ğŸ‡µ æ—¥æœ¬å”®åƒ¹</label><input id="in-shop-jp" type="number" placeholder="Â¥" class="w-full p-2 bg-white rounded border border-blue-200 mt-1" value="${item.priceJp || ''}"></div><div class="col-span-2 text-center text-xs text-blue-500 pt-1">è¼¸å…¥æ—¥æœ¬åƒ¹æ ¼è‡ªå‹•è¨ˆç®—åŒ¯ç‡ (${JPY_RATE})</div></div><textarea id="in-shop-note" placeholder="å‚™è¨»ï¼šè¦æ ¼ã€ä»£è²·äººã€ç´°ç¯€ (ä¸æœƒé¡¯ç¤ºåœ¨å¡ç‰‡ä¸Š)" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 text-sm h-20 mb-2 resize-none">${item.note || ''}</textarea><button onclick="saveShopItem()" class="w-full bg-pink-500 text-white font-bold py-3 rounded-xl shadow-lg mt-2">å„²å­˜</button>`;
        }

        function saveShopItem() {
            const key = document.getElementById('in-shop-key').value;
            const newItem = {
                imgUrl: document.getElementById('in-shop-img').value,
                category: document.getElementById('in-shop-cat').value,
                store: document.getElementById('in-shop-store').value,
                item: document.getElementById('in-shop-item').value,
                priceTw: document.getElementById('in-shop-tw').value,
                priceJp: document.getElementById('in-shop-jp').value,
                note: document.getElementById('in-shop-note').value,
                done: false, addedBy: currentRole, timestamp: Date.now()
            };
            
            if(!newItem.item) return alert("è«‹è‡³å°‘è¼¸å…¥å“å");

            if(db) {
                if(key) { delete newItem.done; db.ref('shoppingList/' + key).update(newItem); }
                else { db.ref('shoppingList').push(newItem); }
            } else {
                const localData = JSON.parse(localStorage.getItem(SHOPPING_KEY)) || [];
                if(key) { const index = parseInt(key.split('_')[1]); newItem.done = localData[index].done; localData[index] = { ...localData[index], ...newItem }; }
                else { localData.push(newItem); }
                localStorage.setItem(SHOPPING_KEY, JSON.stringify(localData));
                renderShopping();
            }
            closeModal('modal-shopping');
        }

        function updateShopPrice(key, newPrice) {
            if(db) { db.ref('shoppingList/' + key).update({ priceJp: newPrice }); } 
            else { const index = parseInt(key.split('_')[1]); const localData = JSON.parse(localStorage.getItem(SHOPPING_KEY)); localData[index].priceJp = newPrice; localStorage.setItem(SHOPPING_KEY, JSON.stringify(localData)); renderShopping(); }
        }

        function toggleShopItem(key) { 
            if(db) { db.ref('shoppingList/' + key).once('value').then(snapshot => { const current = snapshot.val().done; db.ref('shoppingList/' + key).update({ done: !current }); }); } 
            else { const index = parseInt(key.split('_')[1]); const localData = JSON.parse(localStorage.getItem(SHOPPING_KEY)); localData[index].done = !localData[index].done; localStorage.setItem(SHOPPING_KEY, JSON.stringify(localData)); renderShopping(); } 
        }

        function deleteShopItem(key) { 
            if(confirm("åˆªé™¤æ­¤é …ç›®ï¼Ÿ")) { 
                if(db) db.ref('shoppingList/' + key).remove(); 
                else { const index = parseInt(key.split('_')[1]); const localData = JSON.parse(localStorage.getItem(SHOPPING_KEY)); localData.splice(index, 1); localStorage.setItem(SHOPPING_KEY, JSON.stringify(localData)); renderShopping(); } 
            } 
        }

        // --- Budget Modal & Logic ---
        function openBudgetModal(key = null) {
            const isEdit = !!key;
            let editData = {};
            if (isEdit) {
                if(db) { db.ref('expenses/' + key).once('value').then(snapshot => { fillAndShowBudgetModal(key, snapshot.val()); }); return; }
                else { const index = parseInt(key.split('_')[1]); const localData = JSON.parse(localStorage.getItem(EXPENSE_KEY)); editData = localData[index]; fillAndShowBudgetModal(key, editData); return; }
            }
            const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            const defaultData = { fullTime: now.toISOString().slice(0,16), category: 'é£Ÿç‰©', payment: 'ç¾é‡‘', qty: 1, currency: 'JPY', payer: FAMILY_MEMBERS.find(m => m.id === currentRole)?.name || 'å§Šå§Š' };
            fillAndShowBudgetModal(null, defaultData);
        }

       function fillAndShowBudgetModal(key, data) {
    const modalSheet = document.querySelector('#modal-budget .modal-sheet');
    const splitMethod = data.splitMethod || 'equal';
    
    // â˜… é—œéµä¿®æ”¹ï¼šå¼·åˆ¶æ”¹è®Š Modal çš„ CSSï¼Œä½¿å…¶æ”¯æ´ã€Œç½®åº•å€å¡Šã€
    // ç§»é™¤é è¨­ paddingï¼Œæ”¹ç”±å…§éƒ¨å€å¡Šæ§åˆ¶ï¼Œä¸¦è¨­å®š Flex ä½ˆå±€
    modalSheet.style.padding = '0'; 
    modalSheet.style.display = 'flex';
    modalSheet.style.flexDirection = 'column';
    modalSheet.style.overflow = 'hidden'; // é˜²æ­¢å¤–å±¤æ²å‹•
    modalSheet.style.maxHeight = '90vh';  // é™åˆ¶é«˜åº¦

    modalSheet.innerHTML = `
        <!-- 1. å›ºå®šé é¦– (Header) -->
        <div class="px-5 pt-5 pb-2 flex justify-between items-center shrink-0 bg-white z-10">
            <h3 class="text-xl font-bold text-gray-700">${key ? 'ç·¨è¼¯æ”¯å‡º' : 'è¨˜ä¸€ç­†æ”¯å‡º'}</h3>
            <button onclick="closeModal('modal-budget')" class="text-gray-400"><i class="fa-solid fa-xmark text-xl"></i></button>
        </div>
        
        <input type="hidden" id="in-ex-key" value="${key || ''}">
        
        <!-- 2. å¯æ²å‹•å…§å®¹å€ (Body) -->
        <div class="flex-1 overflow-y-auto px-5 pb-4" style="overscroll-behavior: contain;">
            
            <div class="bg-gray-50 p-2 rounded-xl border border-gray-200 mb-3">
                <label class="text-xs text-gray-500 font-bold ml-1">æ—¥æœŸèˆ‡æ™‚é–“</label>
                <input id="in-ex-time" type="datetime-local" class="w-full bg-transparent font-bold text-gray-700 outline-none mt-1" value="${data.fullTime || ''}">
            </div>

            <div class="grid grid-cols-2 gap-2 mb-3">
                <select id="in-ex-category" class="p-3 bg-white rounded-xl border border-orange-200 text-gray-700 font-bold">
                    ${['é£Ÿç‰©','è³¼ç‰©','äº¤é€š','é–€ç¥¨','å…¶ä»–'].map(c => `<option value="${c}" ${data.category===c?'selected':''}>${c}</option>`).join('')}
                </select>
                <select id="in-ex-payer" class="p-3 bg-white rounded-xl border border-blue-200 text-blue-800 font-bold">
                    ${FAMILY_MEMBERS.map(m => `<option value="${m.name}" ${data.payer===m.name?'selected':''}>ä»˜æ¬¾: ${m.name}</option>`).join('')}
                </select>
            </div>

            <input id="in-ex-store" placeholder="å•†åº—/é¤å»³ (é¸å¡«)" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 mb-2" value="${data.store || ''}">
            <input id="in-ex-item" placeholder="å“å/å…§å®¹" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 mb-2" value="${data.item || ''}">

            <div class="grid grid-cols-3 gap-2 mb-2">
                <div class="col-span-2 relative">
                     <input id="in-ex-price" type="number" placeholder="å–®åƒ¹" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 font-bold text-lg" value="${data.priceJp || ''}">
                     <span class="absolute right-3 top-3 text-gray-400 text-xs">å–®åƒ¹</span>
                </div>
                <select id="in-ex-currency" class="p-3 bg-gray-50 rounded-xl border border-gray-200 text-gray-700 font-bold">
                    <option value="JPY" ${data.currency!=='TWD'?'selected':''}>Â¥ JPY</option>
                    <option value="TWD" ${data.currency==='TWD'?'selected':''}>$ TWD</option>
                </select>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-3">
                <div class="flex items-center gap-2">
                    <button class="qty-btn" onclick="adjustQty(-1)">-</button>
                    <input id="in-ex-qty" type="number" value="${data.qty || 1}" class="w-full p-3 text-center bg-gray-50 rounded-xl border border-gray-200" readonly>
                    <button class="qty-btn" onclick="adjustQty(1)">+</button>
                </div>
                <select id="in-ex-pay" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 text-gray-700">
                    ${['ç¾é‡‘','ä¿¡ç”¨å¡','Suica/ICå¡'].map(p => `<option value="${p}" ${data.payment===p?'selected':''}>${p}</option>`).join('')}
                </select>
            </div>
            
            <div class="mb-2">
                <input id="in-ex-receipt" placeholder="æ†‘è­‰åœ–ç‰‡ç¶²å€ (URL)" class="w-full p-2 bg-gray-50 rounded-lg border border-gray-200 text-sm" value="${data.receiptUrl || ''}">
            </div>

            <div class="mb-3">
                 <textarea id="in-ex-note" placeholder="å‚™è¨»ï¼šç´°ç¯€ã€å¿ƒæƒ…" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 text-sm h-16 resize-none">${data.note || ''}</textarea>
            </div>

            <div class="split-box mb-4">
                <div class="flex justify-between items-center mb-2">
                    <label class="font-bold text-gray-700 text-sm">åˆ†å¸³æ–¹å¼</label>
                    <select id="in-ex-split-method" onchange="renderSplitOptions()" class="text-xs border p-1 rounded bg-white">
                        <option value="equal" ${splitMethod==='equal'?'selected':''}>æŒ‰äººé ­å‡åˆ†</option>
                        <option value="amount" ${splitMethod==='amount'?'selected':''}>æŒ‡å®šé‡‘é¡</option>
                        <option value="none" ${splitMethod==='none'?'selected':''}>ä¸åˆ†å¸³(å€‹äºº)</option>
                    </select>
                </div>
                <div id="split-options-container" class="grid grid-cols-2 gap-2"></div>
            </div>
        </div>

        <!-- 3. å›ºå®šé å°¾ (Footer) - ç¸½é‡‘é¡èˆ‡æŒ‰éˆ• -->
        <div class="p-4 bg-white border-t border-gray-100 shrink-0 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] safe-area-bottom z-20">
            <div class="flex items-stretch gap-3">
                <!-- å·¦å´ï¼šç¸½é‡‘é¡é¡¯ç¤º -->
                <div class="flex-1 bg-orange-50 p-2 rounded-xl text-center border border-orange-100 flex flex-col justify-center">
                    <div class="text-[10px] text-gray-500 mb-0.5">ç¸½é‡‘é¡</div>
                    <div class="text-xl font-bold text-orange-600 leading-none">
                        <span id="lbl-currency">${data.currency==='TWD'?'$':'Â¥'}</span><span id="calc-total">0</span>
                    </div>
                    <div id="calc-convert-hint" class="text-[10px] font-bold text-blue-500 mt-0.5 ${data.currency==='TWD'?'hidden':''}">
                        â‰ˆ NT$<span id="calc-twd">0</span>
                    </div>
                </div>

                <!-- å³å´ï¼šå„²å­˜æŒ‰éˆ• -->
                <button onclick="saveExpense()" class="flex-1 bg-orange-500 text-white font-bold py-2 rounded-xl shadow-lg text-lg flex items-center justify-center active:scale-95 transition">
                    ${key ? 'æ›´æ–°ç´€éŒ„' : 'å„²å­˜ç´€éŒ„'}
                </button>
            </div>
        </div>
    `;

    openModal('modal-budget');
    
    // åˆå§‹åŒ–åˆ†å¸³ UI
    renderSplitOptions(data.splitDetails);
    
    // ç¶å®šäº‹ä»¶
    const priceEl = document.getElementById('in-ex-price');
    const qtyEl = document.getElementById('in-ex-qty');
    const currEl = document.getElementById('in-ex-currency');

    if (priceEl) priceEl.addEventListener('input', updateCalc);
    if (qtyEl) qtyEl.addEventListener('input', updateCalc);
    if (currEl) currEl.addEventListener('change', () => {
        document.getElementById('lbl-currency').innerText = currEl.value === 'TWD' ? '$' : 'Â¥';
        document.getElementById('calc-convert-hint').classList.toggle('hidden', currEl.value === 'TWD');
        updateCalc();
    });

    updateCalc();
}

// --- 2. è‡ªå‹•è¨ˆç®—ç¸½é¡ (ä¿®æ­£ç‰ˆ) ---
function updateCalc() {
    const priceEl = document.getElementById('in-ex-price');
    const qtyEl = document.getElementById('in-ex-qty');
    
    if (!priceEl || !qtyEl) return; // é˜²æ­¢å…ƒç´ æ‰¾ä¸åˆ°å ±éŒ¯

    const p = parseInt(priceEl.value) || 0;
    const q = parseInt(qtyEl.value) || 1;
    const total = p * q;
    
    const totalEl = document.getElementById('calc-total');
    if (totalEl) totalEl.innerText = total.toLocaleString();
    
    // åŒ¯ç‡æ›ç®—é¡¯ç¤º
    const currency = document.getElementById('in-ex-currency').value;
    if (currency !== 'TWD') {
        const twdEl = document.getElementById('calc-twd');
        if (twdEl) twdEl.innerText = Math.round(total * JPY_RATE).toLocaleString();
    }
}

// --- 3. èª¿æ•´æ•¸é‡æŒ‰éˆ• (ä¿®æ­£ç‰ˆ) ---
function adjustQty(delta) {
    const input = document.getElementById('in-ex-qty');
    if (!input) return;
    
    let val = parseInt(input.value) || 1;
    val += delta;
    if (val < 1) val = 1;
    input.value = val;
    
    // â˜… ç›´æ¥å‘¼å« updateCalcï¼Œæ¯” dispatchEvent æ›´ç©©å®š
    updateCalc();
}

        function saveExpense() {
            const key = document.getElementById('in-ex-key').value;
            const category = document.getElementById('in-ex-category').value;
            const payer = document.getElementById('in-ex-payer').value;
            const store = document.getElementById('in-ex-store').value;
            const item = document.getElementById('in-ex-item').value;
            const price = parseInt(document.getElementById('in-ex-price').value);
            const qty = parseInt(document.getElementById('in-ex-qty').value);
            const currency = document.getElementById('in-ex-currency').value;
            const payment = document.getElementById('in-ex-pay').value;
            const fullTime = document.getElementById('in-ex-time').value;
            const receiptUrl = document.getElementById('in-ex-receipt').value;
            const note = document.getElementById('in-ex-note').value; 
            const splitMethod = document.getElementById('in-ex-split-method').value;

            if(!item || isNaN(price)) return alert("è«‹è¼¸å…¥æ­£ç¢ºçš„å“åå’Œé‡‘é¡");

            const totalAmount = price * qty;
            let splitDetails = [];

            if (splitMethod === 'equal') {
                const checks = document.querySelectorAll('#split-options-container input[type="checkbox"]:checked');
                if (checks.length > 0) { const perPerson = Math.round(totalAmount / checks.length); checks.forEach(chk => splitDetails.push({ name: chk.value, amount: perPerson })); } else { splitDetails.push({ name: payer, amount: totalAmount }); }
            } else if (splitMethod === 'amount') {
                const inputs = document.querySelectorAll('.split-amount-input');
                inputs.forEach(inp => { const val = parseInt(inp.value) || 0; if (val > 0) splitDetails.push({ name: inp.dataset.name, amount: val }); });
            } else { splitDetails.push({ name: payer, amount: totalAmount }); }

            const expenseData = { category, store, item, payer, currency, payment, receiptUrl, note, splitMethod, splitDetails, priceJp: price, qty, amount: totalAmount, date: fullTime.split('T')[0].replace(/-/g, '/'), fullTime, timestamp: Date.now() };

            if(db) { if(key) db.ref('expenses/' + key).update(expenseData); else db.ref('expenses').push(expenseData); } 
            else { const localData = JSON.parse(localStorage.getItem(EXPENSE_KEY)) || []; if(key) { const index = parseInt(key.split('_')[1]); localData[index] = expenseData; } else { localData.push(expenseData); } localStorage.setItem(EXPENSE_KEY, JSON.stringify(localData)); renderBudget(); }
            closeModal('modal-budget');
        }

        function renderSplitOptions(savedDetails = null) {
            const method = document.getElementById('in-ex-split-method').value;
            const container = document.getElementById('split-options-container');
            let html = '';
            if (method === 'equal') {
                FAMILY_MEMBERS.forEach(m => { const isChecked = savedDetails ? savedDetails.some(d => d.name === m.name) : true; html += `<div class="member-check ${isChecked ? 'active' : ''}" onclick="this.classList.toggle('active'); this.querySelector('input').checked = !this.querySelector('input').checked;"><input type="checkbox" value="${m.name}" class="hidden" ${isChecked ? 'checked' : ''}><i class="fa-solid ${isChecked ? 'fa-circle-check' : 'fa-circle'} text-xs"></i> ${m.name}</div>`; });
            } else if (method === 'amount') {
                FAMILY_MEMBERS.forEach(m => { const savedVal = savedDetails ? (savedDetails.find(d => d.name === m.name)?.amount || 0) : 0; html += `<div class="flex items-center gap-2 bg-white p-2 rounded border"><span class="text-xs font-bold w-8">${m.name}</span><input type="number" data-name="${m.name}" value="${savedVal}" placeholder="é‡‘é¡" class="split-amount-input w-full text-sm border-b outline-none text-right"></div>`; });
            } else { html = `<div class="col-span-2 text-xs text-gray-400 text-center py-2">è²»ç”¨å°‡å…¨é¡æ­¸æ–¼ä»˜æ¬¾äºº</div>`; }
            container.innerHTML = html;
        }

        function adjustQty(delta) { const input = document.getElementById('in-ex-qty'); let val = parseInt(input.value) || 1; val += delta; if(val < 1) val = 1; input.value = val; input.dispatchEvent(new Event('input')); }
        function deleteExpense(key) { if(confirm("åˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ")) { if(db) { db.ref('expenses/' + key).remove(); } else { const index = parseInt(key.split('_')[1]); const localData = JSON.parse(localStorage.getItem(EXPENSE_KEY)) || []; localData.splice(index, 1); localStorage.setItem(EXPENSE_KEY, JSON.stringify(localData)); renderBudget(); } } }
        
        function getPackingList() { const stored = localStorage.getItem(PACKING_KEY); if (!stored) { localStorage.setItem(PACKING_KEY, JSON.stringify(defaultPackingList)); return defaultPackingList; } return JSON.parse(stored); }
        function togglePacking(id) { const list = getPackingList(); const item = list.find(i => i.id === id); if(item) { item.done = !item.done; localStorage.setItem(PACKING_KEY, JSON.stringify(list)); if(currentTab === 'home') renderHome(); if(currentTab === 'vouchers') renderVouchers(); } }
        function switchTab(tab) { 
    currentTab = tab; 
    
    // æ›´æ–°åº•éƒ¨å°èˆªæ¨£å¼
    document.querySelectorAll('.nav-item').forEach(btn => { 
        btn.classList.remove('active', 'text-orange-500'); 
        btn.classList.add('text-gray-400'); 
    }); 
    if (tab !== 'home') document.getElementById(`btn-${tab}`).classList.replace('text-gray-400', 'text-orange-500'); 
    
    // æ¸²æŸ“å…§å®¹
    if (tab === 'home') renderHome(); 
    if (tab === 'schedule') renderSchedule(); 
    if (tab === 'shopping') renderShopping(); 
    if (tab === 'budget') renderBudget(); 
    if (tab === 'vouchers') renderVouchers(); 
    
    // â˜… ä¿®æ”¹ï¼šåªæœ‰åœ¨ã€Œæ‰‹å‹•é»æ“Šåˆ‡æ›ã€æ™‚æ‰æ²åˆ°é ‚éƒ¨
    // æˆ‘å€‘é€éæª¢æŸ¥ sessionStorage æ˜¯å¦æœ‰å€¼ä¾†åˆ¤æ–·é€™æ˜¯ä¸æ˜¯ã€Œåˆ·æ–°å¾Œçš„è‡ªå‹•è¼‰å…¥ã€
    // ä½†æœ€ç°¡å–®çš„æ–¹å¼æ˜¯ï¼šç›´æ¥åœ¨é€™è£¡å¼·åˆ¶æ²å‹•åˆ°é ‚éƒ¨å³å¯ï¼Œ
    // å› ç‚º init() è£¡é¢çš„ setTimeout æœƒåœ¨é€™ä¸€è¡Œä¹‹å¾ŒåŸ·è¡Œï¼Œä¸¦æŠŠä½ç½®è“‹éå» (æ¢å¾©åˆ°åŸæœ¬ä½ç½®)
    window.scrollTo(0, 0); 
}
        function changeDate(index) { selectedDateIndex = index; renderSchedule(); }
        function toggleCard(element) { const details = element.querySelector('.details-content'); if(details) { details.style.display = details.style.display==='block'?'none':'block'; element.classList.toggle('card-active'); } }
        function copyText(text, e) { if(e) e.stopPropagation(); navigator.clipboard.writeText(text).then(() => alert("å·²è¤‡è£½")); }
        function toggleDevMode() { currentSimulatedDate = currentSimulatedDate ? null : "2025/12/26"; alert(currentSimulatedDate ? "æ¨¡æ“¬: 12/26" : "å›åˆ°ç¾åœ¨"); renderHome(); }
        function openTranslation() { document.getElementById('trans-modal').classList.remove('hidden'); document.getElementById('trans-modal').classList.add('flex'); }
        function closeTranslation() { document.getElementById('trans-modal').classList.add('hidden'); document.getElementById('trans-modal').classList.remove('flex'); }
        function openModal(id) { document.getElementById(id).classList.add('open'); }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }
        function openPdfModal(encodedContent) { const content = decodeURIComponent(encodedContent); const modal = document.getElementById('modal-pdf'); const body = document.getElementById('pdf-content'); let html = `<div class="pdf-header border-b-2 border-gray-800 pb-2 mb-4 flex justify-between items-end"><h2 class="text-xl font-bold text-gray-800">BOOKING CONFIRMATION</h2><div class="text-right text-xs text-gray-500">2025/11/27</div></div>`; content.split('\n').forEach(line => { if(line.includes('ï¼š')) { const [key, val] = line.split('ï¼š'); html += `<div class="mb-2"><div class="text-[10px] text-gray-500 uppercase">${key}</div><div class="font-bold text-gray-900">${val}</div></div>`; } else if(line.trim() === '') html += `<div class="h-4"></div>`; else html += `<div class="text-sm text-gray-700 mb-1">${line}</div>`; }); body.innerHTML = html; modal.classList.add('open'); }
        function closePdfModal() { document.getElementById('modal-pdf').classList.remove('open'); }
        
        // --- æ†‘è­‰é è¦½ (ä¸‰å±¤ä¸é‡ç–Šç‰ˆ) ---
        function openVoucherImage(imgSrc) {
            const modal = document.getElementById('modal-pdf');
            const body = document.getElementById('pdf-content');
            
            // æ¸…ç©ºèˆŠæŒ‰éˆ• (å¦‚æœæœ‰çš„è©±)
            const oldBtn = document.querySelector('#modal-pdf .pdf-sheet > button');
            if (oldBtn) oldBtn.remove(); 

            const isGoogleDrive = imgSrc.includes('drive.google.com');
            let innerContent = '';
            let footerContent = '';

            if (isGoogleDrive) {
                const previewUrl = getDrivePreviewUrl(imgSrc);
                const fallbackUrl = previewUrl.replace('/preview', '/view');
                innerContent = `<iframe src="${previewUrl}" class="w-full h-full border-0 bg-gray-100" allow="autoplay" referrerpolicy="no-referrer"></iframe>`;
                footerContent = `<div class="p-3 bg-white border-t border-gray-200 safe-area-bottom"><a href="${fallbackUrl}" target="_blank" class="block w-full text-center bg-blue-600 text-white py-3 rounded-xl text-sm font-bold shadow hover:bg-blue-700 transition"><i class="fa-solid fa-external-link-alt mr-1"></i> é–‹å•ŸåŸå§‹æª”æ¡ˆ</a></div>`;
            } else {
                const finalSrc = imgSrc.startsWith('http') ? imgSrc : `./${imgSrc}`;
                innerContent = `<div class="w-full h-full bg-black flex items-center justify-center"><img src="${finalSrc}" class="max-w-full max-h-full object-contain"></div>`;
            }

            const finalHtml = `<div class="h-[50px] bg-white border-b border-gray-200 flex justify-between items-center px-4 shrink-0"><span class="font-bold text-gray-700">æ†‘è­‰é è¦½</span><button onclick="closePdfModal()" class="w-8 h-8 flex items-center justify-center bg-gray-100 rounded-full text-gray-600 hover:bg-gray-200"><i class="fa-solid fa-xmark text-lg"></i></button></div><div class="flex-1 relative overflow-hidden">${innerContent}</div>${footerContent}`;

            body.style.width = '100%';
            body.style.height = '100%';
            body.style.padding = '0';
            body.style.display = 'flex';
            body.style.flexDirection = 'column';
            body.innerHTML = finalHtml;
            modal.classList.add('open');
        }

        function openDetailModal(dayIdx, eventIdx, choiceIdx = null) {
    const modal = document.getElementById('modal-detail');
    const content = document.getElementById('modal-detail-content');
    
    let event = tripData[dayIdx].events[eventIdx];
    if (choiceIdx !== null && event.choices) event = event.choices[choiceIdx];
    
    const img = event.imgUrl || 'https://via.placeholder.com/400x250?text=No+Image';
    const detail = event.detailInfo || {};
    
    let tagsHtml = ''; 
    if(detail.tags) detail.tags.forEach(t => tagsHtml += `<span class="bg-orange-100 text-orange-600 text-xs px-2 py-1 rounded-full mr-1">#${t}</span>`);
    
    let highlightHtml = ''; 
    if(detail.highlights) highlightHtml = `<div class="mt-4"><h4 class="font-bold text-gray-800 mb-2">âœ¨ å¿…çœ‹äº®é»</h4><ul class="list-disc list-inside text-sm text-gray-600 space-y-1">${detail.highlights.map(h => `<li>${h}</li>`).join('')}</ul></div>`;
    if(detail.menu) highlightHtml = `<div class="mt-4"><h4 class="font-bold text-gray-800 mb-2">ğŸ‘©â€ğŸ³ æ¨è–¦èœå–®</h4><div class="grid grid-cols-1 gap-2">${detail.menu.map(m => `<div class="flex justify-between items-center bg-gray-50 p-2 rounded"><span class="font-bold text-gray-700 text-sm">${m.n}</span><span class="text-orange-500 text-sm font-bold">${m.p || ''}</span></div>`).join('')}</div></div>`;

    // å³å´æŒ‰éˆ•ï¼šGoogle è©•è«– (æˆ–å°èˆª)
    const reviewUrl = event.reviewLink || event.navLink || `https://www.google.com/maps/search/?api=1&query=${event.title}+æ²–ç¹©`;
    
    // å·¦å´æŒ‰éˆ•ï¼šå®˜æ–¹ç¶²ç«™ / Tabelog (â˜… ä¿®æ”¹ï¼šä¸å†é¡¯ç¤º MapCode æŒ‰éˆ•)
    let infoBtnHtml = '';
    
    if (event.link) {
        const isTabelog = event.link.includes('tabelog');
        const btnText = isTabelog ? 'Tabelog é£Ÿè¨˜' : 'å®˜æ–¹ç¶²ç«™';
        const btnIcon = isTabelog ? 'fa-solid fa-utensils' : 'fa-solid fa-globe';
        const btnClasses = isTabelog ? 'bg-orange-500 text-white shadow-orange-200' : 'bg-gray-100 text-gray-700 border-gray-200';

        infoBtnHtml = `
            <a href="${event.link}" target="_blank" class="flex-1 ${btnClasses} py-3 rounded-xl font-bold shadow-lg active:scale-95 transition text-center flex items-center justify-center gap-2">
                <i class="${btnIcon}"></i> ${btnText}
            </a>`;
    } else {
        // å¦‚æœæ²’æœ‰ linkï¼Œå°±æ”¾ä¸€å€‹éš±è—çš„ä½”ä½ç¬¦ï¼Œè®“å³é‚Šçš„æŒ‰éˆ•ä¿æŒåœ¨å³é‚Š
        infoBtnHtml = `<div class="flex-1"></div>`; 
    }

    content.innerHTML = `
        <div class="detail-handle" onclick="closeDetailModal()"></div>
        <button class="detail-close-btn" onclick="closeDetailModal()"><i class="fa-solid fa-xmark"></i></button>
        <img src="${img}" class="detail-header-img shrink-0">
        <div class="detail-body">
            <div class="flex items-center gap-2 mb-1">
                ${tagsHtml}
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-3">${event.title}</h2>
            <p class="text-gray-600 text-sm leading-relaxed">${detail.desc || event.guide || 'æš«ç„¡è©³ç´°ä»‹ç´¹'}</p>
            ${highlightHtml}
        </div>

        <div class="p-4 bg-white border-t border-gray-100 shrink-0 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] safe-area-bottom z-20">
            <div class="flex gap-3">
                <!-- å·¦å´ï¼šè³‡è¨Š (è‹¥ç„¡ link å‰‡ç•™ç™½) -->
                ${infoBtnHtml}
                
                <!-- å³å´ï¼šGoogle è©•è«– -->
                <a href="${reviewUrl}" target="_blank" class="flex-1 bg-blue-600 text-white py-3 rounded-xl text-center font-bold shadow-lg active:scale-95 transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-comments"></i> Google è©•è«–
                </a>
            </div>
        </div>`;
        
    modal.classList.add('open');
}

function closeDetailModal() { 
    document.getElementById('modal-detail').classList.remove('open'); 
}

// --- æ›´æ–°å¤©æ°£è³‡è¨Š (ä¿®æ­£ç‰ˆï¼šè§£æ±ºæ™‚å€èˆ‡è·¨æ—¥å•é¡Œ) ---
async function updateWeatherUI() {
    const container = document.getElementById('weather-scroll'); 
    const sunsetEl = document.getElementById('sunset-time'); 
    if(!container) return;

    try {
        // 1. è«‹æ±‚ 2 å¤©çš„è³‡æ–™ä»¥å…è·¨æ—¥æ²’æ•¸æ“šï¼Œä¸¦æŒ‡å®šæ™‚å€ç‚ºæ±äº¬
        const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=26.2124&longitude=127.6809&current=temperature_2m,weather_code&hourly=temperature_2m,weather_code&daily=sunset&timezone=Asia%2FTokyo&forecast_days=2');
        
        if (!res.ok) throw new Error("Network response was not ok");

        const data = await res.json();

        // 2. æ—¥è½æ™‚é–“ (ç›´æ¥è§£æå­—ä¸²ï¼Œé¿å…æ™‚å€è½‰æ›èª¤å·®)
        if (data.daily && data.daily.sunset && data.daily.sunset[0]) {
            const sunsetRaw = data.daily.sunset[0];
            const sunsetTime = sunsetRaw.split('T')[1]; // å–å¾— "17:34"
            if(sunsetEl) sunsetEl.innerHTML = `<i class="fa-solid fa-cloud-sun"></i> æ—¥è½ ${sunsetTime}`;
        }

        // 3. å°‹æ‰¾èµ·å§‹æ™‚é–“ (ä½¿ç”¨ API çš„ current.time ä¾†å°æ‡‰ hourly)
        const currentIsoTime = data.current.time; // "2025-12-05T14:00"
        
        // æ‰¾ hourly é™£åˆ—ä¸­ç¬¦åˆç•¶å‰æ™‚é–“çš„ç´¢å¼•
        let startIndex = data.hourly.time.indexOf(currentIsoTime);

        // å¦‚æœå‰›å¥½æœ‰å¹¾åˆ†é˜èª¤å·®æ‰¾ä¸åˆ° (APIæœ‰æ™‚æœƒæœ‰é²å»¶)ï¼Œæ”¹ç”¨å°æ™‚å­—ä¸²æ¯”å°
        if (startIndex === -1) {
            const currentHourStr = currentIsoTime.substring(0, 13); // "2025-12-05T14"
            startIndex = data.hourly.time.findIndex(t => t.startsWith(currentHourStr));
        }

        // å¦‚æœé‚„æ˜¯æ‰¾ä¸åˆ° (æ¥µç«¯æƒ…æ³)ï¼Œé è¨­å¾é ­é–‹å§‹ï¼Œé¿å…ç¨‹å¼å´©æ½°
        if (startIndex === -1) startIndex = 0;

        let html = '';
        // é¡¯ç¤ºæœªä¾† 12 å°æ™‚
        for(let i = startIndex; i < startIndex + 12; i++) { 
            if(!data.hourly.time[i]) break;
            
            // ç›´æ¥åˆ‡å‰²å­—ä¸²å–å¾— "HH:00"
            const timeRaw = data.hourly.time[i]; // "2025-12-05T15:00"
            const timeDisplay = timeRaw.split('T')[1]; // "15:00"

            const temp = Math.round(data.hourly.temperature_2m[i]);
            const code = data.hourly.weather_code[i];
            
            // å¤©æ°£åœ–ç¤ºåˆ¤æ–·
            let icon = 'â˜€ï¸';
            if(code >= 1 && code <= 3) icon = 'â˜ï¸'; 
            else if(code >= 45 && code <= 48) icon = 'ğŸŒ«ï¸'; 
            else if(code >= 51 && code <= 67) icon = 'ğŸŒ§ï¸'; 
            else if(code >= 71 && code <= 77) icon = 'â„ï¸'; 
            else if(code >= 80 && code <= 82) icon = 'ğŸŒ¦ï¸'; 
            else if(code >= 95) icon = 'â›ˆï¸';

            html += `<div class="flex flex-col items-center min-w-[50px] snap-start">
                        <span class="text-xs text-gray-400">${timeDisplay}</span>
                        <span class="text-xl my-1">${icon}</span>
                        <span class="text-sm font-bold text-gray-700">${temp}Â°</span>
                     </div>`;
        }
        container.innerHTML = html;

    } catch(e) { 
        console.error("Weather Error:", e);
        container.innerHTML = '<div class="text-xs text-red-400 py-2">æš«æ™‚ç„¡æ³•å–å¾—å¤©æ°£</div>'; 
    }
}

        
        // --- ç›£è½é é¢åˆ·æ–°/é—œé–‰ï¼Œå„²å­˜ç•¶å‰ç‹€æ…‹ ---
window.addEventListener('beforeunload', () => {
    sessionStorage.setItem('lastTab', currentTab);
    sessionStorage.setItem('lastDateIdx', selectedDateIndex);
    sessionStorage.setItem('lastScrollY', window.scrollY);
});
        
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
