<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2025 æ²–ç¹©å…¨å®¶ç¦ (è³¼ç‰©å„ªåŒ–ç‰ˆ) ğŸŒº</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        body { font-family: 'M PLUS Rounded 1c', sans-serif; background-color: #FFF8E1; -webkit-tap-highlight-color: transparent; }
        
        /* UI Components */
        .shisa-header { background: linear-gradient(135deg, #FFAB91 0%, #FFCC80 100%); border-radius: 0 0 30px 30px; box-shadow: 0 4px 15px rgba(255, 167, 38, 0.3); }
        .card { background: white; border-radius: 20px; border: 2px solid #FFE0B2; transition: all 0.3s; overflow: hidden; position: relative; z-index: 10; }
        .card:active { transform: scale(0.98); }
        .card-active { border-color: #FF7043; box-shadow: 0 8px 20px rgba(255, 112, 67, 0.2); transform: scale(1.01); }
        
        /* Tags */
        .tag-eat { background: #FFECB3; color: #E65100; } .tag-spot { background: #B2EBF2; color: #006064; } .tag-trans { background: #E1BEE7; color: #4A148C; } .tag-hotel { background: #DCEDC8; color: #33691E; } .tag-prep { background: #F3E5F5; color: #7B1FA2; }
        
        /* Navigation & FAB */
        .bottom-nav { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-top: 1px solid #FFE0B2; }
        .nav-item.active { color: #FF7043; transform: translateY(-2px); }
        .nav-item { color: #90A4AE; transition: all 0.2s; }
        .fab-btn { position: fixed; bottom: 100px; right: 20px; width: 56px; height: 56px; background-color: #4CAF50; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 40; transition: transform 0.2s; }
        .fab-btn:active { transform: scale(0.9); }

        /* Scroll & Animation */
        .date-scroll, .weather-scroll { overflow-x: auto; white-space: nowrap; -ms-overflow-style: none; scrollbar-width: none; }
        .date-scroll::-webkit-scrollbar, .weather-scroll::-webkit-scrollbar { display: none; }
        .date-tab.active { background: #FF7043; color: white; border-color: #FF7043; }
        .snap-x-mandatory { scroll-snap-type: x mandatory; }
        .snap-center { scroll-snap-align: center; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .details-content { display: none; animation: slideDown 0.3s ease-out; }
        .details-content.show { display: block; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Modals */
        .modal-overlay, .detail-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 100; display: none; align-items: flex-end; justify-content: center; }
        .detail-modal-overlay { z-index: 200; background: rgba(0,0,0,0.7); backdrop-filter: blur(3px); }
        .modal-overlay.open, .detail-modal-overlay.open { display: flex; }
        .modal-sheet { background: white; width: 100%; border-radius: 20px 20px 0 0; padding: 20px; animation: slideUp 0.3s ease-out; max-height: 90vh; overflow-y: auto; padding-bottom: 40px; }
        .detail-sheet { background: #fff; width: 100%; height: 85vh; border-radius: 24px 24px 0 0; padding: 0; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); overflow: hidden; }
        .detail-modal-overlay.open .detail-sheet { transform: translateY(0); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        /* Elements */
        .detail-header-img { width: 100%; height: 250px; object-fit: cover; }
        .detail-body { padding: 24px; overflow-y: auto; padding-bottom: 100px; }
        .detail-handle { width: 40px; height: 5px; background: rgba(255,255,255,0.5); border-radius: 100px; position: absolute; top: 12px; left: 50%; transform: translateX(-50%); z-index: 10; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        .detail-close-btn { position: absolute; top: 16px; right: 16px; width: 32px; height: 32px; background: rgba(0,0,0,0.5); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 10; }
        .ticket-box { background-image: radial-gradient(circle at 0 50%, transparent 10px, #FFF5F5 11px), radial-gradient(circle at 100% 50%, transparent 10px, #FFF5F5 11px); border: 2px dashed #FFCDD2; color: #C62828; padding: 15px 25px; border-radius: 8px; position: relative; }
        .pdf-sheet { background: #fff; width: 90%; height: 80vh; border-radius: 8px; overflow-y: auto; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); font-family: 'Courier New', Courier, monospace; position: relative; margin: auto; align-self: center; }
        .pdf-label { font-size: 10px; color: #666; text-transform: uppercase; margin-bottom: 2px; }
        .voucher-card { border-left: 4px solid #FF7043; }
        .sync-status { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .sync-online { background-color: #4CAF50; box-shadow: 0 0 5px #4CAF50; }
        .sync-offline { background-color: #ccc; }
        .qty-btn { width: 40px; height: 40px; background: #f3f4f6; border-radius: 8px; font-weight: bold; color: #4b5563; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .qty-btn:active { background: #e5e7eb; }
        .shop-img-box { width: 90px; height: 90px; border-radius: 4px; overflow: hidden; background: #6b7280; /* æ·±ç°è‰²é è¨­èƒŒæ™¯ */display: flex; align-items: center; justify-content: center; flex-shrink: 0; border: 1px solid #e5e7eb; position: relative;/* æ–°å¢ï¼šæ»‘é¼ ç§»ä¸Šå»è®Šæˆæ”¾å¤§é¡ */cursor: zoom-in; transition: transform 0.1s; }
        /* é»æ“Šæ™‚çš„å°å‹•ç•« */
        .shop-img-box:active { transform: scale(0.95); }
        /* å¦‚æœæ²’æœ‰åœ–ç‰‡ (åªæœ‰ç°è‰²èƒŒæ™¯)ï¼ŒæŠŠæ»‘é¼ è®Šå›é è¨­ï¼Œé¿å…èª¤æœƒ */
        .shop-img-box.no-image { cursor: default;background: #6b7280; }
        .shop-img-box.no-image:active { transform: none; }
        .shop-img-box img { width: 100%; height: 100%; object-fit: cover; }
        /* ä¿æŒä¸Šæ¬¡è¨­å®šçš„è¼¸å…¥æ¡†å¯¬åº¦ */
        .jp-price-input-clean { border: 1px solid #d1d5db; border-radius: 6px; padding: 2px 4px; width: 70px; font-size: 15px; text-align: center; color: #374151; background: white; outline: none; transition: all 0.2s; }
        .jp-price-input-clean:focus { border-color: #f97316; box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.1); }
        .highlight-time { font-family: 'Courier New', monospace; font-weight: bold; color: #d97706; background: #fef3c7; padding: 2px 6px; border-radius: 4px; }
        .jp-price-input { width: 80px; padding: 4px; border: 1px solid #e5e7eb; border-radius: 4px; font-weight: bold; color: #ea580c; text-align: right; background: white; }
        /* æ–°å¢ï¼šç½®é ‚å®¹å™¨æ¨£å¼ */
.sticky-filters {
    position: sticky;
    top: 72px; /* é…åˆ Header é«˜åº¦ (ç´„ 70~80px)ï¼Œå›ºå®šåœ¨å®ƒä¸‹æ–¹ */
    z-index: 40;
    
    /* èƒŒæ™¯è‰²èˆ‡ body ä¸€è‡´ï¼ŒåŠ ä¸€é»é€æ˜åº¦èˆ‡æ¨¡ç³Š */
    background-color: rgba(255, 248, 225, 0.95); 
    backdrop-filter: blur(5px);
    
    /* ä¸Šä¸‹å„ç•™ 20pxï¼Œå·¦å³è£œå›å…§è· */
    padding: 20px 16px; 
    
    /* é—œéµï¼šä½¿ç”¨è² é‚Šç•ŒæŠµæ¶ˆåŸæœ¬ #app çš„ paddingï¼Œè®“èƒŒæ™¯æ»¿ç‰ˆ */
    margin-left: -16px; 
    margin-right: -16px;
    
    /* è¼•å¾®é™°å½±è®“å±¤æ¬¡åˆ†æ˜ */
    box-shadow: 0 4px 6px -4px rgba(0, 0, 0, 0.05);
}

/* ä¿®æ”¹ï¼šç§»é™¤åŸæœ¬çš„ marginï¼Œçµ±ä¸€ç”±å¤–å±¤ sticky-filters æ§åˆ¶é–“è· */
.filter-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0; /* æ”¹ç‚º 0 */
    gap: 8px;
}

/* ä¿æŒä¹‹å‰çš„æ¨£å¼ */
.filter-select {
    background: white;
    border: 1px solid #fed7aa;
    color: #4b5563;
    padding: 6px 10px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: bold;
    outline: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23f97316' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 8px center;
    background-size: 14px;
    padding-right: 28px;
    appearance: none;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

.rate-badge {
    font-size: 12px;
    color: #ea580c;
    background: #fff7ed;
    padding: 4px 8px;
    border-radius: 6px;
    border: 1px dashed #fdba74;
    font-weight: bold;
    white-space: nowrap;
}
/* --- è¨˜å¸³åŠŸèƒ½æ–°å¢æ¨£å¼ START --- */
.split-box {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 12px;
    margin-top: 8px;
}
.member-check {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 13px;
    background: white;
    padding: 6px 10px;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
    cursor: pointer;
}
.member-check.active {
    background: #eff6ff;
    border-color: #3b82f6;
    color: #1d4ed8;
    font-weight: bold;
}
.chart-container {
    position: relative; 
    height: 250px; 
    width: 100%;
    margin-bottom: 20px;
}
.person-card {
    background: white;
    border: 1px solid #fed7aa;
    border-radius: 12px;
    padding: 10px;
    text-align: center;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}
    </style>
</head>
<body class="pb-28">

    <!-- Header -->
    <div class="shisa-header sticky top-0 z-50 p-4 flex justify-between items-center text-white">
        <div>
            <h1 class="text-xl font-bold flex items-center gap-2">
                æ²–ç¹©å…¨å®¶ç¦ <span id="sync-indicator" class="sync-status sync-offline" title="é€£ç·šç‹€æ…‹"></span>
                <span id="current-role-badge" onclick="clearRole()" class="text-xs bg-white/20 px-2 py-1 rounded cursor-pointer hover:bg-white/40">åˆ‡æ›</span>
            </h1>
            <p id="header-desc" class="text-xs opacity-90 mt-1">12/25 - 12/29</p>
        </div>
        <div class="bg-white/20 backdrop-blur-sm rounded-full w-10 h-10 flex items-center justify-center text-2xl cursor-pointer shadow-sm border border-white/30" onclick="toggleDevMode()" id="header-icon">ğŸ¦</div>
    </div>

    <!-- Role Selector -->
    <div id="role-selector" class="fixed inset-0 bg-[#FFF8E1] z-[60] flex flex-col items-center justify-center p-6 space-y-8 hidden">
        <div class="text-center"><h2 class="text-3xl font-bold text-orange-600 mb-2">ä½ æ˜¯èª°ï¼Ÿ</h2><p class="text-gray-500">é¸æ“‡èº«ä»½ä»¥æä¾›æœ€é©åˆä½ çš„è³‡è¨Š</p></div>
        <div class="grid grid-cols-2 gap-4 w-full max-w-sm">
            <button onclick="selectRole('driver')" class="bg-white p-4 rounded-2xl shadow-lg border-2 border-orange-100 flex flex-col items-center gap-2 hover:bg-orange-50"><div class="text-4xl">ğŸš—</div><div class="font-bold text-gray-700">å¦¹å¦¹ (é§•é§›)</div></button>
            <button onclick="selectRole('copilot')" class="bg-white p-4 rounded-2xl shadow-lg border-2 border-orange-100 flex flex-col items-center gap-2 hover:bg-orange-50"><div class="text-4xl">ğŸ—ºï¸</div><div class="font-bold text-gray-700">çˆ¸çˆ¸ (å‰¯é§•)</div></button>
            <button onclick="selectRole('tourist')" class="bg-white p-4 rounded-2xl shadow-lg border-2 border-orange-100 flex flex-col items-center gap-2 hover:bg-orange-50"><div class="text-4xl">ğŸ“¸</div><div class="font-bold text-gray-700">åª½åª½ (éŠå®¢)</div></button>
            <button onclick="selectRole('admin')" class="bg-white p-4 rounded-2xl shadow-lg border-2 border-orange-100 flex flex-col items-center gap-2 hover:bg-orange-50"><div class="text-4xl">ğŸ“</div><div class="font-bold text-gray-700">æˆ‘ (ä¸»æª)</div></button>
        </div>
    </div>

    <!-- Main Content -->
    <div id="app" class="p-4 space-y-6"></div>

    <!-- Modals -->
    <div id="modal-detail" class="detail-modal-overlay" onclick="closeDetailModal()"><div id="modal-detail-content" class="detail-sheet" onclick="event.stopPropagation()"></div></div>
    <div id="modal-pdf" class="modal-overlay" style="z-index: 1000;" onclick="closePdfModal()"><div class="pdf-sheet" onclick="event.stopPropagation()"><button onclick="closePdfModal()" class="absolute top-4 right-4 text-2xl text-gray-400 hover:text-black"><i class="fa-solid fa-xmark"></i></button><div id="pdf-content"></div></div></div>

    <!-- Shopping Modal -->
    <div id="modal-shopping" class="modal-overlay" onclick="closeModal('modal-shopping')">
        <div class="modal-sheet space-y-4" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-700" id="shop-modal-title">æ–°å¢å¿…è²· & æ¯”åƒ¹</h3>
                <button onclick="closeModal('modal-shopping')" class="text-gray-400"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <input type="hidden" id="in-shop-key">
            <input id="in-shop-img" placeholder="åœ–ç‰‡é€£çµ URL æˆ– æª”å (é¸å¡«)" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 text-sm">
            <div class="grid grid-cols-3 gap-2">
                <select id="in-shop-cat" class="p-3 bg-white rounded-xl border border-orange-200 font-bold text-gray-700"><option value="è—¥å¦">ğŸ’Š è—¥å¦</option><option value="é›¶é£Ÿ">ğŸª é›¶é£Ÿ</option><option value="é›»å™¨">ğŸ”Œ é›»å™¨</option><option value="è¡£ç‰©">ğŸ‘• è¡£ç‰©</option><option value="é›œè²¨">ğŸ é›œè²¨</option></select>
                <input id="in-shop-store" placeholder="å•†åº— (å¦‚: å¤§åœ‹)" class="col-span-2 p-3 bg-gray-50 rounded-xl border border-gray-200">
            </div>
            <input id="in-shop-item" placeholder="å“å (å¦‚: åˆåˆ©ä»–å‘½)" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
            <div class="grid grid-cols-2 gap-3 bg-blue-50 p-3 rounded-xl border border-blue-100">
                <div><label class="text-xs text-gray-500 font-bold">ğŸ‡¹ğŸ‡¼ å°ç£å”®åƒ¹</label><input id="in-shop-tw" type="number" placeholder="NT$" class="w-full p-2 bg-white rounded border border-blue-200 mt-1"></div>
                <div><label class="text-xs text-gray-500 font-bold">ğŸ‡¯ğŸ‡µ æ—¥æœ¬å”®åƒ¹</label><input id="in-shop-jp" type="number" placeholder="Â¥" class="w-full p-2 bg-white rounded border border-blue-200 mt-1"></div>
                <div class="col-span-2 text-center text-xs text-blue-500 pt-1">è¼¸å…¥æ—¥æœ¬åƒ¹æ ¼è‡ªå‹•è¨ˆç®—åŒ¯ç‡ (0.218)</div>
            </div>
            <button onclick="saveShopItem()" class="w-full bg-pink-500 text-white font-bold py-3 rounded-xl shadow-lg mt-2">å„²å­˜</button>
        </div>
    </div>
    
    <!-- Budget Modal -->
    <div id="modal-budget" class="modal-overlay" onclick="closeModal('modal-budget')">
        <div class="modal-sheet space-y-4" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center"><h3 class="text-xl font-bold text-gray-700">è¨˜ä¸€ç­†æ”¯å‡º</h3><button onclick="closeModal('modal-budget')" class="text-gray-400"><i class="fa-solid fa-xmark text-xl"></i></button></div>
            <div class="bg-gray-50 p-2 rounded-xl border border-gray-200"><label class="text-xs text-gray-500 font-bold ml-1">æ—¥æœŸèˆ‡æ™‚é–“</label><input id="in-ex-time" type="datetime-local" class="w-full bg-transparent font-bold text-gray-700 outline-none mt-1"></div>
            <select id="in-ex-category" class="w-full p-3 bg-white rounded-xl border border-orange-200 text-gray-700 font-bold"><option value="é£Ÿç‰©">ğŸ” é£Ÿç‰©</option><option value="è³¼ç‰©">ğŸ›ï¸ è³¼ç‰©</option><option value="äº¤é€š">ğŸš— äº¤é€š</option><option value="é–€ç¥¨">ğŸ« é–€ç¥¨</option><option value="å…¶ä»–">ğŸ’¸ å…¶ä»–</option></select>
            <input id="in-ex-store" placeholder="å•†åº—/é¤å»³ (é¸å¡«)" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
            <input id="in-ex-item" placeholder="å“å/å…§å®¹" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200">
            <div class="grid grid-cols-2 gap-3"><input id="in-ex-price" type="number" placeholder="æ—¥å¹£å–®åƒ¹" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200"><div class="flex items-center gap-2"><button class="qty-btn" onclick="adjustQty(-1)">-</button><input id="in-ex-qty" type="number" value="1" class="w-full p-3 text-center bg-gray-50 rounded-xl border border-gray-200" readonly><button class="qty-btn" onclick="adjustQty(1)">+</button></div></div>
            <select id="in-ex-pay" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 text-gray-700"><option value="ç¾é‡‘">ğŸ’µ ç¾é‡‘</option><option value="ä¿¡ç”¨å¡">ğŸ’³ ä¿¡ç”¨å¡</option><option value="Suica/ICå¡">ğŸ§ Suica / ICå¡</option></select>
            <div class="bg-orange-50 p-4 rounded-xl text-center border border-orange-100"><div class="text-sm text-gray-500 mb-1">ç¸½é‡‘é¡ (å–®åƒ¹ x æ•¸é‡)</div><div class="text-2xl font-bold text-orange-600">Â¥<span id="calc-total">0</span></div><div class="text-sm font-bold text-blue-500 mt-1">â‰ˆ NT$<span id="calc-twd">0</span></div></div>
            <button onclick="addExpense()" class="w-full bg-orange-500 text-white font-bold py-3 rounded-xl shadow-lg mt-2">å„²å­˜ç´€éŒ„</button>
        </div>
    </div>

    <!-- Translation Modal -->
    <div id="trans-modal" class="fixed inset-0 bg-black/80 z-[110] hidden flex-col items-center justify-center p-6" onclick="closeTranslation()"><div class="bg-white rounded-2xl p-6 w-full max-w-sm text-center space-y-4" onclick="event.stopPropagation()"><h3 class="font-bold text-xl text-orange-600 border-b pb-2">ğŸ‡¯ğŸ‡µ å¹«æˆ‘èªªæ—¥æ–‡</h3><div class="grid grid-cols-2 gap-3"><div class="bg-gray-50 p-3 rounded-lg border text-left"><div class="text-xs text-gray-400">çµå¸³</div><div class="font-bold text-lg">ãŠä¼šè¨ˆ (Okai-kei)</div></div><div class="bg-gray-50 p-3 rounded-lg border text-left"><div class="text-xs text-gray-400">è¬è¬</div><div class="font-bold text-lg">ã‚ã‚ŠãŒã¨ã† (Arigatou)</div></div><div class="bg-gray-50 p-3 rounded-lg border text-left"><div class="text-xs text-gray-400">å»æ‰€</div><div class="font-bold text-lg">ãƒˆã‚¤ãƒ¬ (Toire)</div></div><div class="bg-gray-50 p-3 rounded-lg border text-left"><div class="text-xs text-gray-400">æ°´</div><div class="font-bold text-lg">ãŠæ°´ (Omizu)</div></div><div class="bg-gray-50 p-3 rounded-lg border text-left col-span-2"><div class="text-xs text-gray-400">ä¸å¥½æ„æ€ / è«‹å•</div><div class="font-bold text-lg">ã™ã¿ã¾ã›ã‚“ (Sumimasen)</div></div></div><button onclick="closeTranslation()" class="bg-gray-200 text-gray-700 px-8 py-3 rounded-full font-bold w-full mt-2">é—œé–‰</button></div></div>

    <!-- Navigation -->
    <div class="bottom-nav fixed bottom-0 w-full h-[80px] bg-white/95 backdrop-blur-md border-t border-orange-100 flex justify-between items-center px-4 pb-2 z-50">
        <div class="flex-1 flex justify-around items-end">
            <button onclick="switchTab('schedule')" id="btn-schedule" class="nav-item flex flex-col items-center p-2 w-14 transition active:scale-95"><i class="fa-regular fa-calendar-days text-xl mb-1"></i><span class="text-[10px] font-bold">è¡Œç¨‹</span></button>
            <button onclick="switchTab('vouchers')" id="btn-vouchers" class="nav-item flex flex-col items-center p-2 w-14 transition active:scale-95"><i class="fa-solid fa-ticket text-xl mb-1"></i><span class="text-[10px] font-bold">æ†‘è­‰</span></button>
        </div>
        <div class="relative w-20 flex justify-center z-10">
            <button onclick="switchTab('home')" id="btn-home" class="absolute -top-10 w-16 h-16 bg-gradient-to-br from-orange-400 to-orange-600 rounded-full shadow-lg shadow-orange-200 border-4 border-[#FFF8E1] text-white flex items-center justify-center transform transition hover:scale-105 active:scale-95"><i class="fa-solid fa-house text-2xl"></i></button>
            <span class="absolute top-8 text-[10px] font-bold text-orange-500">é¦–é </span>
        </div>
        <div class="flex-1 flex justify-around items-end">
            <button onclick="switchTab('shopping')" id="btn-shopping" class="nav-item flex flex-col items-center p-2 w-14 transition active:scale-95"><i class="fa-solid fa-bag-shopping text-xl mb-1"></i><span class="text-[10px] font-bold">å¿…è²·</span></button>
            <button onclick="switchTab('budget')" id="btn-budget" class="nav-item flex flex-col items-center p-2 w-14 transition active:scale-95"><i class="fa-solid fa-wallet text-xl mb-1"></i><span class="text-[10px] font-bold">è¨˜å¸³</span></button>
        </div>
    </div>

    <script>
        // --- æ–°å¢ç¯©é¸ç‹€æ…‹è®Šæ•¸ ---
let currentCategoryFilter = 'all';
let currentStoreFilter = 'all';

// --- æ–°å¢ç¯©é¸æ›´æ–°å‡½å¼ ---
function updateFilter(type, value) {
    if (type === 'category') currentCategoryFilter = value;
    if (type === 'store') currentStoreFilter = value;
    renderShopping(); // é‡æ–°æ¸²æŸ“ç•«é¢
}
        
        const firebaseConfig = {
            apiKey: "AIzaSyDLahJlYtLuCYrZBgiSYl7FqfOICJkJBd0",
            authDomain: "okinawa-202512.firebaseapp.com",
            databaseURL: "https://okinawa-202512-default-rtdb.firebaseio.com",
            projectId: "okinawa-202512",
            storageBucket: "okinawa-202512.firebasestorage.app",
            messagingSenderId: "932908173572",
            appId: "1:932908173572:web:bad7f92fd5e8e57948e851",
            measurementId: "G-HE116G25W0"
        };

        let db = null;
        try {
            if(firebaseConfig.apiKey) {
                firebase.initializeApp(firebaseConfig);
                db = firebase.database();
                document.getElementById('sync-indicator').classList.remove('sync-offline');
                document.getElementById('sync-indicator').classList.add('sync-online');
            }
        } catch (e) { console.error("Firebase Init Error", e); }

        let currentRole = localStorage.getItem('user_role'); 
        let currentSimulatedDate = null;
        let selectedDateIndex = 0;
        let currentTab = 'home';
        const JPY_RATE = 0.218;

        const PACKING_KEY = 'okinawa_packing_v3'; 
        const defaultPackingList = [
            { id: 'imp1', text: "è­·ç…§ (æ•ˆæœŸ6å€‹æœˆä»¥ä¸Š)", category: "é‡è¦", done: false }, { id: 'imp2', text: "é§•ç…§ + ä¸­æ–‡è­¯æœ¬", category: "é‡è¦", done: false }, { id: 'imp3', text: "ç™»æ©Ÿè­‰ (é›»å­/ç´™æœ¬)", category: "é‡è¦", done: false }, { id: 'imp4', text: "éŒ¢åŒ… (å¡/æ—¥å¹£/å°å¹£)", category: "é‡è¦", done: false }, { id: 'imp5', text: "SIM å¡ (4å¼µ)", category: "é‡è¦", done: false }, { id: 'imp6', text: "é‘°åŒ™", category: "é‡è¦", done: false },
            { id: 't1', text: "ç‰™åˆ·ã€ç‰™è†ã€ç‰™ç·š", category: "ç›¥æ´—", done: false }, { id: 't2', text: "æ´—æ²è­·é«®ã€æ´—é¢ä¹³", category: "ç›¥æ´—", done: false }, { id: 't3', text: "é«®æ²¹ã€æ¢³å­ã€é¯Šé­šå¤¾", category: "ç›¥æ´—", done: false }, { id: 't4', text: "æ¯›å·¾ã€æµ´å·¾", category: "ç›¥æ´—", done: false }, { id: 't5', text: "åŒ–å¦å“ã€ä¿é¤Šå“", category: "ç›¥æ´—", done: false }, { id: 't6', text: "éš±å½¢çœ¼é¡ã€æ°´ç›’", category: "ç›¥æ´—", done: false },
            { id: 'c1', text: "å¤–å‡ºè¡£æœ (5å¤©)", category: "è¡£ç‰©", done: false }, { id: 'c2', text: "å…§è¡£è¤²ã€è¥ªå­", category: "è¡£ç‰©", done: false }, { id: 'c3', text: "ç¡è¡£ã€æ‹–é‹", category: "è¡£ç‰©", done: false }, { id: 'c4', text: "å¤–å¥—ã€å¸½å­ã€å¢¨é¡", category: "è¡£ç‰©", done: false }, { id: 'e1', text: "å……é›»å™¨ã€ç·šã€è¡Œå……", category: "é›»å­", done: false }, { id: 'e2', text: "å°èˆªæ‰‹æ©Ÿæ¶", category: "é›»å­", done: false }, { id: 'o1', text: "éš¨èº«åŒ…ã€ç’°ä¿è¢‹", category: "é›œé …", done: false }, { id: 'o2', text: "é›¨å‚˜ã€æ°´å£º", category: "é›œé …", done: false }, { id: 'o3', text: "é˜²èšŠæ¶²ã€é˜²æ›¬", category: "é›œé …", done: false }, { id: 'o4', text: "å€‹äººè—¥å“", category: "é›œé …", done: false }, { id: 'o5', text: "è²“æ¢", category: "é›œé …", done: false }
        ];
        const SHOPPING_KEY = 'okinawa_shop_local_v6'; 
        const defaultShoppingList = [
            { id: 's1', category: 'é›œè²¨', store: 'é‚£éœ¸æ©Ÿå ´/å–®è»Œ', item: 'OKIKA äº¤é€šå¡', priceJp: 2000, priceTw: 440, done: false },
            { id: 's2', category: 'é›»å™¨', store: 'ä¾¿åˆ©å•†åº—/è¶…å¸‚', item: 'æ‹ç«‹å¾— (Instant Camera)', priceJp: 15000, priceTw: 3300, done: false },
            { id: 's3', category: 'è¡£ç‰©', store: 'ç¾åœ‹æ‘ American Depot', item: 'å¤è‘— (Vintage)', priceJp: 3500, priceTw: 770, done: false },
            { id: 's4', category: 'é›œè²¨', store: 'Parco City 3F', item: 'ç…è–© (Shisa) æ“ºé£¾', priceJp: 2500, priceTw: 550, done: false },
            { id: 's5', category: 'é›¶é£Ÿ', store: 'Parco City 1F', item: 'å¿…è²·é¤…ä¹¾/ä¼´æ‰‹ç¦®', priceJp: 1200, priceTw: 260, done: false },
            { id: 's6', category: 'é›œè²¨', store: 'Parco City 1F', item: '3COINS+ ç”Ÿæ´»å°ç‰©', priceJp: 330, priceTw: 70, done: false },
            { id: 's7', category: 'é›¶é£Ÿ', store: 'åœ‹éš›é€š', item: 'ä¸–ç•Œç¬¬ä¸€è˜‹æœæ´¾', priceJp: 450, priceTw: 100, done: false },
            { id: 's8', category: 'é›œè²¨', store: 'å£ºå±‹é€šé™¶ç“·è¡—', item: 'æ²–ç¹©é™¶å™¨ (Yachimun)', priceJp: 3000, priceTw: 660, done: false },
            { id: 's9', category: 'é›œè²¨', store: 'æ³¢ä¸Šå®®', item: 'é–‹é‹å¾¡å®ˆ', priceJp: 800, priceTw: 175, done: false },
            { id: 's10', category: 'é›œè²¨', store: 'åŒ—è°· GIGO', item: 'æ‰­è›‹', priceJp: 500, priceTw: 110, done: false }
        ];
        const EXPENSE_KEY = 'okinawa_expenses_local_v2';
        const okinawaEvents = [
            { title: "æ±å—æ¤ç‰©æ¨‚åœ’ ç‡ˆå…‰ç§€", date: "10/25 - 5/25", loc: "æ²–ç¹©å¸‚", img: "https://www.okinawastory.jp/feature/illumination/images/spot01_img01.jpg", link: "https://www.google.com/maps/search/Southeast+Botanical+Gardens" },
            { title: "ç³¸æ»¿å’Œå¹³ç‡ˆé£¾", date: "12/13 - 1/03", loc: "ç³¸æ»¿å¸‚", img: "https://www.okinawastory.jp/feature/illumination/images/spot04_img01.jpg", link: "https://www.google.com/maps/search/Itoman+Peaceful+Illumination" },
            { title: "ç‰çƒç‡ˆæœƒ (èª­è°·)", date: "12/01 - 3/31", loc: "è®€è°·æ‘", img: "https://lantan.ryukyu/wp-content/uploads/2023/10/img_main_sp.jpg", link: "https://www.google.com/maps/search/Murasaki+Mura+Ryukyu+Kingdom+Theme+Park" },
            { title: "å…’ç«¥ç‹åœ‹ è–èª•å¤¢å¹»", date: "12/20 - 1/05", loc: "æ²–ç¹©å¸‚", img: "https://www.xmas-fantasy.com/images/main_sp.jpg", link: "https://www.google.com/maps/search/Okinawa+Zoo+Museum" },
            { title: "ç¾åœ‹æ‘ è–èª•ç‡ˆé£¾", date: "11/15 - 3/14", loc: "åŒ—è°·ç”º", img: "https://www.okinawastory.jp/feature/illumination/images/spot02_img01.jpg", link: "https://www.google.com/maps/search/American+Village+Okinawa" }
        ];

        const tripData = [
            {
                date: "12/25", fullDate: "2025/12/25", day: "é€±å››", weather: "â˜ï¸ 20Â°C",
                events: [
                    { time: "14:50", title: "Uber å‡ºç™¼åŒ—è»Š", type: "trans", guide: "è­·ç…§ã€æ‰‹æ©Ÿã€éŒ¢åŒ…å¸¶äº†å—ï¼Ÿ", appLink: { url: "https://m.uber.com/ul", text: "é–‹å•Ÿ Uber", icon: "fa-brands fa-uber" }, travel: { mode: 'train', time: '40åˆ†' } },
                    { time: "15:20", title: "æ©Ÿæ·å¾€æ©Ÿå ´ (ç›´é”è»Š)", type: "trans", guide: "A1 å°åŒ—è»Šç«™ -> A13 ç¬¬ä¸€èˆªå»ˆ", frequency: "ç´„ 15 åˆ†é˜ä¸€ç­", timetableUrl: "https://www.tymetro.com.tw/tymetro-new/tw/_pages/travel-guide/timetable.php" },
                    { time: "16:30", title: "æ©Ÿå ´ Check-in", type: "trans", title_detail: "æ¨‚æ¡ƒ MM930", bookingInfo: { code: "1616324336315022", note: "Trip.com è¨‚å–®", extra: "T1 | 20kg è¨—é‹ / 7kg æ‰‹æ | ç™»æ©Ÿé–€: ç¾å ´ç¢ºèª", pdfContent: "èˆªç­ï¼šMM930\nèµ·é£›ï¼š18:20 (T1)\næŠµé”ï¼š20:50 (D)\n\nä¹˜å®¢ï¼š\n1. Chen Szu Yu\n2. Chen Ru Xuan\n3. Chen Chien Liang\n4. Hsu Mei Ling\n\nè¡Œæï¼š\nè¨—é‹ 20kg x 4\næ‰‹æ 7kg x 4", voucherImg: "flight_go.jpg" }, guide: "18:20 èµ·é£› -> 20:50 æŠµé” (D)ã€‚" },
                    { time: "21:30", title: "å–®è»Œåˆ—è»Šå¾€å¸‚å€", type: "trans", guide: "é‚£éœ¸æ©Ÿå ´ç«™ -> ç¾æ¦®æ©‹ç«™ã€‚", frequency: "ç´„ 10-12 åˆ†é˜ä¸€ç­", timetableUrl: "https://www.yui-rail.co.jp/tc/timetable/", travel: { mode: 'walk', time: '5åˆ†' } },
                    { time: "22:00", title: "æ±æ©«INN ç¾æ¦®æ©‹", type: "hotel", mapCode: "33 157 154*55", bookingInfo: { code: "æœƒå“¡å¡ Check-in", note: "ç¾å ´ä»˜æ¬¾" } },
                    { time: "22:30", title: "æ™šé¤é¸æ“‡ (å·¦å³æ»‘å‹•)", type: "choice", choices: [ { title: "è¦æ¹¯æ‹‰éºµ Chanya", type: "eat", guide: "æ¿ƒéƒè¦æ¹¯é ­ï¼Œç‡Ÿæ¥­è‡³æ·±å¤œã€‚", mapCode: "33 157 435*30", link: "https://maps.app.goo.gl/Chanya", detailInfo: { desc: "æ¿ƒéƒé®®ç”œçš„è¦æ¹¯æ‹‰éºµã€‚", tags: ["æ‹‰éºµ","å®µå¤œ"], menu:[{n:"è¦æ¹¯æ‹‰éºµ",p:"Â¥980"}] } }, { title: "ç‰çƒä¸­è¯ è›™å½", type: "eat", guide: "å‰µæ„ä¸­è¯æ–™ç†ï¼Œæœ‰è¨‚ä½ã€‚", mapCode: "33 157 288*22", link: "https://maps.app.goo.gl/Waon", detailInfo: { desc: "æ™‚å°šçš„å‰µæ„ä¸­è¯æ–™ç†ã€‚", tags: ["ä¸­è¯","è¨‚ä½"], menu:[{n:"ç´…æ²¹æŠ„æ‰‹",p:"Â¥680"},{n:"æ“”æ“”éºµ",p:"Â¥880"}] } } ] }
                ]
            },
            {
                date: "12/26", fullDate: "2025/12/26", day: "é€±äº”", weather: "â˜€ï¸ 21Â°C",
                events: [
                    { time: "06:00", title: "èµ·åºŠ & æ—©é¤", type: "prep", guide: "é£¯åº—æ—©é¤ã€‚è«‹æº–æ™‚æ•´ç†è¡Œæã€‚", departureTime: "08:00 æº–æ™‚å‡ºç™¼", travel: { mode: 'trans', time: '30åˆ†' } },
                    { time: "08:30", title: "OTS ç§Ÿè»Š (è‡¨ç©ºè±å´)", type: "trans", mapCode: "232 543 502*66", bookingInfo: { code: "Email", note: "é ç´„åï¼šChen Ru Xuan" }, guide: "å³é§•å£è¨£ï¼šé å·¦é–‹ï¼Œé›¨åˆ·åœ¨å·¦ï¼Œæ–¹å‘ç‡ˆåœ¨å³ã€‚", travel: { mode: 'drive', time: '30åˆ†' } },
                    { time: "10:30", title: "Once a Week Coffee", type: "eat", guide: "å¿…åƒè‚‰æ¡‚æ²ï¼Œåœç•™ 10 åˆ†é˜è²·äº†è»Šä¸Šåƒã€‚", menu: [{n:"è‚‰æ¡‚æ²", j:"ã‚·ãƒŠãƒ¢ãƒ³ãƒ­ãƒ¼ãƒ«"}], travel: { mode: 'drive', time: '15åˆ†' } },
                    { time: "11:00", title: "æ¸¯å·å¤–äººå±…ä½å®…", type: "spot", mapCode: "33 341 063*55", imgUrl: "https://images.unsplash.com/photo-1516483638261-f4dbaf036963?w=500", detailInfo: { desc: "å‰ç¾è»å®¿èˆæ”¹å»ºçš„æ–‡é’èšè½ã€‚", tags: ["æ‹ç…§", "ç”œé»"], highlights: ["O'Hacorte æ°´æœå¡”", "houkiboshi å¯éº—éœ²"] }, travel: { mode: 'drive', time: '20åˆ†' } },
                    { time: "12:30", title: "æ™®å¤©æ»¿å®®", type: "spot", mapCode: "33 438 616*33", guide: "å®œé‡ç£å¸‚çš„èƒ½é‡æ™¯é»ï¼Œæœ‰é˜ä¹³çŸ³æ´ç©´ã€‚", travel: { mode: 'drive', time: '30åˆ†' } },
                    { time: "14:30", title: "åˆé¤ï¼šå£½å¸å¸‚å ´ æ³¡ç€¨åº—", type: "eat", mapCode: "33 531 366*44", detailInfo: { desc: "äººæ°£è¿´è½‰å£½å¸ï¼ŒCPå€¼é«˜ã€‚", tags: ["å£½å¸", "å¹³åƒ¹"], menu: [{n:"ç‚™ç‡’é®­é­š", p:"Â¥100"}, {n:"é®ªé­šå¤§è…¹", p:"Â¥300"}] }, travel: { mode: 'drive', time: '15åˆ†' } },
                    { time: "15:50", title: "æ³¡ç€¨æ¼æ¸¯ / AEON Mall", type: "spot", guide: "è¦–æ™‚é–“æ±ºå®šï¼šæƒ³åƒæµ·è†½ç„—çƒ¤å»æ¼æ¸¯ï¼Œæƒ³é€›è¡—å» AEON Rycomã€‚", travel: { mode: 'drive', time: '20åˆ†' } },
                    { time: "18:00", title: "æ™šé¤ï¼šé˜¿å¤è±¬é‹", type: "eat", title_detail: "Chatan Dining Chaabu", mapCode: "33 526 212*25", bookingInfo: { code: "3JYNWGHFKM", note: "Tabelog é ç´„", pdfContent: "é ç´„è™Ÿï¼š3JYNWGHFKM\næ™‚é–“ï¼š12/26 18:00\näººæ•¸ï¼š4ä½\n\n*ç³»çµ±è²» Â¥1,760 å·²ä»˜", voucherImg: "dinner_day2.jpg" }, detailInfo: { desc: "ä½æ–¼åŒ—è°·çš„é˜¿å¤è±¬æ¶®æ¶®é‹ååº—ã€‚", tags: ["é˜¿å¤è±¬", "æ¶®æ¶®é‹"], menu: [{n:"é˜¿å¤è±¬æ¶®æ¶®é‹", p:"Â¥3,500"}] }, travel: { mode: 'walk', time: '5åˆ†' } },
                    { time: "19:40", title: "ç¾æ¿±æ—¥è½åº¦å‡é£¯åº—", type: "hotel", title_detail: "Sunset Resort Mihama", mapCode: "33 525 205*74", bookingInfo: { code: "1616323760441360", note: "PIN: 1047", extra: "å·²ä»˜ Â¥9,424", pdfContent: "è¨‚å–®è™Ÿï¼š1616323760441360\nPINç¢¼ï¼š1047\nå…¥ä½ï¼š12/26 - 12/28 (2æ™š)\næˆ¿å‹ï¼šæ¨™æº–é›™åºŠæˆ¿ x1", voucherImg: "hotel_mihama.jpg" } },
                    { time: "20:10", title: "ç¾åœ‹æ‘é€›é€›", type: "spot", mapCode: "33 526 450*63", guide: "å¯ä»¥å»å¤§åœ‹è—¥å¦è£œè²¨ï¼Œæ‘©å¤©è¼ªæ‹ç…§ã€‚" }
                ]
            },
            {
                date: "12/27", fullDate: "2025/12/27", day: "é€±å…­", weather: "â›… 22Â°C",
                events: [
                    { time: "06:00", title: "èµ·åºŠ", type: "prep", guide: "æ—©é¤å¤–é¢è²·ï¼Œè»Šä¸Šåƒã€‚", departureTime: "07:30 å‡ºç™¼å¾€åŒ—éƒ¨", travel: { mode: 'drive', time: '45åˆ†' } },
                    { time: "08:30", title: "è¨±ç”°ä¼‘æ¯ç«™", type: "spot", mapCode: "206 476 706*66", guide: "å¿…åƒï¼šç‚¸å¤©å©¦ç¾…ã€é»‘ç³–çƒã€‚", travel: { mode: 'drive', time: '30åˆ†' } },
                    { time: "09:45", title: "Panchori-na éºµåŒ…åº—", type: "eat", guide: "å¯æ„›éºµåŒ…åº—ï¼Œåœç•™ 30 åˆ†é˜ã€‚", travel: { mode: 'drive', time: '30åˆ†' } },
                    { time: "11:00", title: "åˆé¤ï¼šè¦è¦é£¯", type: "eat", mapCode: "485 692 167*55", detailInfo: { desc: "å¤å®‡åˆ©å³¶å¿…åƒï¼å»ºè­°å…ˆæ‰¾åº§ä½ã€‚", tags: ["æµ·æ™¯", "è¦é£¯"], menu: [{n:"åŸå‘³å¤§è’œè¦é£¯", p:"Â¥1,400"}] }, travel: { mode: 'drive', time: '40åˆ†' } },
                    { time: "13:20", title: "ç¾éº—æµ·æ°´æ—é¤¨", type: "spot", mapCode: "553 075 797*77", detailInfo: { desc: "äºæ´²æœ€å¤§æ°´æ—é¤¨ä¹‹ä¸€ï¼Œé»‘æ½®ä¹‹æµ·å¿…çœ‹ã€‚", tags: ["é¯¨é¯Š", "æµ·è±šç§€"], highlights: ["é»‘æ½®ä¹‹æµ·", "æˆ¶å¤–æµ·è±šåŠ‡å ´"] }, travel: { mode: 'drive', time: '50åˆ†' } },
                    { time: "17:00", title: "æ™šé¤ï¼šObaa no Ya ç‡’è‚‰", type: "eat", title_detail: "Obaa no Ya (åè­·ç‡’è‚‰)", mapCode: "206 598 371*14", bookingInfo: { code: "2QZLY2AV4K", note: "Tabelog é ç´„", pdfContent: "é ç´„è™Ÿï¼š2QZLY2AV4K\næ™‚é–“ï¼š12/27 17:00\näººæ•¸ï¼š4ä½\n\n*ç•¶å¤©å–æ¶ˆæ”¶è²» Â¥3000/äºº", voucherImg: "dinner_day3.jpg" }, detailInfo: { desc: "åè­·äººæ°£ç‡’è‚‰ï¼Œç‚­ç«ç‡’çƒ¤é¢¨å‘³çµ•ä½³ã€‚", tags: ["ç‡’è‚‰", "å’Œç‰›"], menu: [{n:"ç‰¹ä¸Šç‰›äº”èŠ±", p:"Â¥1,800"}] }, travel: { mode: 'drive', time: '40åˆ†' } },
                    { time: "20:00", title: "ç¾åœ‹æ‘ç…™ç«", type: "spot", guide: "é€±å…­é™å®šï¼è§€è³é»ï¼šåŒ—è°·æ—¥è½æ­¥é“ã€‚" }
                ]
            },
            {
                date: "12/28", fullDate: "2025/12/28", day: "é€±æ—¥", weather: "ğŸŒ§ï¸ 20Â°C",
                events: [
                    { time: "06:00", title: "èµ·åºŠ & é€€æˆ¿", type: "prep", guide: "11:00 å‰é€€æˆ¿ã€‚", departureTime: "07:30 å‡ºç™¼", travel: { mode: 'drive', time: '30åˆ†' } },
                    { time: "08:00", title: "æ—©é¤ï¼šA&W æ¼¢å ¡", type: "eat", mapCode: "33 341 602*66", guide: "å¿…é» Root Beer (æ²™å£«)ã€‚", travel: { mode: 'drive', time: '30åˆ†' } },
                    { time: "09:30", title: "ç€¨é•·å³¶ Umikaji", type: "spot", mapCode: "33 002 605*15", guide: "å¸Œè‡˜é¢¨æƒ…ç™½è‰²å»ºç¯‰ï¼Œçœ‹é£›æ©Ÿèµ·é™ã€‚", travel: { mode: 'drive', time: '30åˆ†' } },
                    { time: "11:30", title: "åˆé¤ï¼šæ²–ç¹©éºµ / ç¾©å¤§åˆ©éºµ", type: "eat", guide: "Yagiya (æ²–ç¹©éºµ) æˆ– The Slow (ç¾©å¤§åˆ©éºµ)ã€‚", travel: { mode: 'drive', time: '20åˆ†' } },
                    { time: "12:30", title: "Shinmei Coffee", type: "eat", guide: "å¤æ°‘å®¶å’–å•¡ï¼Œæ¨è–¦é»‘ç³–æ‹¿éµã€‚", travel: { mode: 'drive', time: '20åˆ†' } },
                    { time: "14:00", title: "ç‰æ³‰æ´ (ç‹åœ‹æ‘)", type: "spot", mapCode: "232 495 330*28", guide: "é˜ä¹³çŸ³æ´ï¼Œå‡ºä¾†çœ‹å¤ªé¼“è¡¨æ¼”ã€‚", travel: { mode: 'drive', time: '20åˆ†' } },
                    { time: "17:00", title: "å¥§æ­¦å³¶ (è²“å³¶)", type: "spot", mapCode: "232 468 336*41", guide: "å¿…è²·ï¼šä¸­æœ¬é®®é­šåº—å¤©å©¦ç¾…ã€‚", travel: { mode: 'drive', time: '15åˆ†' } },
                    { time: "17:30", title: "Gangalaä¹‹è°· å°è¦½", type: "spot", mapCode: "232 495 330*28", bookingInfo: { code: "0Y0BGC4I", note: "Nutmeg é ç´„", pdfContent: "é ç´„è™Ÿï¼š0Y0BGC4I\næ™‚é–“ï¼š12/28 17:30\n\n*è«‹ææ—©15åˆ†é˜é›†åˆ", voucherImg: "gangala.jpg" }, detailInfo: { desc: "å¤ªå¤æ£®æ—å°è¦½ï¼Œé›†åˆæ™‚é–“ 17:30ã€‚", tags: ["è‡ªç„¶", "å°è¦½"], highlights: ["å·¨å¤§æ¦•æ¨¹", "CAVE CAFE"] }, travel: { mode: 'drive', time: '40åˆ†' } },
                    { time: "20:00", title: "æ±æ©«INN é‚£éœ¸æ—­æ©‹", type: "hotel", bookingInfo: { code: "æœƒå“¡å¡", note: "ç¾å ´ä»˜æ¬¾" }, mapCode: "33 126 733*12" },
                    { time: "21:00", title: "AEON è¶…å¸‚ / åœ‹éš›é€š", type: "spot", guide: "è²·åŠåƒ¹å“ã€é›¶é£Ÿä¼´æ‰‹ç¦®ã€‚" }
                ]
            },
            {
                date: "12/29", fullDate: "2025/12/29", day: "é€±ä¸€", weather: "â˜€ï¸ 23Â°C",
                events: [
                    { time: "07:00", title: "èµ·åºŠ & æ—©é¤", type: "prep", guide: "é£¯åº—æ—©é¤ã€‚10:00 å‰é€€æˆ¿ã€‚", departureTime: "10:30 å‡ºç™¼", travel: { mode: 'drive', time: '20åˆ†' } },
                    { time: "10:30", title: "Ashibinaa Outlet", type: "spot", mapCode: "232 544 452*22", guide: "é‹å‹•å“ç‰Œã€GAP éƒ½å¾ˆä¾¿å®œã€‚", travel: { mode: 'drive', time: '15åˆ†' } },
                    { time: "13:30", title: "OTS é‚„è»Š", type: "trans", guide: "åŠ æ»¿æ²¹å†é‚„è»Šï¼æ­æ¥é§è»Šå»æ©Ÿå ´ã€‚", travel: { mode: 'trans', time: '20åˆ†' } },
                    { time: "14:30", title: "æ©Ÿå ´åˆé¤", type: "eat", guide: "è±¬è‚‰è›‹é£¯ç³°ã€‚" },
                    { time: "16:55", title: "å›ç¨‹é£›æ©Ÿ (FD231)", type: "trans", title_detail: "æ³°åœ‹äºèˆª FD231", bookingInfo: { code: "1616324336315022", note: "Trip.com", pdfContent: "èˆªç­ï¼šFD231\nèµ·é£›ï¼š16:55 (é‚£éœ¸ I)\næŠµé”ï¼š17:35 (T1)\n\nè¡Œæï¼š\nè¨—é‹ 20kg x 4\næ‰‹æ 7kg x 4", voucherImg: "flight_back.jpg" }, guide: "é‚£éœ¸ I -> æ¡ƒæ©Ÿ T1ã€‚ææ—© 2.5 å°æ™‚åˆ°ã€‚" }
                ]
            }
        ];
        
        // --- è¨˜å¸³æˆå“¡è¨­å®š ---
// å°æ‡‰ role çš„é¡¯ç¤ºåç¨±
const FAMILY_MEMBERS = [
    { id: 'driver', name: 'å¦¹å¦¹' },
    { id: 'copilot', name: 'çˆ¸çˆ¸' },
    { id: 'tourist', name: 'åª½åª½' },
    { id: 'admin', name: 'æˆ‘' }
];

let budgetChart = null; // ç”¨ä¾†å­˜å„²åœ–è¡¨å¯¦ä¾‹

        function init() {
            if (!currentRole) {
                document.getElementById('role-selector').classList.remove('hidden');
                document.getElementById('role-selector').classList.add('flex');
            } else {
                renderHome();
                setupRealtimeListeners();
            }
            // Auto Calc for Budget
            const exPrice = document.getElementById('in-ex-price');
            const exQty = document.getElementById('in-ex-qty');
            const calcTotal = document.getElementById('calc-total');
            const calcTwd = document.getElementById('calc-twd');
            function updateExTotal() {
                const p = parseInt(exPrice.value) || 0;
                const q = parseInt(exQty.value) || 1;
                const total = p * q;
                calcTotal.innerText = total.toLocaleString();
                calcTwd.innerText = Math.round(total * JPY_RATE).toLocaleString();
            }
            exPrice.addEventListener('input', updateExTotal);
            exQty.addEventListener('input', updateExTotal);
        }

        function selectRole(role) {
            currentRole = role; localStorage.setItem('user_role', role);
            document.getElementById('role-selector').classList.add('hidden');
            document.getElementById('role-selector').classList.remove('flex');
            renderHome();
            const roleIcons = { driver: 'ğŸš—', copilot: 'ğŸ—ºï¸', tourist: 'ğŸ“¸', admin: 'ğŸ“' };
            document.getElementById('header-icon').innerText = roleIcons[role] || 'ğŸ¦';
        }
        function clearRole() { localStorage.removeItem('user_role'); location.reload(); }
        function setupRealtimeListeners() { if(db) { db.ref('shoppingList').on('value', () => { if(currentTab === 'shopping') renderShopping(); }); db.ref('expenses').on('value', () => { if(currentTab === 'budget') renderBudget(); }); } }

        // --- Render Pages ---
        function renderShopping() {
    document.getElementById('header-desc').innerText = "è³¼ç‰©æ¸…å–®";
    const container = document.getElementById('app');
    
    // ä¿®æ”¹ï¼šå°‡ shopping-controls åŠ ä¸Š sticky-filters classï¼Œä¸¦ç§»é™¤ mb-2
    let html = `
        <button onclick="openEditShopModal()" class="fab-btn"><i class="fa-solid fa-plus"></i></button>
        
        <!-- ç½®é ‚ç¯©é¸å€å¡Š -->
        <div id="shopping-controls" class="sticky-filters"></div>
        
        <div id="shopping-list-container" class="space-y-4 pb-24">
            <div class="text-center text-gray-400 py-4"><i class="fa-solid fa-spinner fa-spin"></i> è¼‰å…¥ä¸­...</div>
        </div>`;
    container.innerHTML = html;

    const loadData = (data) => {
        const listContainer = document.getElementById('shopping-list-container');
        const controlsContainer = document.getElementById('shopping-controls');

        if(!data) { 
            // æ²’è³‡æ–™æ™‚éš±è—ç¯©é¸åˆ—ï¼Œé¿å…ä½”ä½
            controlsContainer.style.display = 'none';
            listContainer.innerHTML = '<div class="text-center text-gray-400 mt-10">æ¸…å–®æ˜¯ç©ºçš„ï¼Œé»æ“Š + æ–°å¢</div>'; 
            return; 
        }

        // --- è³‡æ–™è™•ç†èˆ‡æå–é¸é … ---
        const allEntries = Array.isArray(data) ? data.map((item, i) => [`local_${i}`, item]) : Object.entries(data);
        
        const categories = new Set();
        const stores = new Set();
        allEntries.forEach(([_, item]) => {
            if(item.category) categories.add(item.category);
            if(item.store) stores.add(item.store);
        });

        const catOptions = Array.from(categories).map(c => `<option value="${c}" ${currentCategoryFilter===c?'selected':''}>${c}</option>`).join('');
        const storeOptions = Array.from(stores).map(s => `<option value="${s}" ${currentStoreFilter===s?'selected':''}>${s}</option>`).join('');

        // é¡¯ç¤ºç¯©é¸å™¨å…§å®¹
        controlsContainer.style.display = 'block';
        controlsContainer.innerHTML = `
            <div class="filter-row">
                <div class="flex gap-2 overflow-x-auto pb-1 hide-scrollbar">
                    <select class="filter-select" onchange="updateFilter('category', this.value)">
                        <option value="all">å…¨éƒ¨ç¨®é¡</option>
                        ${catOptions}
                    </select>
                    <select class="filter-select" onchange="updateFilter('store', this.value)">
                        <option value="all">å…¨éƒ¨åº—èˆ–</option>
                        ${storeOptions}
                    </select>
                </div>
                <div class="rate-badge">
                    <i class="fa-solid fa-calculator mr-1"></i>åŒ¯ç‡ ${JPY_RATE}
                </div>
            </div>
        `;

        // --- åŸ·è¡Œç¯©é¸ ---
        const filteredEntries = allEntries.filter(([_, item]) => {
            const catMatch = currentCategoryFilter === 'all' || item.category === currentCategoryFilter;
            const storeMatch = currentStoreFilter === 'all' || item.store === currentStoreFilter;
            return catMatch && storeMatch;
        });

        if (filteredEntries.length === 0) {
            listContainer.innerHTML = '<div class="text-center text-gray-400 py-8">æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„å•†å“</div>';
            return;
        }
        
        // --- ç”Ÿæˆåˆ—è¡¨ (é‚è¼¯ä¿æŒä¸è®Š) ---
        let itemsHtml = '';
        filteredEntries.reverse().forEach(([key, item]) => {
            // çœéŒ¢è¨ˆç®—
            let savingsInfo = '';
            let twdEstimate = 0;
            if (item.priceJp) { 
                twdEstimate = Math.round(parseInt(item.priceJp) * JPY_RATE); 
                if (item.priceTw) { 
                    const priceTw = parseInt(item.priceTw); 
                    const diff = priceTw - twdEstimate;
                    if (diff > 0) savingsInfo = `<span class="ml-2 text-xs bg-red-100 text-red-600 px-1.5 py-0.5 rounded font-bold">çœ $${diff}</span>`; 
                    else if (diff < 0) savingsInfo = `<span class="ml-2 text-xs bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded">è²´ $${Math.abs(diff)}</span>`;
                } 
            }

            // åœ–ç‰‡é‚è¼¯
            let imgSource = '';
            if (item.imgUrl) { imgSource = item.imgUrl.startsWith('http') ? item.imgUrl : `./${item.imgUrl}`; }
            let imgBoxContent = '';
            let clickAction = '';
            let boxClass = 'shop-img-box';
            if (imgSource) {
                imgBoxContent = `<img src="${imgSource}" onerror="this.style.display='none'">`;
                clickAction = `onclick="openVoucherImage('${imgSource}')"`;
            } else { boxClass += ' no-image'; }

            // å¡ç‰‡ HTML
            itemsHtml += `
                <div class="card p-4 flex gap-4 bg-white items-center ${item.done ? 'opacity-60' : ''}">
                    <div>
                        <input type="checkbox" onchange="toggleShopItem('${key}')" 
                               class="w-6 h-6 accent-blue-600 border-2 border-blue-600 rounded cursor-pointer" 
                               ${item.done ? 'checked' : ''}>
                    </div>
                    <div class="${boxClass}" ${clickAction}>${imgBoxContent}</div>
                    <div class="flex-1 flex flex-col justify-between min-w-0 self-stretch">
                        <div class="flex justify-between items-start mb-1">
                            <span class="text-xs text-blue-600 border border-blue-200 bg-blue-50 px-2 py-0.5 rounded">${item.category || 'æœªåˆ†é¡'}</span>
                            <button onclick="deleteShopItem('${key}')" class="text-gray-800 hover:text-red-500 transition">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </div>
                        <div class="mb-3">
                            <h3 class="font-bold text-gray-800 text-lg leading-snug break-words line-clamp-2">${item.item}</h3>
                            <div class="text-sm text-gray-500 mt-0.5">${item.store || ''}</div>
                        </div>
                        <div class="mt-auto">
                            <div class="text-gray-800 font-bold mb-2 flex items-center">
                                å°å¹£ : $ ${item.priceTw || '-'} ${savingsInfo}
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <span class="text-gray-600 font-bold">æ—¥å¹£</span>
                                    <input type="number" placeholder="0" value="${item.priceJp || ''}" 
                                           class="jp-price-input-clean" 
                                           onchange="updateShopPrice('${key}', this.value)"
                                           onclick="event.stopPropagation()">
                                    ${twdEstimate > 0 ? `<span class="text-xs text-gray-400">(â‰ˆ$${twdEstimate})</span>` : ''}
                                </div>
                                <button onclick="openEditShopModal('${key}')" class="text-blue-600 text-lg hover:scale-110 transition px-2">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;
        });
        
        listContainer.innerHTML = itemsHtml;
    };

    if(db) { 
        db.ref('shoppingList').once('value').then(snapshot => loadData(snapshot.val())); 
    } else { 
        const localData = JSON.parse(localStorage.getItem(SHOPPING_KEY)) || defaultShoppingList; 
        loadData(localData); 
    }
}

        function renderBudget() {
    document.getElementById('header-desc').innerText = "è¨˜å¸³æœ¬ & åˆ†å¸³";
    const container = document.getElementById('app');

    // 1. å®¹å™¨ HTMLï¼šæ–°å¢åœ–è¡¨å€ã€å€‹äººçµ±è¨ˆå€
    let html = `
        <div class="card p-4 mb-4 bg-white">
            <h3 class="font-bold text-gray-700 mb-2 text-center">ğŸ“Š æ¶ˆè²»åˆ†é¡çµ±è¨ˆ</h3>
            <div class="chart-container">
                <canvas id="expenseChart"></canvas>
            </div>
        </div>

        <div class="card p-4 mb-4 bg-orange-50 border-orange-200">
            <h3 class="font-bold text-gray-700 mb-3"><i class="fa-solid fa-users-viewfinder mr-2"></i>æ¯äººæ‡‰ä»˜é‡‘é¡ (é ä¼°å°å¹£)</h3>
            <div id="personal-summary" class="grid grid-cols-2 gap-3">
                <div class="text-center py-4 text-gray-400"><i class="fa-solid fa-spinner fa-spin"></i> è¨ˆç®—ä¸­...</div>
            </div>
        </div>

        <button onclick="openBudgetModal()" class="fab-btn"><i class="fa-solid fa-plus"></i></button>
        <div id="expenses-list" class="space-y-3 pb-24"></div>
    `;
    container.innerHTML = html;

    const loadData = (data) => {
        const listContainer = document.getElementById('expenses-list');
        const personalContainer = document.getElementById('personal-summary');
        
        if(!data) { 
            personalContainer.innerHTML = '<div class="col-span-2 text-center text-gray-400 text-sm">å°šç„¡ç´€éŒ„</div>';
            listContainer.innerHTML = '<div class="text-center text-gray-400 py-4">ç›®å‰æ²’æœ‰æ”¯å‡ºï¼Œé»æ“Š + è¨˜å¸³</div>'; 
            return; 
        }

        let totalByCat = {};
        let personalTotal = { 'å¦¹å¦¹': 0, 'çˆ¸çˆ¸': 0, 'åª½åª½': 0, 'æˆ‘': 0 };
        let itemsHtml = '';
        const entries = Array.isArray(data) ? data.map((item, i) => [`local_${i}`, item]) : Object.entries(data);

        entries.reverse().forEach(([key, ex]) => {
            const amount = parseInt(ex.amount);
            // è½‰æ›ç‚ºå°å¹£ä½œçµ±è¨ˆ (è‹¥æ˜¯æ—¥å¹£å‰‡ * åŒ¯ç‡ï¼Œå°å¹£å‰‡ç›´æ¥ç”¨)
            const amountTwd = ex.currency === 'TWD' ? amount : Math.round(amount * JPY_RATE);
            
            // 1. åˆ†é¡çµ±è¨ˆ (çµ¦åœ“é¤…åœ–ç”¨)
            totalByCat[ex.category] = (totalByCat[ex.category] || 0) + amountTwd;

            // 2. åˆ†å¸³é‚è¼¯è¨ˆç®—
            if (ex.splitDetails) {
                // å¦‚æœæœ‰è©³ç´°åˆ†å¸³è³‡è¨Š
                ex.splitDetails.forEach(detail => {
                    if(personalTotal[detail.name] !== undefined) {
                        // è©³ç´°åˆ†å¸³é‡‘é¡éœ€æ›ç®—æˆå°å¹£
                        const splitAmountTwd = ex.currency === 'TWD' ? detail.amount : Math.round(detail.amount * JPY_RATE);
                        personalTotal[detail.name] += splitAmountTwd;
                    }
                });
            } else {
                // èˆŠè³‡æ–™ç›¸å®¹ï¼šé è¨­ç‚ºä»˜æ¬¾äººå…¨ä»˜ (æˆ–æ˜¯ç•¶ä½œä¸åˆ†å¸³çš„å…¬æ¬¾?)
                // é€™è£¡å‡è¨­èˆŠè³‡æ–™ç®—åœ¨"ä»˜æ¬¾äºº"é ­ä¸Šï¼Œæˆ–è€…å¦‚æœç„¡ä»˜æ¬¾äººæ¬„ä½é è¨­ç‚º"æˆ‘"
                const payer = ex.payer || 'æˆ‘'; 
                // é€™è£¡ç°¡å–®è™•ç†ï¼šå¦‚æœæ˜¯èˆŠè³‡æ–™ï¼Œç›´æ¥ç®—åœ¨ä»˜æ¬¾äººèº«ä¸Šï¼Œä¸é€²è¡Œè¤‡é›œæ‹†åˆ†
                if(personalTotal[payer] !== undefined) personalTotal[payer] += amountTwd;
            }

            // 3. åˆ—è¡¨é¡¯ç¤º
            let icon = 'ğŸ’¸'; 
            if(ex.category === 'é£Ÿç‰©') icon = 'ğŸ”'; if(ex.category === 'è³¼ç‰©') icon = 'ğŸ›ï¸'; 
            if(ex.category === 'äº¤é€š') icon = 'ğŸš—'; if(ex.category === 'é–€ç¥¨') icon = 'ğŸ«';
            
            // è™•ç†é‡‘é¡é¡¯ç¤º
            const priceDisplay = ex.currency === 'TWD' 
                ? `NT$${amount.toLocaleString()}` 
                : `Â¥${amount.toLocaleString()}`;
            const subDisplay = ex.currency === 'TWD' 
                ? '' 
                : `<div class="text-[10px] text-gray-400">â‰ˆ NT$${amountTwd.toLocaleString()}</div>`;

            // è™•ç†æ†‘è­‰åœ–ç¤º
            const receiptIcon = ex.receiptUrl 
                ? `<button onclick="openVoucherImage('${ex.receiptUrl}')" class="text-blue-500 hover:bg-blue-50 p-1 rounded"><i class="fa-solid fa-receipt"></i></button>` 
                : '';

            itemsHtml += `
                <div class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center relative overflow-hidden">
                    <div class="w-1 bg-orange-400 absolute left-0 top-0 bottom-0"></div>
                    <div class="flex-1 ml-2">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-lg">${icon}</span>
                            <span class="font-bold text-gray-700 text-sm line-clamp-1">${ex.item}</span>
                            <span class="text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded border border-gray-200">${ex.payer || 'æœªçŸ¥'}</span>
                        </div>
                        <div class="text-xs text-gray-400 flex items-center gap-2">
                            <span>${ex.fullTime ? ex.fullTime.slice(5, 16).replace('T', ' ') : ex.date}</span>
                            <span>â€¢ ${ex.payment || 'ç¾é‡‘'}</span>
                        </div>
                    </div>
                    <div class="text-right flex flex-col items-end mr-3 min-w-[70px]">
                        <div class="font-bold text-orange-600">${priceDisplay}</div>
                        ${subDisplay}
                    </div>
                    <div class="flex gap-2 pl-2 border-l border-gray-100">
                        ${receiptIcon}
                        <button onclick="openBudgetModal('${key}')" class="text-gray-400 hover:text-blue-500 p-1"><i class="fa-solid fa-pen"></i></button>
                        <button onclick="deleteExpense('${key}')" class="text-gray-400 hover:text-red-400 p-1"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>`;
        });

        // 4. æ›´æ–°ç•«é¢
        listContainer.innerHTML = itemsHtml;

        // æ›´æ–°å€‹äººçµ±è¨ˆå¡ç‰‡
        let personalHtml = '';
        Object.keys(personalTotal).forEach(name => {
            personalHtml += `
                <div class="person-card">
                    <div class="text-xs text-gray-500 font-bold mb-1">${name}</div>
                    <div class="text-xl font-bold text-gray-800">
                        <span class="text-xs mr-0.5">$</span>${personalTotal[name].toLocaleString()}
                    </div>
                </div>`;
        });
        personalContainer.innerHTML = personalHtml;

        // 5. ç¹ªè£½åœ–è¡¨
        renderChart(totalByCat);
    };

    if(db) { db.ref('expenses').once('value').then(snapshot => loadData(snapshot.val())); } 
    else { const localData = JSON.parse(localStorage.getItem(EXPENSE_KEY)) || []; loadData(localData); }
}

// --- åœ–è¡¨ç¹ªè£½å‡½å¼ ---
function renderChart(dataObj) {
    const ctx = document.getElementById('expenseChart');
    if (!ctx) return;
    
    // éŠ·æ¯€èˆŠåœ–è¡¨ä»¥é˜²é‡ç–Š
    if (budgetChart) { budgetChart.destroy(); }

    const labels = Object.keys(dataObj);
    const data = Object.values(dataObj);
    const colors = ['#FFAB91', '#FFCC80', '#B2EBF2', '#E1BEE7', '#DCEDC8', '#F8BBD0'];

    budgetChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors,
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'right', labels: { font: { family: "'M PLUS Rounded 1c'" }, boxWidth: 12 } }
            }
        }
    });
}

        function createEventCard(event, dayIdx, evtIdx) {
            if (event.type === 'choice') {
                return `<div class="overflow-hidden"><div class="flex items-center gap-2 mb-2 px-1"><span class="font-bold text-xl text-gray-700">${event.time}</span> <h3 class="font-bold text-lg text-gray-800">${event.title}</h3></div><div class="flex gap-4 overflow-x-auto snap-x-mandatory hide-scrollbar pb-4 px-1">${event.choices.map((c, cIdx) => `<div class="bg-white border-2 border-orange-100 rounded-xl p-4 min-w-[85%] snap-center shadow-sm" onclick="openDetailModal(${dayIdx}, ${evtIdx}, ${cIdx})"><div class="flex justify-between items-start mb-2"><h4 class="font-bold text-lg text-gray-800">${c.title}</h4><span class="text-xs px-2 py-1 rounded-full tag-eat">ç¾é£Ÿ</span></div><p class="text-sm text-gray-600 mb-3 line-clamp-2">${c.guide}</p><button class="w-full bg-blue-50 text-blue-600 py-2 rounded-lg text-sm font-bold">æŸ¥çœ‹è©³æƒ… & å°èˆª</button></div>`).join('')}</div></div>`;
            }
            if (event.type === 'prep') {
                return `<div class="card p-4 border-l-4 border-purple-400 bg-purple-50 flex justify-between items-center"><div><div class="font-bold text-xl text-purple-800">${event.time}</div><div class="text-sm text-purple-600 font-bold">${event.title}</div><div class="text-xs text-purple-500 mt-1">${event.guide}</div></div><div class="text-right"><div class="text-xs text-gray-500">é è¨ˆå‡ºç™¼</div><div class="text-2xl font-bold text-purple-900">${event.departureTime.split(' ')[0]}</div><div class="text-xs text-purple-700">æº–æ™‚å‡ºç™¼ ğŸš—</div></div></div>`;
            }
            let previewContent = '';
            if (currentRole === 'driver' && event.mapCode) previewContent = `<div class="mt-2 text-sm font-mono bg-gray-100 p-1 px-2 rounded inline-block"><i class="fa-solid fa-map-location-dot mr-1"></i> ${event.mapCode}</div>`;
            if (currentRole === 'admin' && event.bookingInfo) previewContent = `<div class="mt-2 text-xs text-red-500 font-bold"><i class="fa-solid fa-ticket mr-1"></i> ${event.bookingInfo.note}</div>`;
            if (event.frequency) previewContent += `<div class="mt-2 text-xs text-blue-600 font-bold"><i class="fa-solid fa-clock"></i> ${event.frequency} <a href="${event.timetableUrl}" target="_blank" class="ml-1 underline">æ™‚åˆ»è¡¨</a></div>`;
            let clickAction = (event.type === 'eat' || event.type === 'spot') ? `onclick="openDetailModal(${dayIdx}, ${evtIdx})"` : `onclick="toggleCard(this)"`;
            
            return `<div class="card p-5" ${clickAction}><div class="flex items-start gap-4 pointer-events-none"><div class="font-bold text-xl text-gray-700 min-w-[50px] pt-1">${event.time}</div><div class="flex-1"><h3 class="font-bold text-lg text-gray-800">${event.title}</h3>${event.appLink ? `<a href="${event.appLink.url}" class="mt-2 inline-block bg-black text-white px-3 py-1.5 rounded-lg text-sm font-bold shadow active:scale-95 transition pointer-events-auto" onclick="event.stopPropagation()"><i class="${event.appLink.icon} mr-1"></i> ${event.appLink.text}</a>` : ''}<span class="text-xs px-2 py-1 rounded-full ${event.type === 'eat' ? 'tag-eat' : event.type === 'spot' ? 'tag-spot' : event.type === 'hotel' ? 'tag-hotel' : 'tag-trans'} block w-fit mt-1">${event.type === 'eat' ? 'ç¾é£Ÿ' : event.type === 'spot' ? 'æ™¯é»' : event.type === 'hotel' ? 'ä½å®¿' : 'äº¤é€š'}</span>${previewContent}</div></div><div class="details-content mt-4 pt-4 border-t border-gray-100 space-y-4">${event.title_detail ? `<h4 class="font-bold text-gray-800 text-lg">${event.title_detail}</h4>` : ''}${event.bookingInfo ? `<div class="ticket-box"><div class="text-sm opacity-70">é ç´„æ†‘è­‰ / è¨‚å–®è™Ÿ</div><div class="text-2xl font-bold font-mono my-1 select-all">${event.bookingInfo.code}</div><div class="text-sm flex justify-between"><span>${event.bookingInfo.note}</span><span>${event.bookingInfo.extra || ''}</span></div>${event.bookingInfo.pdfContent ? `<button onclick="openPdfModal('${encodeURIComponent(event.bookingInfo.pdfContent)}')" class="mt-2 w-full bg-red-50 text-red-600 py-2 rounded text-xs font-bold border border-red-100"><i class="fa-solid fa-file-pdf mr-1"></i> é è¦½æ†‘è­‰</button>` : ''}${event.bookingInfo.voucherImg ? `<button onclick="openVoucherImage('${event.bookingInfo.voucherImg}')" class="mt-2 w-full bg-red-500 text-white py-2 rounded-lg font-bold text-sm shadow-md mb-2"><i class="fa-solid fa-image mr-1"></i> æŸ¥çœ‹æ†‘è­‰åœ–ç‰‡</button>` : ''}</div>` : ''}${event.multiMaps ? `<div class="grid grid-cols-2 gap-3">${event.multiMaps.map(m => `<a href="https://www.google.com/maps/search/?api=1&query=${m.query}" target="_blank" class="bg-blue-50 text-blue-600 py-3 rounded-xl text-center font-bold shadow-sm border border-blue-100 active:scale-95 transition"><i class="fa-solid fa-location-arrow mr-1"></i> ${m.name}</a>`).join('')}</div>` : ''}${event.mapCode ? `<div class="bg-gray-50 p-3 rounded-lg"><div class="flex justify-between items-center mb-2"><span class="text-sm font-bold text-gray-600">MapCode</span><div class="flex items-center gap-2"><span class="font-mono text-xl font-bold">${event.mapCode}</span><button onclick="copyText('${event.mapCode}', event)" class="text-orange-500"><i class="fa-regular fa-copy"></i></button></div></div><a href="https://www.google.com/maps/search/?api=1&query=${event.title}+æ²–ç¹©" target="_blank" class="block w-full text-center bg-blue-500 text-white font-bold py-2 rounded-lg shadow-sm"><i class="fa-solid fa-location-arrow mr-2"></i> Google å°èˆª</a>${event.parking ? `<div class="mt-2 text-xs text-gray-500"><i class="fa-solid fa-square-parking"></i> ${event.parking.info}</div>` : ''}</div>` : ''}${event.guide ? `<div class="text-sm text-gray-700 leading-relaxed"><i class="fa-solid fa-circle-info text-orange-400 mr-1"></i> ${event.guide}</div>` : ''}${event.adminNote ? `<div class="text-sm text-gray-600 bg-yellow-50 p-2 rounded border border-yellow-100"><i class="fa-solid fa-pen mr-1"></i> ç­†è¨˜: ${event.adminNote}</div>` : ''}</div></div>`;
        }

        function renderHome() {
            const container = document.getElementById('app');
            const now = currentSimulatedDate ? new Date(currentSimulatedDate) : new Date();
            const todayStr = `${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()}`;
            const tripIndex = tripData.findIndex(d => d.fullDate === todayStr);
            const displayData = tripIndex !== -1 ? tripData[tripIndex] : tripData[0];
            const displayIndex = tripIndex !== -1 ? tripIndex : 0;
            const nextEvent = displayData.events[0];
            const roleName = ({ 'driver': 'å¦¹å¦¹ (é§•é§›)', 'copilot': 'çˆ¸çˆ¸ (å‰¯é§•)', 'tourist': 'åª½åª½ (éŠå®¢)', 'admin': 'æˆ‘ (ä¸»æª)' })[currentRole] || 'æ—…äºº';
            const roleIcons = { driver: 'ğŸš—', copilot: 'ğŸ—ºï¸', tourist: 'ğŸ“¸', admin: 'ğŸ“' };
            document.getElementById('header-icon').innerText = roleIcons[currentRole] || 'ğŸ¦';

            // Packing List Logic: Only show BEFORE 12/25
            const isBeforeTrip = now < new Date("2025-12-25T00:00:00");
            let packingHtml = '';
            if (isBeforeTrip) { packingHtml = getPackingListHTML(); }

            const nextEventHtml = createEventCard(nextEvent, displayIndex, 0);

            container.innerHTML = `
                <div class="card p-4 mb-4 bg-gradient-to-r from-blue-50 to-white"><div class="flex justify-between items-center mb-3"><h3 class="font-bold text-gray-700">â˜€ï¸ ä»Šæ—¥å¤©æ°£ (é‚£éœ¸)</h3><span id="sunset-time" class="text-xs text-orange-600 font-bold"></span></div><div id="weather-scroll" class="weather-scroll flex gap-4"><div class="flex items-center gap-2 text-gray-400 text-sm"><i class="fa-solid fa-spinner fa-spin"></i> è¼‰å…¥ä¸­...</div></div></div>
                ${packingHtml}
                <div class="mb-4 flex justify-between items-center"><h3 class="font-bold text-gray-700">ğŸ“… ä»Šæ—¥æ¦‚è¦½ (${displayData.date})</h3></div>
                ${nextEventHtml}
                <div class="mt-6"><h3 class="font-bold text-gray-700 mb-3">ğŸ†˜ æ±‚ç”Ÿå·¥å…·ç®±</h3><div class="grid grid-cols-4 gap-2 text-center"><a href="https://www.google.com/maps/search/nearby+convenience+store" target="_blank" class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 active:scale-95 transition"><div class="text-2xl mb-1">ğŸª</div><div class="text-[10px] text-gray-600 font-bold">æ‰¾è¶…å•†</div></a><a href="https://www.google.com/maps/search/nearby+toilet" target="_blank" class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 active:scale-95 transition"><div class="text-2xl mb-1">ğŸš½</div><div class="text-[10px] text-gray-600 font-bold">æ‰¾å»æ‰€</div></a><a href="https://www.google.com/maps/search/nearby+gas+station" target="_blank" class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 active:scale-95 transition"><div class="text-2xl mb-1">â›½</div><div class="text-[10px] text-gray-600 font-bold">æ‰¾åŠ æ²¹</div></a><button onclick="openTranslation()" class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 active:scale-95 transition"><div class="text-2xl mb-1">ğŸ—£ï¸</div><div class="text-[10px] text-gray-600 font-bold">æ—¥èªå¡</div></button></div></div>
                <div class="mt-6 mb-20"><h3 class="font-bold text-gray-700 mb-3">ğŸ® 12æœˆé™å®šæ´»å‹•</h3><div class="flex gap-4 overflow-x-auto snap-x-mandatory hide-scrollbar pb-4 px-1">${okinawaEvents.map(ev => `<a href="${ev.link}" target="_blank" class="block min-w-[200px] bg-white rounded-xl border border-orange-100 shadow-sm snap-center active:scale-95 transition overflow-hidden"><div class="h-24 bg-gray-200 bg-cover bg-center" style="background-image: url('${ev.img}')"></div><div class="p-3"><div class="text-xs text-orange-500 font-bold mb-1">${ev.date}</div><div class="font-bold text-gray-800 text-sm truncate">${ev.title}</div><div class="text-xs text-gray-400 mt-1"><i class="fa-solid fa-location-dot"></i> ${ev.loc}</div></div></a>`).join('')}</div></div>
            `;
            document.getElementById('header-desc').innerText = "é¦–é æ¦‚è¦½";
            updateWeatherUI();
        }

        function renderSchedule() {
            const container = document.getElementById('app');
            document.getElementById('header-desc').innerText = "è¡Œç¨‹ç¸½è¦½";
            let tabsHtml = `<div class="date-scroll flex gap-2 mb-4 px-1 pb-2">`;
            tripData.forEach((d, idx) => { const active = idx === selectedDateIndex ? 'active' : 'bg-white text-gray-500 border border-gray-200'; tabsHtml += `<button onclick="changeDate(${idx})" class="date-tab ${active} px-4 py-2 rounded-full min-w-[90px] text-center transition shadow-sm flex-shrink-0"><div class="text-xs opacity-80">${d.day}</div><div class="font-bold text-lg leading-tight">${d.date}</div><div class="text-xs mt-1 font-normal opacity-90">${d.weather}</div></button>`; });
            tabsHtml += `</div>`;
            const dayData = tripData[selectedDateIndex];
            let eventsHtml = `<div class="space-y-4 animation-fade pb-12">`;
            dayData.events.forEach((event, eIdx) => {
                eventsHtml += createEventCard(event, selectedDateIndex, eIdx);
                if (event.type !== 'choice' && event.travel && eIdx < dayData.events.length - 1) {
                    let icon = 'fa-car'; if(event.travel.mode === 'walk') icon = 'fa-person-walking'; if(event.travel.mode === 'train') icon = 'fa-train-subway'; if(event.travel.mode === 'plane') icon = 'fa-plane';
                    eventsHtml += `<div class="flex flex-col items-center -my-3 z-0 relative"><div class="h-6 w-0.5 bg-gray-300 border-l border-dashed border-gray-400"></div><div class="bg-white text-gray-500 text-[10px] font-bold px-2 py-0.5 rounded-full border border-gray-200 shadow-sm flex items-center gap-1 z-10"><i class="fa-solid ${icon}"></i> ${event.travel.time}</div><div class="h-6 w-0.5 bg-gray-300 border-l border-dashed border-gray-400"></div></div>`;
                }
            });
            eventsHtml += `</div>`;
            container.innerHTML = tabsHtml + eventsHtml;
        }

        function renderVouchers() {
            document.getElementById('header-desc').innerText = "é ç´„æ†‘è­‰å¤¾";
            const container = document.getElementById('app');
            let infoHtml = `<div class="card p-5 mb-4 border-l-4 border-red-500 bg-red-50"><h3 class="font-bold text-red-700 mb-3"><i class="fa-solid fa-triangle-exclamation"></i> ç·Šæ€¥è¯çµ¡</h3><div class="grid grid-cols-2 gap-3 text-sm"><a href="tel:110" class="bg-white p-2 rounded text-center shadow text-gray-700 font-bold"><i class="fa-solid fa-phone mr-1"></i> å ±è­¦ 110</a><a href="tel:119" class="bg-white p-2 rounded text-center shadow text-gray-700 font-bold"><i class="fa-solid fa-truck-medical mr-1"></i> æ•‘è­· 119</a><div class="col-span-2 bg-white p-2 rounded shadow text-gray-700 text-xs"><div>å¤–äº¤éƒ¨æ—…å¤–æ•‘åŠ©ï¼š+81-80-1009-7179</div></div></div></div>`;
            let vouchersHtml = `<div class="space-y-4">`;
            tripData.forEach(day => {
                day.events.forEach(event => {
                    if (event.bookingInfo) {
                        let linkBtn = '';
                        const fullText = (event.bookingInfo.note + (event.bookingInfo.extra || '')).toLowerCase();
                        if (fullText.includes('trip.com')) linkBtn = `<a href="https://trip.com" target="_blank" class="mt-3 block w-full text-center bg-blue-50 text-blue-600 py-2 rounded-lg font-bold text-sm hover:bg-blue-100 transition border border-blue-100"><i class="fa-solid fa-arrow-up-right-from-square mr-1"></i> é–‹å•Ÿ Trip.com è¨‚å–®</a>`;
                        else if (fullText.includes('nutmeg')) linkBtn = `<a href="https://ntmg.jp/" target="_blank" class="mt-3 block w-full text-center bg-green-50 text-green-600 py-2 rounded-lg font-bold text-sm hover:bg-green-100 transition border border-green-100"><i class="fa-solid fa-arrow-up-right-from-square mr-1"></i> é–‹å•Ÿ Nutmeg è¨‚å–®</a>`;
                        else if (fullText.includes('tabelog')) linkBtn = `<a href="https://tabelog.com/" target="_blank" class="mt-3 block w-full text-center bg-yellow-50 text-yellow-600 py-2 rounded-lg font-bold text-sm hover:bg-yellow-100 transition border border-yellow-100"><i class="fa-solid fa-arrow-up-right-from-square mr-1"></i> é–‹å•Ÿ Tabelog</a>`;
                        
                        let imgBtn = '';
                        if (event.bookingInfo.voucherImg) { imgBtn = `<button onclick="openVoucherImage('${event.bookingInfo.voucherImg}')" class="mt-2 w-full bg-red-500 text-white py-2 rounded-lg font-bold text-sm shadow-md mb-2"><i class="fa-solid fa-image mr-1"></i> æŸ¥çœ‹æ†‘è­‰åœ–ç‰‡</button>`; }

                        vouchersHtml += `
                            <div class="card p-5 border-l-4 border-orange-500 shadow-sm bg-white">
                                <div class="flex justify-between items-start mb-2"><h3 class="font-bold text-lg text-gray-800">${event.title}</h3><span class="text-xs bg-gray-100 px-2 py-1 rounded text-gray-500">${day.date}</span></div>
                                <div class="text-sm text-gray-600 mb-3">${event.bookingInfo.note}</div>
                                <div class="bg-gray-50 p-3 rounded border border-gray-200 dashed mb-3 relative group active:bg-orange-50 transition"><div class="text-xs text-gray-400 mb-1">è¨‚å–®ç·¨è™Ÿ / PIN</div><div class="text-xl font-mono font-bold text-gray-800 select-all break-all">${event.bookingInfo.code}</div><div class="absolute right-2 top-2 text-gray-300"><i class="fa-regular fa-copy"></i></div></div>
                                ${event.bookingInfo.extra ? `<div class="text-xs text-orange-600 font-bold text-right mb-3">${event.bookingInfo.extra}</div>` : ''}
                                ${event.bookingInfo.pdfContent ? `<button onclick="openPdfModal('${encodeURIComponent(event.bookingInfo.pdfContent)}')" class="mt-2 w-full bg-red-50 text-red-600 py-2 rounded text-xs font-bold border border-red-100"><i class="fa-solid fa-file-pdf mr-1"></i> é è¦½æ†‘è­‰</button>` : ''}
                                ${imgBtn}
                                ${linkBtn}
                            </div>`;
                    }
                });
            });
            const packingHtml = getPackingListHTML();
            container.innerHTML = infoHtml + `<div class="text-gray-500 text-sm mb-2 px-2">é ç´„æ†‘è­‰</div>` + vouchersHtml + `<div class="mt-8 text-gray-500 text-sm mb-2 px-2">éš¨æ™‚æª¢æŸ¥</div>` + packingHtml + `</div>`;
        }

        function getPackingListHTML() {
            const packingList = getPackingList();
            const doneCount = packingList.filter(i => i.done).length;
            const totalCount = packingList.length;
            const progressPercent = Math.round((doneCount / totalCount) * 100);
            const itemsHtml = packingList.map(item => {
                let badgeColor = "bg-gray-100 text-gray-500"; if(item.category === 'é‡è¦') badgeColor = "bg-red-100 text-red-600 font-bold";
                return `<div class="flex items-center gap-3 p-2 rounded hover:bg-teal-50 transition cursor-pointer border-b border-gray-50 last:border-0" onclick="togglePacking('${item.id}')"><div class="w-5 h-5 flex-shrink-0 rounded border-2 border-teal-400 flex items-center justify-center ${item.done ? 'bg-teal-400' : 'bg-white'}">${item.done ? '<i class="fa-solid fa-check text-white text-xs"></i>' : ''}</div><div class="flex-1"><span class="text-[10px] px-1.5 py-0.5 rounded ${badgeColor} mr-1">${item.category}</span><span class="text-sm ${item.done ? 'text-gray-400 line-through' : 'text-gray-700 font-medium'}">${item.text}</span></div></div>`;
            }).join('');
            return `<div class="card p-5 mb-6 border-l-4 border-teal-500 shadow-lg bg-white"><div class="flex justify-between items-end mb-2"><h3 class="font-bold text-teal-700"><i class="fa-solid fa-list-check mr-2"></i>è¡Œææ¸…å–®</h3><span class="text-xs font-bold text-teal-600">${doneCount}/${totalCount} (${progressPercent}%)</span></div><div class="w-full bg-gray-200 rounded-full h-2 mb-3"><div class="bg-teal-500 h-2 rounded-full transition-all duration-500" style="width: ${progressPercent}%"></div></div><div class="grid grid-cols-1 gap-2 max-h-[240px] overflow-y-auto pr-1">${itemsHtml}</div></div>`;
        }

        function openEditShopModal(key = null) {
            const modalTitle = document.getElementById('shop-modal-title');
            const inKey = document.getElementById('in-shop-key');
            inKey.value = key || ''; 
            if(key) {
                modalTitle.innerText = 'ç·¨è¼¯å•†å“';
                if(db) {
                    db.ref('shoppingList/' + key).once('value').then(snapshot => { fillShopModal(snapshot.val()); });
                } else {
                    const index = parseInt(key.split('_')[1]);
                    const localData = JSON.parse(localStorage.getItem(SHOPPING_KEY));
                    fillShopModal(localData[index]);
                }
            } else {
                modalTitle.innerText = 'æ–°å¢å¿…è²·';
                fillShopModal({});
            }
            openModal('modal-shopping');
        }

        function fillShopModal(item) {
            document.getElementById('in-shop-img').value = item.imgUrl || '';
            document.getElementById('in-shop-cat').value = item.category || 'è—¥å¦';
            document.getElementById('in-shop-store').value = item.store || '';
            document.getElementById('in-shop-item').value = item.item || '';
            document.getElementById('in-shop-tw').value = item.priceTw || '';
            document.getElementById('in-shop-jp').value = item.priceJp || ''; 
        }

        function saveShopItem() {
            const key = document.getElementById('in-shop-key').value;
            const newItem = {
                imgUrl: document.getElementById('in-shop-img').value,
                category: document.getElementById('in-shop-cat').value,
                store: document.getElementById('in-shop-store').value,
                item: document.getElementById('in-shop-item').value,
                priceTw: document.getElementById('in-shop-tw').value,
                priceJp: document.getElementById('in-shop-jp').value, 
                done: false, addedBy: currentRole, timestamp: Date.now()
            };
            
            if(!newItem.item) return alert("è«‹è‡³å°‘è¼¸å…¥å“å");

            if(db) {
                if(key) db.ref('shoppingList/' + key).update(newItem);
                else db.ref('shoppingList').push(newItem);
            } else {
                const localData = JSON.parse(localStorage.getItem(SHOPPING_KEY)) || [];
                if(key) {
                    const index = parseInt(key.split('_')[1]);
                    localData[index] = { ...localData[index], ...newItem }; 
                } else {
                    localData.push(newItem);
                }
                localStorage.setItem(SHOPPING_KEY, JSON.stringify(localData));
                renderShopping();
            }
            closeModal('modal-shopping');
        }

        function updateShopPrice(key, newPrice) {
            if(db) {
                db.ref('shoppingList/' + key).update({ priceJp: newPrice });
            } else {
                const index = parseInt(key.split('_')[1]);
                const localData = JSON.parse(localStorage.getItem(SHOPPING_KEY));
                localData[index].priceJp = newPrice;
                localStorage.setItem(SHOPPING_KEY, JSON.stringify(localData));
                renderShopping();
            }
        }

        function toggleShopItem(key) { 
            if(db) { 
                db.ref('shoppingList/' + key).once('value').then(snapshot => {
                    const current = snapshot.val().done;
                    db.ref('shoppingList/' + key).update({ done: !current });
                });
            } else { 
                const index = parseInt(key.split('_')[1]); 
                const localData = JSON.parse(localStorage.getItem(SHOPPING_KEY)); 
                localData[index].done = !localData[index].done; 
                localStorage.setItem(SHOPPING_KEY, JSON.stringify(localData)); 
                renderShopping(); 
            } 
        }

        function deleteShopItem(key) { 
            if(confirm("åˆªé™¤æ­¤é …ç›®ï¼Ÿ")) { 
                if(db) db.ref('shoppingList/' + key).remove(); 
                else { 
                    const index = parseInt(key.split('_')[1]); 
                    const localData = JSON.parse(localStorage.getItem(SHOPPING_KEY)); 
                    localData.splice(index, 1); 
                    localStorage.setItem(SHOPPING_KEY, JSON.stringify(localData)); 
                    renderShopping(); 
                } 
            } 
        }

        function openBudgetModal(key = null) {
    const isEdit = !!key;
    // å–å¾—ç•¶å‰æ™‚é–“æˆ–ç·¨è¼¯é …ç›®çš„è³‡æ–™
    let editData = {};
    if (isEdit) {
        // å¾è³‡æ–™åº«æˆ– localStorage æ’ˆå–è©²ç­†è³‡æ–™
        if(db) {
            // æ³¨æ„ï¼šé€™è£¡æ˜¯ç•°æ­¥ï¼ŒFirebase éœ€è¦å…ˆæ’ˆè³‡æ–™å†é–‹ Modal
            // ç‚ºäº†ç°¡åŒ–ï¼Œé€™é‚Šå‡è¨­è³‡æ–™å·²åœ¨ render æ™‚å¿«å–ï¼Œæˆ–æ˜¯ç°¡å–®åœ°ç›´æ¥é‡æ’ˆ
             db.ref('expenses/' + key).once('value').then(snapshot => {
                 fillAndShowBudgetModal(key, snapshot.val());
             });
             return;
        } else {
            const index = parseInt(key.split('_')[1]);
            const localData = JSON.parse(localStorage.getItem(EXPENSE_KEY));
            editData = localData[index];
            fillAndShowBudgetModal(key, editData);
            return;
        }
    }
    
    // æ–°å¢æ¨¡å¼
    const now = new Date(); 
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    const defaultData = {
        fullTime: now.toISOString().slice(0,16),
        category: 'é£Ÿç‰©',
        payment: 'ç¾é‡‘',
        qty: 1,
        currency: 'JPY',
        payer: FAMILY_MEMBERS.find(m => m.id === currentRole)?.name || 'æˆ‘'
    };
    fillAndShowBudgetModal(null, defaultData);
}

// --- å¡«å……ä¸¦é¡¯ç¤º Modal ---
function fillAndShowBudgetModal(key, data) {
    // ç”¢ç”Ÿ Modal HTML (æ¯æ¬¡å‹•æ…‹ç”Ÿæˆä»¥ç¢ºä¿ç‹€æ…‹ä¹¾æ·¨)
    const modalSheet = document.querySelector('#modal-budget .modal-sheet');
    
    // é è¨­é¸ä¸­çš„åˆ†å¸³æˆå“¡ (å¦‚æœæ˜¯ç·¨è¼¯æ¨¡å¼ï¼Œå¾ data.splitDetails é‚„åŸï¼Œå¦å‰‡å…¨é¸)
    const splitMethod = data.splitMethod || 'equal'; // equal, amount, none
    
    modalSheet.innerHTML = `
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-700">${key ? 'ç·¨è¼¯æ”¯å‡º' : 'è¨˜ä¸€ç­†æ”¯å‡º'}</h3>
            <button onclick="closeModal('modal-budget')" class="text-gray-400"><i class="fa-solid fa-xmark text-xl"></i></button>
        </div>
        
        <input type="hidden" id="in-ex-key" value="${key || ''}">
        
        <!-- æ™‚é–“ -->
        <div class="bg-gray-50 p-2 rounded-xl border border-gray-200 mb-3">
            <label class="text-xs text-gray-500 font-bold ml-1">æ—¥æœŸèˆ‡æ™‚é–“</label>
            <input id="in-ex-time" type="datetime-local" class="w-full bg-transparent font-bold text-gray-700 outline-none mt-1" value="${data.fullTime || ''}">
        </div>

        <!-- é¡åˆ¥èˆ‡ä»˜æ¬¾äºº -->
        <div class="grid grid-cols-2 gap-2 mb-3">
            <select id="in-ex-category" class="p-3 bg-white rounded-xl border border-orange-200 text-gray-700 font-bold">
                ${['é£Ÿç‰©','è³¼ç‰©','äº¤é€š','é–€ç¥¨','å…¶ä»–'].map(c => `<option value="${c}" ${data.category===c?'selected':''}>${c}</option>`).join('')}
            </select>
            <select id="in-ex-payer" class="p-3 bg-white rounded-xl border border-blue-200 text-blue-800 font-bold">
                ${FAMILY_MEMBERS.map(m => `<option value="${m.name}" ${data.payer===m.name?'selected':''}>ä»˜æ¬¾: ${m.name}</option>`).join('')}
            </select>
        </div>

        <!-- å•†åº—èˆ‡å“é … -->
        <input id="in-ex-store" placeholder="å•†åº—/é¤å»³ (é¸å¡«)" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 mb-2" value="${data.store || ''}">
        <input id="in-ex-item" placeholder="å“å/å…§å®¹" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 mb-2" value="${data.item || ''}">

        <!-- é‡‘é¡èˆ‡å¹£åˆ¥ -->
        <div class="grid grid-cols-3 gap-2 mb-2">
            <div class="col-span-2 relative">
                 <input id="in-ex-price" type="number" placeholder="å–®åƒ¹" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 font-bold text-lg" value="${data.priceJp || ''}"> <!-- æ³¨æ„: é€™è£¡ç”¨ priceJp æ¬„ä½å­˜åŸå§‹å–®åƒ¹ -->
                 <span class="absolute right-3 top-3 text-gray-400 text-xs">å–®åƒ¹</span>
            </div>
            <select id="in-ex-currency" class="p-3 bg-gray-50 rounded-xl border border-gray-200 text-gray-700 font-bold">
                <option value="JPY" ${data.currency!=='TWD'?'selected':''}>Â¥ JPY</option>
                <option value="TWD" ${data.currency==='TWD'?'selected':''}>$ TWD</option>
            </select>
        </div>

        <!-- æ•¸é‡èˆ‡æ”¯ä»˜æ–¹å¼ -->
        <div class="grid grid-cols-2 gap-3 mb-3">
            <div class="flex items-center gap-2">
                <button class="qty-btn" onclick="adjustQty(-1)">-</button>
                <input id="in-ex-qty" type="number" value="${data.qty || 1}" class="w-full p-3 text-center bg-gray-50 rounded-xl border border-gray-200" readonly>
                <button class="qty-btn" onclick="adjustQty(1)">+</button>
            </div>
            <select id="in-ex-pay" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 text-gray-700">
                ${['ç¾é‡‘','ä¿¡ç”¨å¡','Suica/ICå¡'].map(p => `<option value="${p}" ${data.payment===p?'selected':''}>${p}</option>`).join('')}
            </select>
        </div>
        
        <!-- æ†‘è­‰åœ–ç‰‡ (æ–°å¢) -->
        <div class="mb-3">
            <input id="in-ex-receipt" placeholder="æ†‘è­‰åœ–ç‰‡ç¶²å€ (URL)" class="w-full p-2 bg-gray-50 rounded-lg border border-gray-200 text-sm" value="${data.receiptUrl || ''}">
        </div>

        <!-- åˆ†å¸³è¨­å®š (æ–°å¢) -->
        <div class="split-box">
            <div class="flex justify-between items-center mb-2">
                <label class="font-bold text-gray-700 text-sm">åˆ†å¸³æ–¹å¼</label>
                <select id="in-ex-split-method" onchange="renderSplitOptions()" class="text-xs border p-1 rounded bg-white">
                    <option value="equal" ${splitMethod==='equal'?'selected':''}>æŒ‰äººé ­å‡åˆ†</option>
                    <option value="amount" ${splitMethod==='amount'?'selected':''}>æŒ‡å®šé‡‘é¡</option>
                    <option value="none" ${splitMethod==='none'?'selected':''}>ä¸åˆ†å¸³(å€‹äºº)</option>
                </select>
            </div>
            <div id="split-options-container" class="grid grid-cols-2 gap-2">
                <!-- å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>

        <!-- ç¸½é‡‘é¡é¡¯ç¤º -->
        <div class="bg-orange-50 p-3 rounded-xl text-center border border-orange-100 mt-2">
            <div class="text-sm text-gray-500 mb-1">ç¸½é‡‘é¡</div>
            <div class="text-2xl font-bold text-orange-600"><span id="lbl-currency">${data.currency==='TWD'?'$':'Â¥'}</span><span id="calc-total">0</span></div>
            <div id="calc-convert-hint" class="text-xs font-bold text-blue-500 mt-1 ${data.currency==='TWD'?'hidden':''}">â‰ˆ NT$<span id="calc-twd">0</span></div>
        </div>

        <button onclick="saveExpense()" class="w-full bg-orange-500 text-white font-bold py-3 rounded-xl shadow-lg mt-4">
            ${key ? 'æ›´æ–°ç´€éŒ„' : 'å„²å­˜ç´€éŒ„'}
        </button>
    `;

    openModal('modal-budget');
    
    // åˆå§‹åŒ–åˆ†å¸³é¸é … UI
    renderSplitOptions(data.splitDetails);
    
    // ç¶å®šè‡ªå‹•è¨ˆç®—äº‹ä»¶
    document.getElementById('in-ex-price').addEventListener('input', updateCalc);
    document.getElementById('in-ex-qty').addEventListener('input', updateCalc);
    document.getElementById('in-ex-currency').addEventListener('change', (e) => {
        document.getElementById('lbl-currency').innerText = e.target.value === 'TWD' ? '$' : 'Â¥';
        document.getElementById('calc-convert-hint').classList.toggle('hidden', e.target.value === 'TWD');
        updateCalc();
    });
    
    // åˆæ¬¡è¨ˆç®—
    updateCalc();
}

// --- æ¸²æŸ“åˆ†å¸³é¸é … UI ---
function renderSplitOptions(savedDetails = null) {
    const method = document.getElementById('in-ex-split-method').value;
    const container = document.getElementById('split-options-container');
    const totalAmount = (parseInt(document.getElementById('in-ex-price').value) || 0) * (parseInt(document.getElementById('in-ex-qty').value) || 1);
    
    let html = '';
    
    if (method === 'equal') {
        // å‡åˆ†æ¨¡å¼ï¼šé¡¯ç¤º Checkbox
        FAMILY_MEMBERS.forEach(m => {
            // å¦‚æœæœ‰å­˜æª”ï¼Œæª¢æŸ¥æ˜¯å¦åœ¨åå–®å…§ï¼›è‹¥ç„¡å­˜æª”ï¼Œé è¨­å…¨é¸
            const isChecked = savedDetails ? savedDetails.some(d => d.name === m.name) : true;
            html += `
                <div class="member-check ${isChecked ? 'active' : ''}" onclick="this.classList.toggle('active'); this.querySelector('input').checked = !this.querySelector('input').checked;">
                    <input type="checkbox" value="${m.name}" class="hidden" ${isChecked ? 'checked' : ''}>
                    <i class="fa-solid ${isChecked ? 'fa-circle-check' : 'fa-circle'} text-xs"></i> ${m.name}
                </div>`;
        });
    } else if (method === 'amount') {
        // é‡‘é¡æ¨¡å¼ï¼šé¡¯ç¤ºè¼¸å…¥æ¡†
        FAMILY_MEMBERS.forEach(m => {
            const savedVal = savedDetails ? (savedDetails.find(d => d.name === m.name)?.amount || 0) : 0;
            html += `
                <div class="flex items-center gap-2 bg-white p-2 rounded border">
                    <span class="text-xs font-bold w-8">${m.name}</span>
                    <input type="number" data-name="${m.name}" value="${savedVal}" placeholder="é‡‘é¡" class="split-amount-input w-full text-sm border-b outline-none text-right">
                </div>`;
        });
    } else {
        html = `<div class="col-span-2 text-xs text-gray-400 text-center py-2">è²»ç”¨å°‡å…¨é¡æ­¸æ–¼ä»˜æ¬¾äºº</div>`;
    }
    
    container.innerHTML = html;
}

// --- è‡ªå‹•è¨ˆç®—ç¸½é¡ ---
function updateCalc() {
    const p = parseInt(document.getElementById('in-ex-price').value) || 0;
    const q = parseInt(document.getElementById('in-ex-qty').value) || 1;
    const total = p * q;
    
    document.getElementById('calc-total').innerText = total.toLocaleString();
    
    const isTwd = document.getElementById('in-ex-currency').value === 'TWD';
    if (!isTwd) {
        document.getElementById('calc-twd').innerText = Math.round(total * JPY_RATE).toLocaleString();
    }
}

// --- å„²å­˜/æ›´æ–°æ”¯å‡º (æ ¸å¿ƒé‚è¼¯) ---
function saveExpense() {
    const key = document.getElementById('in-ex-key').value;
    const category = document.getElementById('in-ex-category').value;
    const payer = document.getElementById('in-ex-payer').value;
    const store = document.getElementById('in-ex-store').value;
    const item = document.getElementById('in-ex-item').value;
    const price = parseInt(document.getElementById('in-ex-price').value);
    const qty = parseInt(document.getElementById('in-ex-qty').value);
    const currency = document.getElementById('in-ex-currency').value;
    const payment = document.getElementById('in-ex-pay').value;
    const fullTime = document.getElementById('in-ex-time').value;
    const receiptUrl = document.getElementById('in-ex-receipt').value;
    const splitMethod = document.getElementById('in-ex-split-method').value;

    if(!item || isNaN(price)) return alert("è«‹è¼¸å…¥æ­£ç¢ºçš„å“åå’Œé‡‘é¡");

    const totalAmount = price * qty;
    let splitDetails = [];

    // è¨ˆç®—åˆ†å¸³ç´°ç¯€
    if (splitMethod === 'equal') {
        const checks = document.querySelectorAll('#split-options-container input[type="checkbox"]:checked');
        if (checks.length > 0) {
            const perPerson = Math.round(totalAmount / checks.length); // ç°¡å–®å››æ¨äº”å…¥ï¼Œèª¤å·®ä¸è¨ˆ
            checks.forEach(chk => {
                splitDetails.push({ name: chk.value, amount: perPerson });
            });
        } else {
            // å¦‚æœæ²’å‹¾é¸äººï¼Œé è¨­æ­¸ä»˜æ¬¾äºº
            splitDetails.push({ name: payer, amount: totalAmount });
        }
    } else if (splitMethod === 'amount') {
        const inputs = document.querySelectorAll('.split-amount-input');
        let currentTotal = 0;
        inputs.forEach(inp => {
            const val = parseInt(inp.value) || 0;
            if (val > 0) {
                splitDetails.push({ name: inp.dataset.name, amount: val });
                currentTotal += val;
            }
        });
        // é©—è­‰é‡‘é¡æ˜¯å¦å»åˆ (å¯é¸ï¼šé€™è£¡å…ˆä¸å¼·åˆ¶å¡æ­»ï¼Œå½ˆæ€§ä¸€é»)
        if (currentTotal !== totalAmount) {
           if(!confirm(`åˆ†å¸³ç¸½é¡ (${currentTotal}) èˆ‡ ç¸½æ”¯å‡º (${totalAmount}) ä¸ç¬¦ï¼Œç¢ºå®šè¦å„²å­˜å—ï¼Ÿ`)) return;
        }
    } else {
        // ä¸åˆ†å¸³ (å€‹äºº)
        splitDetails.push({ name: payer, amount: totalAmount });
    }

    const expenseData = {
        category, store, item, payer, currency, payment, receiptUrl, splitMethod, splitDetails,
        priceJp: price, // ä¿å­˜å–®åƒ¹
        qty,
        amount: totalAmount, // ä¿å­˜ç¸½åƒ¹
        date: fullTime.split('T')[0].replace(/-/g, '/'),
        fullTime,
        timestamp: Date.now() // æ’åºç”¨
    };

    if(db) {
        if(key) {
            db.ref('expenses/' + key).update(expenseData);
        } else {
            db.ref('expenses').push(expenseData);
        }
    } else {
        const localData = JSON.parse(localStorage.getItem(EXPENSE_KEY)) || [];
        if(key) {
            const index = parseInt(key.split('_')[1]);
            localData[index] = expenseData;
        } else {
            localData.push(expenseData);
        }
        localStorage.setItem(EXPENSE_KEY, JSON.stringify(localData));
        renderBudget();
    }
    
    closeModal('modal-budget');
}
        
        function addExpense() { 
            const category = document.getElementById('in-ex-category').value; const store = document.getElementById('in-ex-store').value; const item = document.getElementById('in-ex-item').value; const price = document.getElementById('in-ex-price').value; const qty = document.getElementById('in-ex-qty').value; const payment = document.getElementById('in-ex-pay').value; const timeValue = document.getElementById('in-ex-time').value;
            if(!item || !price) return alert("è«‹è¼¸å…¥å“åå’Œåƒ¹æ ¼"); 
            const totalAmount = parseInt(price) * parseInt(qty); 
            const expenseData = { category, store, item, priceJp: price, qty, payment, amount: totalAmount, date: new Date().toLocaleDateString(), fullTime: timeValue, timestamp: Date.now() };
            if(db) { db.ref('expenses').push(expenseData); } else { const localData = JSON.parse(localStorage.getItem(EXPENSE_KEY)) || []; localData.push(expenseData); localStorage.setItem(EXPENSE_KEY, JSON.stringify(localData)); renderBudget(); }
            closeModal('modal-budget'); document.getElementById('in-ex-store').value = ''; document.getElementById('in-ex-item').value = ''; document.getElementById('in-ex-price').value = ''; document.getElementById('in-ex-qty').value = '1'; 
        }

        function adjustQty(delta) { const input = document.getElementById('in-ex-qty'); let val = parseInt(input.value) || 1; val += delta; if(val < 1) val = 1; input.value = val; input.dispatchEvent(new Event('input')); }
        
        function deleteExpense(key) { 
            if(confirm("åˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ")) { 
                if(db) { db.ref('expenses/' + key).remove(); } 
                else { 
                    const index = parseInt(key.split('_')[1]); 
                    const localData = JSON.parse(localStorage.getItem(EXPENSE_KEY)) || []; 
                    localData.splice(index, 1); 
                    localStorage.setItem(EXPENSE_KEY, JSON.stringify(localData)); 
                    renderBudget(); 
                } 
            } 
        }

        function getPackingList() { const stored = localStorage.getItem(PACKING_KEY); if (!stored) { localStorage.setItem(PACKING_KEY, JSON.stringify(defaultPackingList)); return defaultPackingList; } return JSON.parse(stored); }
        function togglePacking(id) { 
            const list = getPackingList(); 
            const item = list.find(i => i.id === id); 
            if(item) { 
                item.done = !item.done; 
                localStorage.setItem(PACKING_KEY, JSON.stringify(list)); 
                if(currentTab === 'home') renderHome();
                if(currentTab === 'vouchers') renderVouchers();
            } 
        }
        function switchTab(tab) { currentTab = tab; document.querySelectorAll('.nav-item').forEach(btn => { btn.classList.remove('active', 'text-orange-500'); btn.classList.add('text-gray-400'); }); if (tab !== 'home') document.getElementById(`btn-${tab}`).classList.replace('text-gray-400', 'text-orange-500'); if (tab === 'home') renderHome(); if (tab === 'schedule') renderSchedule(); if (tab === 'shopping') renderShopping(); if (tab === 'budget') renderBudget(); if (tab === 'vouchers') renderVouchers(); window.scrollTo(0, 0); }
        function changeDate(index) { selectedDateIndex = index; renderSchedule(); }
        function toggleCard(element) { const details = element.querySelector('.details-content'); if(details) { details.style.display = details.style.display==='block'?'none':'block'; element.classList.toggle('card-active'); } }
        function copyText(text, e) { if(e) e.stopPropagation(); navigator.clipboard.writeText(text).then(() => alert("å·²è¤‡è£½")); }
        function toggleDevMode() { currentSimulatedDate = currentSimulatedDate ? null : "2025/12/26"; alert(currentSimulatedDate ? "æ¨¡æ“¬: 12/26" : "å›åˆ°ç¾åœ¨"); renderHome(); }
        function openTranslation() { document.getElementById('trans-modal').classList.remove('hidden'); document.getElementById('trans-modal').classList.add('flex'); }
        function closeTranslation() { document.getElementById('trans-modal').classList.add('hidden'); document.getElementById('trans-modal').classList.remove('flex'); }
        function openModal(id) { document.getElementById(id).classList.add('open'); }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }
        function openPdfModal(encodedContent) { const content = decodeURIComponent(encodedContent); const modal = document.getElementById('modal-pdf'); const body = document.getElementById('pdf-content'); let html = `<div class="pdf-header border-b-2 border-gray-800 pb-2 mb-4 flex justify-between items-end"><h2 class="text-xl font-bold text-gray-800">BOOKING CONFIRMATION</h2><div class="text-right text-xs text-gray-500">2025/11/27</div></div>`; content.split('\n').forEach(line => { if(line.includes('ï¼š')) { const [key, val] = line.split('ï¼š'); html += `<div class="mb-2"><div class="text-[10px] text-gray-500 uppercase">${key}</div><div class="font-bold text-gray-900">${val}</div></div>`; } else if(line.trim() === '') html += `<div class="h-4"></div>`; else html += `<div class="text-sm text-gray-700 mb-1">${line}</div>`; }); body.innerHTML = html; modal.classList.add('open'); }
        function closePdfModal() { document.getElementById('modal-pdf').classList.remove('open'); }
        function openVoucherImage(imgSrc) { const modal = document.getElementById('modal-pdf'); const body = document.getElementById('pdf-content'); const finalSrc = imgSrc.startsWith('http') ? imgSrc : `./${imgSrc}`; body.innerHTML = `<div class="flex flex-col items-center justify-center h-full"><img src="${finalSrc}" class="max-w-full max-h-full object-contain rounded-lg shadow-lg"><p class="text-xs text-gray-400 mt-4">å¯ä½¿ç”¨é›™æŒ‡ç¸®æ”¾æŸ¥çœ‹</p></div>`; modal.classList.add('open'); }
        function openDetailModal(dayIdx, eventIdx, choiceIdx = null) { const modal = document.getElementById('modal-detail'); const content = document.getElementById('modal-detail-content'); let event = tripData[dayIdx].events[eventIdx]; if (choiceIdx !== null && event.choices) event = event.choices[choiceIdx]; const img = event.imgUrl || 'https://via.placeholder.com/400x250?text=No+Image'; const detail = event.detailInfo || {}; let tagsHtml = ''; if(detail.tags) detail.tags.forEach(t => tagsHtml += `<span class="bg-orange-100 text-orange-600 text-xs px-2 py-1 rounded-full mr-1">#${t}</span>`); let highlightHtml = ''; if(detail.highlights) highlightHtml = `<div class="mt-4"><h4 class="font-bold text-gray-800 mb-2">âœ¨ å¿…çœ‹äº®é»</h4><ul class="list-disc list-inside text-sm text-gray-600 space-y-1">${detail.highlights.map(h => `<li>${h}</li>`).join('')}</ul></div>`; if(detail.menu) highlightHtml = `<div class="mt-4"><h4 class="font-bold text-gray-800 mb-2">ğŸ‘©â€ğŸ³ æ¨è–¦èœå–®</h4><div class="grid grid-cols-1 gap-2">${detail.menu.map(m => `<div class="flex justify-between items-center bg-gray-50 p-2 rounded"><span class="font-bold text-gray-700 text-sm">${m.n}</span><span class="text-orange-500 text-sm font-bold">${m.p || ''}</span></div>`).join('')}</div></div>`; content.innerHTML = `<div class="detail-handle" onclick="closeDetailModal()"></div><button class="detail-close-btn" onclick="closeDetailModal()"><i class="fa-solid fa-xmark"></i></button><img src="${img}" class="detail-header-img"><div class="detail-body"><div class="flex items-center gap-2 mb-1"><span class="text-sm text-gray-400">${event.time || 'è©³ç´°è³‡è¨Š'}</span>${tagsHtml}</div><h2 class="text-2xl font-bold text-gray-800 mb-3">${event.title}</h2><p class="text-gray-600 text-sm leading-relaxed">${detail.desc || event.guide || 'æš«ç„¡è©³ç´°ä»‹ç´¹'}</p>${highlightHtml}<div class="mt-6 flex gap-3"><a href="${event.link || `https://www.google.com/maps/search/?api=1&query=${event.title}+æ²–ç¹©`}" target="_blank" class="flex-1 bg-blue-600 text-white py-3 rounded-xl text-center font-bold shadow-lg active:scale-95 transition"><i class="fa-solid fa-location-arrow mr-1"></i> å°èˆª</a>${event.mapCode ? `<button onclick="copyText('${event.mapCode}')" class="flex-1 bg-gray-100 text-gray-700 py-3 rounded-xl font-bold border border-gray-200 active:scale-95 transition">è¤‡è£½ MapCode</button>` : ''}</div></div>`; modal.classList.add('open'); }
        function closeDetailModal() { document.getElementById('modal-detail').classList.remove('open'); }
        async function updateWeatherUI() {
            const container = document.getElementById('weather-scroll'); const sunsetEl = document.getElementById('sunset-time'); if(!container) return;
            try {
                const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=26.2124&longitude=127.6809&current=temperature_2m,weather_code&hourly=temperature_2m,weather_code&daily=sunset&timezone=Asia%2FTokyo');
                const data = await res.json();
                const sunset = new Date(data.daily.sunset[0]);
                if(sunsetEl) sunsetEl.innerHTML = `<i class="fa-solid fa-cloud-sun"></i> æ—¥è½ ${sunset.getHours()}:${String(sunset.getMinutes()).padStart(2,'0')}`;
                const currentHour = new Date().getHours(); const startIndex = data.hourly.time.findIndex(t => new Date(t).getHours() === currentHour);
                let html = '';
                for(let i=startIndex; i<startIndex+12; i++) { 
                    if(!data.hourly.time[i]) break;
                    const time = new Date(data.hourly.time[i]).getHours() + ":00";
                    const temp = Math.round(data.hourly.temperature_2m[i]);
                    const code = data.hourly.weather_code[i];
                    let icon = 'â˜€ï¸';
                    if(code >= 1 && code <= 3) icon = 'â˜ï¸'; else if(code >= 45) icon = 'ğŸŒ«ï¸'; else if(code >= 51) icon = 'ğŸŒ§ï¸'; else if(code >= 95) icon = 'â›ˆï¸';
                    html += `<div class="flex flex-col items-center min-w-[50px]"><span class="text-xs text-gray-400">${time}</span><span class="text-xl my-1">${icon}</span><span class="text-sm font-bold text-gray-700">${temp}Â°</span></div>`;
                }
                container.innerHTML = html;
            } catch(e) { container.innerHTML = '<span class="text-xs text-red-400">å¤©æ°£è¼‰å…¥å¤±æ•—</span>'; }
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
